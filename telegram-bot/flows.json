[
    {
        "id": "93cb4937.6fc068",
        "type": "tab",
        "label": "Flow Inicial",
        "disabled": false,
        "info": ""
    },
    {
        "id": "c1e7ebde.3e0b68",
        "type": "tab",
        "label": "NASA Notifications",
        "disabled": false,
        "info": ""
    },
    {
        "id": "128790f6.dee0df",
        "type": "tab",
        "label": "News",
        "disabled": false,
        "info": ""
    },
    {
        "id": "5501c3cc.11327c",
        "type": "tab",
        "label": "Sandbox",
        "disabled": false,
        "info": ""
    },
    {
        "id": "c644db46.3854c8",
        "type": "subflow",
        "name": "new fire",
        "info": "Input: A msg for geocode or a  message type location with:\nmsg.location.lon and msg.location.lon",
        "in": [
            {
                "x": 40,
                "y": 120,
                "wires": [
                    {
                        "id": "730cf241.49734c"
                    }
                ]
            }
        ],
        "out": []
    },
    {
        "id": "c6a40c11.dfc6b",
        "type": "subflow",
        "name": "volver",
        "info": "",
        "in": [
            {
                "x": 80,
                "y": 120,
                "wires": [
                    {
                        "id": "b0495fbe.5ecca"
                    }
                ]
            }
        ],
        "out": []
    },
    {
        "id": "156e20df.86399f",
        "type": "subflow",
        "name": "send location",
        "info": "Env√≠a la localizaci√≥n al telegram",
        "in": [
            {
                "x": 140,
                "y": 160,
                "wires": [
                    {
                        "id": "a95a87ec.d0c648"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 680,
                "y": 160,
                "wires": [
                    {
                        "id": "748b9d33.3e7354",
                        "port": 0
                    }
                ]
            }
        ],
        "inputLabels": [
            "location.lat & lon"
        ]
    },
    {
        "id": "9968fcc5.ed33c",
        "type": "subflow",
        "name": "menu distancia",
        "info": "",
        "in": [
            {
                "x": 100,
                "y": 120,
                "wires": [
                    {
                        "id": "4a109a88.7389a4"
                    }
                ]
            }
        ],
        "out": []
    },
    {
        "id": "76bd701f.29d0f",
        "type": "subflow",
        "name": "start",
        "info": "",
        "in": [
            {
                "x": 40,
                "y": 160,
                "wires": [
                    {
                        "id": "da7e1a7c.19d3c8"
                    }
                ]
            }
        ],
        "out": []
    },
    {
        "id": "465e67f.6ebf598",
        "type": "subflow",
        "name": "start with delay",
        "info": "",
        "in": [
            {
                "x": 60,
                "y": 40,
                "wires": [
                    {
                        "id": "e864b674.6fd2c8"
                    }
                ]
            }
        ],
        "out": []
    },
    {
        "id": "2b8628df.fdcca8",
        "type": "subflow",
        "name": "send notifications",
        "info": "",
        "in": [
            {
                "x": 60,
                "y": 240,
                "wires": [
                    {
                        "id": "d76ddf98.d3de9"
                    }
                ]
            }
        ],
        "out": []
    },
    {
        "id": "4a3c7cc0.965dd4",
        "type": "subflow",
        "name": "to map",
        "info": "",
        "in": [
            {
                "x": 180,
                "y": 220,
                "wires": [
                    {
                        "id": "cf23a5a.9eacd58"
                    }
                ]
            }
        ],
        "out": []
    },
    {
        "id": "d29a1c6a.5a89e",
        "type": "subflow",
        "name": "neighbour to map",
        "info": "",
        "in": [
            {
                "x": 60,
                "y": 100,
                "wires": [
                    {
                        "id": "6187e791.e5f488"
                    }
                ]
            }
        ],
        "out": []
    },
    {
        "id": "91777bb3.922328",
        "type": "subflow",
        "name": "OnMapConnected",
        "info": "",
        "in": [
            {
                "x": 160,
                "y": 40,
                "wires": []
            }
        ],
        "out": [
            {
                "x": 680,
                "y": 40,
                "wires": [
                    {
                        "id": "620ec824.128428",
                        "port": 0
                    },
                    {
                        "id": "91777bb3.922328",
                        "port": 0
                    }
                ]
            }
        ],
        "inputLabels": [
            "forwards in to out"
        ],
        "outputLabels": [
            "out + on map connected"
        ]
    },
    {
        "id": "2f0217a5.051978",
        "type": "subflow",
        "name": "false positive",
        "info": "",
        "in": [
            {
                "x": 40,
                "y": 160,
                "wires": [
                    {
                        "id": "17c09c20.9d4a84"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1360,
                "y": 400,
                "wires": [
                    {
                        "id": "7f8ce0c9.99ac4",
                        "port": 0
                    },
                    {
                        "id": "eab4c7fe.fd7828",
                        "port": 0
                    },
                    {
                        "id": "364970ea.3f564",
                        "port": 0
                    },
                    {
                        "id": "2b5fa53f.8b255a",
                        "port": 0
                    }
                ]
            }
        ]
    },
    {
        "id": "e81a68fa.695e38",
        "type": "subflow",
        "name": "tsend",
        "info": "",
        "in": [
            {
                "x": 60,
                "y": 40,
                "wires": [
                    {
                        "id": "f3418b4a.16c128"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 680,
                "y": 40,
                "wires": [
                    {
                        "id": "dd683e99.7c126",
                        "port": 0
                    }
                ]
            }
        ]
    },
    {
        "id": "4384af8e.a7409",
        "type": "subflow",
        "name": "lang",
        "info": "",
        "in": [
            {
                "x": 20,
                "y": 100,
                "wires": [
                    {
                        "id": "83d02c40.cf2b6"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 2140,
                "y": 240,
                "wires": [
                    {
                        "id": "1586a4b5.782b9b",
                        "port": 0
                    }
                ]
            }
        ]
    },
    {
        "id": "e6f3db8c.48eac8",
        "type": "subflow",
        "name": "ask lang",
        "info": "",
        "in": [
            {
                "x": 100,
                "y": 100,
                "wires": [
                    {
                        "id": "4091f971.ce23f8"
                    }
                ]
            }
        ],
        "out": []
    },
    {
        "id": "6995c6a.1a0bf38",
        "type": "subflow",
        "name": "set i18n",
        "info": "",
        "in": [
            {
                "x": 100,
                "y": 60,
                "wires": [
                    {
                        "id": "5541b1d7.23da4"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 580,
                "y": 60,
                "wires": [
                    {
                        "id": "5541b1d7.23da4",
                        "port": 0
                    }
                ]
            }
        ]
    },
    {
        "id": "1bbd6687.58eae9",
        "type": "subflow",
        "name": "validate geo",
        "info": "",
        "in": [
            {
                "x": 120,
                "y": 80,
                "wires": [
                    {
                        "id": "c60831ef.7bc3a"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 420,
                "y": 80,
                "wires": [
                    {
                        "id": "c60831ef.7bc3a",
                        "port": 0
                    }
                ]
            }
        ]
    },
    {
        "id": "557e0255.d1220c",
        "type": "subflow",
        "name": "test in",
        "info": "",
        "in": [],
        "out": [
            {
                "x": 680,
                "y": 60,
                "wires": [
                    {
                        "id": "95b8009f.b410c",
                        "port": 0
                    }
                ]
            },
            {
                "x": 680,
                "y": 120,
                "wires": [
                    {
                        "id": "95b8009f.b410c",
                        "port": 1
                    }
                ]
            },
            {
                "x": 680,
                "y": 180,
                "wires": [
                    {
                        "id": "95b8009f.b410c",
                        "port": 2
                    }
                ]
            }
        ],
        "outputLabels": [
            "/start",
            "/lang",
            "location, other"
        ]
    },
    {
        "id": "fe0c8b72.8a51a8",
        "type": "subflow",
        "name": "test out",
        "info": "",
        "in": [
            {
                "x": 80,
                "y": 60,
                "wires": [
                    {
                        "id": "dadeaa31.8d2c18"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 420,
                "y": 60,
                "wires": [
                    {
                        "id": "dadeaa31.8d2c18",
                        "port": 0
                    }
                ]
            }
        ]
    },
    {
        "id": "11cb3f4d.6e0081",
        "type": "subflow",
        "name": "find new active fires",
        "info": "",
        "in": [
            {
                "x": 60,
                "y": 140,
                "wires": [
                    {
                        "id": "9ef9c4c5.a68d08"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1360,
                "y": 200,
                "wires": [
                    {
                        "id": "e548f509.8b1958",
                        "port": 0
                    }
                ]
            },
            {
                "x": 1360,
                "y": 140,
                "wires": [
                    {
                        "id": "e548f509.8b1958",
                        "port": 0
                    }
                ]
            }
        ]
    },
    {
        "id": "c8522537.c6f908",
        "type": "subflow",
        "name": "count new fire actives",
        "info": "",
        "in": [
            {
                "x": 60,
                "y": 40,
                "wires": [
                    {
                        "id": "8d910d3f.7ff39"
                    }
                ]
            }
        ],
        "out": []
    },
    {
        "id": "3f0768a7.1fac78",
        "type": "subflow",
        "name": "count active fires",
        "info": "",
        "in": [
            {
                "x": 60,
                "y": 60,
                "wires": [
                    {
                        "id": "d8b00aa6.5027f8"
                    }
                ]
            }
        ],
        "out": []
    },
    {
        "id": "95e78a8b.50a428",
        "type": "subflow",
        "name": "send noti to user",
        "info": "",
        "in": [
            {
                "x": 60,
                "y": 100,
                "wires": [
                    {
                        "id": "ca5f1316.5932c"
                    }
                ]
            }
        ],
        "out": []
    },
    {
        "id": "f93d1a38.c43218",
        "type": "telegram bot",
        "z": "",
        "botname": "fuegos_bot",
        "usernames": "",
        "chatids": ""
    },
    {
        "id": "9f205dc2.bd858",
        "type": "google-api-config",
        "z": ""
    },
    {
        "id": "51a7af07.93444",
        "type": "mongodb",
        "z": "",
        "hostname": "127.0.0.1",
        "port": "27017",
        "db": "fuegos",
        "name": ""
    },
    {
        "id": "60f55fe6.6c729",
        "type": "ui_base",
        "theme": {
            "name": "theme-dark",
            "lightTheme": {
                "default": "#0094CE",
                "baseColor": "#0094CE",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "darkTheme": {
                "default": "#097479",
                "baseColor": "#097479",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "customTheme": {
                "name": "Untitled Theme 1",
                "default": "#4B7930",
                "baseColor": "#4B7930",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
            },
            "themeState": {
                "base-color": {
                    "default": "#097479",
                    "value": "#097479",
                    "edited": false
                },
                "page-titlebar-backgroundColor": {
                    "value": "#097479",
                    "edited": false
                },
                "page-backgroundColor": {
                    "value": "#111111",
                    "edited": false
                },
                "page-sidebar-backgroundColor": {
                    "value": "#000000",
                    "edited": false
                },
                "group-textColor": {
                    "value": "#0eb8c0",
                    "edited": false
                },
                "group-borderColor": {
                    "value": "#555555",
                    "edited": false
                },
                "group-backgroundColor": {
                    "value": "#333333",
                    "edited": false
                },
                "widget-textColor": {
                    "value": "#eeeeee",
                    "edited": false
                },
                "widget-backgroundColor": {
                    "value": "#097479",
                    "edited": false
                },
                "widget-borderColor": {
                    "value": "#333333",
                    "edited": false
                },
                "base-font": {
                    "value": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
                }
            }
        },
        "site": {
            "name": "Tod@s contra el Fuego",
            "hideToolbar": "false",
            "allowSwipe": "false",
            "dateFormat": "DD/MM/YYYY",
            "sizes": {
                "sx": 48,
                "sy": 48,
                "gx": 6,
                "gy": 6,
                "cx": 6,
                "cy": 6,
                "px": 0,
                "py": 0
            }
        }
    },
    {
        "id": "dac4dde2.62c72",
        "type": "ui_tab",
        "z": "",
        "name": "Stats",
        "icon": "dashboard",
        "order": 1
    },
    {
        "id": "601660c.cd104a",
        "type": "ui_group",
        "z": "",
        "name": "Estad√≠sticas",
        "tab": "dac4dde2.62c72",
        "disp": true,
        "width": "6"
    },
    {
        "id": "103d89d5.f04ab6",
        "type": "persist-store",
        "z": "",
        "filename": "dayly-file-alerts.json",
        "interval": "60"
    },
    {
        "id": "2c23f46.8edd30c",
        "type": "persist-store",
        "z": "",
        "filename": "nasa-fire-active.json",
        "interval": "60"
    },
    {
        "id": "db913a18.f8bf88",
        "type": "persist-store",
        "z": "2b8628df.fdcca8",
        "filename": "near-neighbours.json",
        "interval": "60"
    },
    {
        "id": "cb34ee3.be2b31",
        "type": "persist-store",
        "z": "",
        "filename": "suscriptions-in-time.json",
        "interval": "60"
    },
    {
        "id": "488013b6.1183ec",
        "type": "Cache",
        "z": "",
        "name": "userslang",
        "defaultTtl": "120",
        "checkPeriod": "100"
    },
    {
        "id": "ce56e26a.71d74",
        "type": "semaphore-config",
        "z": "",
        "name": "notif",
        "capacity": "1"
    },
    {
        "id": "9a28d188.bb94e",
        "type": "persist-store",
        "z": "c8522537.c6f908",
        "filename": "nasa-new-fire-actives.json",
        "interval": "60"
    },
    {
        "id": "d5287e69.2b449",
        "type": "mongodb2",
        "z": "11cb3f4d.6e0081",
        "uri": "mongodb://127.0.0.1:27017/fuegos",
        "name": "fires",
        "options": "{\"poolSize\": 10}",
        "parallelism": "-1"
    },
    {
        "id": "d5559ee5.960e2",
        "type": "mongodb2",
        "z": "",
        "uri": "mongodb://127.0.0.1:27017/fuegos",
        "name": "fires",
        "options": "{\"poolSize\": 10}",
        "parallelism": "-1"
    },
    {
        "id": "bdb6d01f.a399d",
        "type": "telegram command",
        "z": "93cb4937.6fc068",
        "name": "/start",
        "command": "/start",
        "bot": "f93d1a38.c43218",
        "x": 90,
        "y": 360,
        "wires": [
            [
                "55ebd8f8.436e38",
                "17af36df.d20ff9"
            ],
            [
                "11e83fb2.09a37",
                "17af36df.d20ff9"
            ]
        ]
    },
    {
        "id": "33879e8b.3151b2",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "other replies",
        "func": "var t = msg.i18n;\n\n//if(context.global.keyboard && context.global.keyboard.pending)\n//{\n//    context.global.keyboard.pending = false;\n    if(msg.payload.content === t('Desuscribirme'))\n    {\n        msg.payload.content = t('üëç Desuscrito');\n        return [msg, null];   \n    }\n    else if(msg.payload.content === t('‚ô• Apoya esta iniciativa'))\n    {\n        msg.payload.content =  t('¬øSab√≠as que los fuegos producen tanto CO¬≤ como los coches y aproximadamente ‚Öï de todas nuestras emisiones?') + '\\r\\n\\r\\n'\n        msg.payload.content += t('Puedes ayudarnos (y al medioambiente) dando difusi√≥n a @TodosContraElFuego_bot entre tus contactos y grupos para que m√°s gente lo use.') + '\\r\\n\\r\\n';\n        msg.payload.content += t('Tambi√©n puedes apoyarnos con alguna donaci√≥n. As√≠ podremos pagar nuestros servidores, servicios de terceros, usar otras plataformas diferentes de Telegram y pagar alg√∫n caf√© a los desarrolladores:');\n        msg.payload.content += '\\r\\n‚û°Ô∏è https://comunes.org/donate\\r\\n\\r\\n';\n\n        return [msg, null];\n\n    }\n    else if(msg.payload.content === t('üìñ M√°s info'))\n    {   msg.payload.content =  t('¬© Copyleft Asociaci√≥n Comunes bajo licencia AGPLv3') + '\\r\\n';\n        msg.payload.content += \"https://comunes.org\\r\\n\";\n        msg.payload.content += t('C√≥digo:') + 'https://github.com/comunes/todos-contra-el-fuego\\r\\n\\r\\n';\n        \n        msg.payload.content += t('LIMITACI√ìN DE LA RESPONSABILIDAD:') + '\\r\\n\\r\\n'; \n        \n        msg.payload.content += t('EN NING√öN CASO A MENOS QUE SEA REQUERIDO POR UNA LEY APLICABLE O ACUERDO ESCRITO NING√öN TITULAR DE LOS DERECHOS DE AUTOR (‚ÄúCOPYRIGHT‚Äù), O NING√öN TERCERO QUE MODIFIQUE Y/O TRANSMITA EL PROGRAMA COMO SE PERMITE ANTERIORMENTE, SER√Å RESPONSABLE ANTE USTED POR DA√ëOS, INCLUYENDO CUALESQUIERA DA√ëOS GENERALES, PARTICULARES, IMPREVISTOS O DERIVADOS DEL USO O IMPOSIBILIDAD DE USO DEL PROGRAMA (INCLUYENDO, PERO NO LIMITADO A, LA P√âRDIDA DE DATOS, DATOS GENERADOS INCORRECTOS, P√âRDIDAS SUFRIDAS POR USTED O POR TERCERAS PERSONAS, O LOS FALLOS DEL PROGRAMA PARA OPERAR CON OTROS PROGRAMAS), INCLUSO SI DICHO TITULAR O UN TERCERO HA SIDO ADVERTIDO DE LA POSIBILIDAD DE TALES DA√ëOS.') + '\\r\\n\\r\\n';\n        \n        msg.payload.content += t('POL√çTICA DE PRIVACIDAD:') + '\\r\\n\\r\\n';\n        msg.payload.content += t('No compartimos ninguna informaci√≥n con terceros. La informaci√≥n recogida por esta aplicaci√≥n tiene el √∫nico fin ayudar en la prevenci√≥n y extinci√≥n de fuegos principalmente forestales.') + '\\r\\n\\r\\n';\n\n        msg.payload.content += t('FUENTES DE DATOS:') + '\\r\\n\\r\\n';\n        msg.payload.content += t('Adem√°s de las alertas proporcionadas por nuestros usuari@s, usamos datos de fuegos activos proporcionados por la NASA (programa MODIS y VIIRS). Ver mapa: http://effis.jrc.ec.europa.eu/static/effis_current_situation/public/index.html') + '\\r\\n';\n        msg.payload.content += \"¬´We acknowledge the use of data and imagery from LANCE FIRMS operated by the NASA/GSFC/Earth Science Data and Information System (ESDIS) with funding provided by NASA/HQ¬ª.\" + '\\r\\n';\n        msg.payload.content += t('Si quieres que a√±adamos otras fuentes de datos sobre fuegos, no dudes en contactar con nosotros: info@comunes.org') + '\\r\\n\\r\\n';\n        \n        msg.payload.content += t('PREGUNTAS FRECUENTES:') + '\\r\\n\\r\\n';\n        msg.payload.content += t('‚ûñ ¬øMe puedo suscribir a varias zonas?: Por ahora no directamente. Solo con un truco, a√±adiendo a @TodosContraElFuego_bot como miembro a un grupo y que ese grupo est√© subscrito a otra zona.') + '\\r\\n';\n        msg.payload.content += t('‚ûñ ¬øHay \"falsos positivos\"?: S√≠ los hay. Puedes recibir alguna notificaci√≥n de fuego por ej. de refiner√≠as o incineradoras. Puedes pulsar a la localizaci√≥n del falso positivo y responder con un mensaje que diga \"falso positivo\" o \"es una industria\" para que estos fuegos no sean notificados.') + '\\r\\n';\n        msg.payload.content += t('Nos puedes ayudar mucho proporcion√°ndonos otros feedbacks sobre la veracidad de las notificaciones de fuego, sobre el estado del fuego, etc. Siplemente responde a la localizaci√≥n de una notificaci√≥n de fuego (pulsando sobre ella y seleccionando \"Responder\") con alg√∫n comentario sobre ese fuego.') + '\\r\\n';\n        msg.payload.content += t('‚ûñ ¬øPuedo recibir notificaciones en una distancia diferente o mayor? S√≠, basta con estar subscrito y teclear, por ejemplo, \"a 17 km\" si quisieramos recibir notificaciones en un radio de 17 kil√≥metros (o mayor si queremos hacer pruebas).') + '\\r\\n';\n        msg.payload.content += t('‚ûñ ¬øNo voy a recibir demasiadas notificaciones?: En principio no deber√≠as, ya que agrupamos las notificaciones de las diferentes fuentes y solo avisamos una vez al d√≠a por fuego. Por ejemplo no repetimos notificaciones si alg√∫n vecino ya ha notificado un mismo fuego en la zona previamente.') + '\\r\\n\\r\\n';\n        \n        msg.payload.content += t('OTROS:') + '\\r\\n\\r\\n';\n        msg.payload.content += t('‚ûñ Por ahora solo procesamos datos de fuegos de la NASA en Europa, pero si nos lo ped√≠s podemos ampliar nuestro radio de acci√≥n.') + '\\r\\n';\n        msg.payload.content += t('‚ûñ Puedes a√±adir a @TodosContraElFuego_bot a un grupo como miembro y recibir notificaciones de cierta √°rea en ese grupo.') + '\\r\\n';\n        msg.payload.content += t('‚ûñ Puedes votar con alegr√≠a ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è nuestro bot en https://telegram.me/storebot?start=TodosContraElFuego_bot.') +  '\\r\\n\\r\\n';\n        \n        msg.payload.content += t('Feedback, sugerencias, bugs, etc: @vj_rj') + '\\r\\n\\r\\n';\n        \n        msg.payload.content += t(\"¬°Gracias!\");\n        return [msg, null];\n    }\n    else {\n        msg.payload.content = t('Opci√≥n de teclado desconocida');\n        return [null, msg];   \n    }\n//}\n",
        "outputs": "5",
        "noerr": 0,
        "x": 750,
        "y": 580,
        "wires": [
            [
                "90cc5a97.f73e08"
            ],
            [],
            [],
            [],
            []
        ]
    },
    {
        "id": "1b848c63.4e2bf4",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "escribir posici√≥n",
        "func": "var t = msg.i18n;\n/* if (context.global.keyboard & context.global.keyboard.pending) {\n    context.global.keyboard.pending = false; */\n    msg.payload.type = 'message';\n    msg.payload.content = t('Ind√≠canos la posici√≥n a vigilar (por ej. tu pueblo, una calle, etc). Si usas un m√≥vil tambi√©n puedes adjuntar una ubicaci√≥n pulsando el clip');\n    msg.payload.topic = \"sus\";\n    \n    var opts = {\n      reply_markup: JSON.stringify({\n        force_reply: true,\n      })\n    };\n    msg.payload.options = opts;\n    return msg;\n/* } */\n",
        "outputs": "1",
        "noerr": 0,
        "x": 730,
        "y": 480,
        "wires": [
            [
                "c89c411b.79f73"
            ]
        ]
    },
    {
        "id": "be0cbd6.2efaf4",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "ask location to sub",
        "func": "var t = msg.i18n;\nvar key = 'locationtopic-' + msg.payload.chatId;\nglobal.set(key, 'sus');\n\nif (msg.payload.chatId > 0) {\n    if (context.global.keyboard && context.global.keyboard.pending) {\n        context.global.keyboard.pending = false;\n        var opts = {\n            // reply_to_message_id: msg.payload.messageId,\n            \n            reply_markup: JSON.stringify({\n                force_reply: true,\n                keyboard: [ \n                    [{text: t('üìç Compartir mi posici√≥n'), request_location: true}, \n                     {text: t('üìù Escribir mi posici√≥n')}\n                    ],\n                    [{text: t('‚¨ÖÔ∏è Cancelar')}]\n                ], \n    \n                'resize_keyboard' : true, \n                'one_time_keyboard' : true\n            })\n        };\n        msg.payload.content = t('¬øQuieres compartir tu posici√≥n o escribir el nombre de la zona a vigilar (por ejemplo un pueblo, una direcci√≥n, etc)? Selecciona una de las opciones. Activa la informaci√≥n de tu ubicaci√≥n üìç en tu m√≥vil si quieres compartir tu ubicaci√≥n');\n        msg.payload.options = opts;\n    }\n    return [msg, null];\n} else {\n    return [null, msg];\n}",
        "outputs": "2",
        "noerr": 0,
        "x": 610,
        "y": 400,
        "wires": [
            [
                "98bfcdd0.736cf"
            ],
            [
                "f4470f67.a877d"
            ]
        ]
    },
    {
        "id": "189c6a9b.aab975",
        "type": "google geocoding",
        "z": "93cb4937.6fc068",
        "name": "Geo",
        "geocodeBy": "address",
        "address": "",
        "lat": "",
        "lon": "",
        "googleAPI": "9f205dc2.bd858",
        "bounds": "",
        "language": "",
        "region": "",
        "components": "",
        "x": 1630,
        "y": 480,
        "wires": [
            [
                "52271fef.7036",
                "daebf6ef.f07908"
            ]
        ]
    },
    {
        "id": "57988778.321178",
        "type": "telegram reply",
        "z": "93cb4937.6fc068",
        "name": "get reply",
        "bot": "f93d1a38.c43218",
        "x": 1180,
        "y": 480,
        "wires": [
            [
                "d35010eb.26fdd"
            ]
        ]
    },
    {
        "id": "22b64555.dd2e7a",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "ask fire",
        "func": "var t = msg.i18n;\nvar key = 'locationtopic-' + msg.payload.chatId;\nglobal.set(key, 'newfire');\nif (msg.payload.chatId > 0) {\n    // use of locationtopic instead\n    context.global.keyboard = { pending : true };\n    var opts = {\n        // reply_to_message_id: msg.payload.messageId,\n            \n        reply_markup: JSON.stringify({\n            force_reply: true,\n            keyboard: [ \n                [{text: t('üìç El fuego est√° en mi ubicaci√≥n'), request_location: true}, \n                 {text: t('üìù Escribir localizaci√≥n fuego')}\n                ],\n                [{text: t('‚¨ÖÔ∏è Cancelar')}]\n            ], \n            'resize_keyboard' : true, \n            'one_time_keyboard' : true\n        })\n    };\n\n    msg.payload.content = t('¬øQuieres compartir tu ubicaci√≥n o escribir la localizaci√≥n del fuego (por ejemplo un pueblo, una direcci√≥n, etc)? Selecciona una de las opciones. Activa la informaci√≥n de tu ubicaci√≥n üìç en tu m√≥vil si quieres compartir tu ubicaci√≥n');\n    msg.payload.options = opts;\n    \n    return [msg, null];\n} else {\n    return [null, msg];\n}\n",
        "outputs": "2",
        "noerr": 0,
        "x": 860,
        "y": 440,
        "wires": [
            [
                "574b0512.1f89ac"
            ],
            [
                "60ee8a37.032aa4"
            ]
        ]
    },
    {
        "id": "bed1aee.d1d745",
        "type": "mongodb out",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "save subs",
        "collection": "subscriptions",
        "payonly": false,
        "upsert": true,
        "multi": false,
        "operation": "update",
        "x": 1990,
        "y": 580,
        "wires": []
    },
    {
        "id": "10d562eb.b0de5d",
        "type": "mongodb out",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "update subs",
        "collection": "subscriptions",
        "payonly": false,
        "upsert": false,
        "multi": false,
        "operation": "update",
        "x": 810,
        "y": 640,
        "wires": []
    },
    {
        "id": "e0bc7e33.2a795",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "otherwise",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 580,
        "y": 960,
        "wires": []
    },
    {
        "id": "f26677b3.07e7f8",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "Subscrito!",
        "func": "var t = msg.i18n;\nvar newMsg = {\n    payload : {\n        content : t('üëç ¬°Suscrito/a!'),\n        type: \"message\",\n        chatId: msg.query.chatId\n    }\n}\n\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 810,
        "y": 700,
        "wires": [
            [
                "abe7d7fb.2c4708",
                "baa17b12.6767a8"
            ]
        ]
    },
    {
        "id": "e864b674.6fd2c8",
        "type": "delay",
        "z": "465e67f.6ebf598",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 200,
        "y": 40,
        "wires": [
            [
                "bf50334e.7ac3a"
            ]
        ]
    },
    {
        "id": "4f819d77.37fcc4",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "chatId",
        "active": false,
        "console": "false",
        "complete": "chatId",
        "x": 1970,
        "y": 440,
        "wires": []
    },
    {
        "id": "6a17cf63.4a125",
        "type": "mongodb out",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "remove subs",
        "collection": "subscriptions",
        "payonly": false,
        "upsert": true,
        "multi": true,
        "operation": "delete",
        "x": 770,
        "y": 520,
        "wires": []
    },
    {
        "id": "529f65ba.a3f03c",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "query chatId",
        "func": "msg.payload = {\"chatId\": msg.payload.chatId };\n// console.log(msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 590,
        "y": 520,
        "wires": [
            [
                "6a17cf63.4a125",
                "64500fb0.8e131"
            ]
        ]
    },
    {
        "id": "c93b29f2.6b85b8",
        "type": "inject",
        "z": "93cb4937.6fc068",
        "name": "delete subs",
        "topic": "",
        "payload": "test",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 130,
        "y": 720,
        "wires": [
            [
                "32df6da4.7b9782"
            ]
        ]
    },
    {
        "id": "32df6da4.7b9782",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "test id",
        "func": "var newMsg = {\n    payload: {\n        chatId: 9998999,\n        content : \"Plaza de la Luna, Madrid\"\n    }}\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 330,
        "y": 720,
        "wires": [
            [
                "529f65ba.a3f03c"
            ]
        ]
    },
    {
        "id": "f0663c0a.d0646",
        "type": "mongodb in",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "find sub",
        "collection": "subscriptions",
        "operation": "find",
        "x": 880,
        "y": 800,
        "wires": [
            [
                "54c7f5d3.8c4e7c",
                "6cfebdf8.84ef74"
            ]
        ]
    },
    {
        "id": "7636ac6a.243324",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "query sub",
        "func": "msg.chatId = msg.payload.chatId;\nmsg.payload = {\"chatId\": msg.payload.chatId };\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 720,
        "y": 800,
        "wires": [
            [
                "f0663c0a.d0646"
            ]
        ]
    },
    {
        "id": "9f58b262.a60d",
        "type": "telegram command",
        "z": "93cb4937.6fc068",
        "name": "/info",
        "command": "/info",
        "bot": "f93d1a38.c43218",
        "x": 90,
        "y": 800,
        "wires": [
            [
                "35d1de38.e04672"
            ],
            []
        ]
    },
    {
        "id": "9637d9cb.5f8a38",
        "type": "mongodb in",
        "z": "2b8628df.fdcca8",
        "mongodb": "51a7af07.93444",
        "name": "find subs near",
        "collection": "subscriptions",
        "operation": "find",
        "x": 880,
        "y": 240,
        "wires": [
            [
                "1986ad37.928233"
            ]
        ]
    },
    {
        "id": "59c0890d.7d97e8",
        "type": "function",
        "z": "2b8628df.fdcca8",
        "name": "near?",
        "func": "msg.payload = {\n     geo:\n       { $near : {\n            $geometry: { \n                type: \"Point\",  \n                coordinates: [ msg.lon, msg.lat]\n            },\n            $minDistance: 0,\n            $maxDistance: 1000000\n          }\n       }\n   }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 710,
        "y": 240,
        "wires": [
            [
                "9637d9cb.5f8a38"
            ]
        ]
    },
    {
        "id": "ca5f1316.5932c",
        "type": "function",
        "z": "95e78a8b.50a428",
        "name": "calc distances",
        "func": "var t = msg.i18n;\n\n// node.log(\"Enter chatId: \" + msg.payload[i].chatId);\n\n// https://www.npmjs.com/package/geolib\nvar dist = context.global.geolib.getDistance(\n    { latitude: msg.payload.location.lat, \n      longitude: msg.payload.location.lon\n    },\n    { latitude: msg.lat, \n      longitude: msg.lon\n    }\n); \n// node.log(\"end calc dist chatId: \" + msg.payload[i].chatId);\n\nvar maxDist =  msg.payload.distance;\n// node.log(\"chatId: \" + msg.payload[i].chatId + \" maxDist \" + maxDist + \" dist \" + dist/1000);\n\nif (dist/1000 <= maxDist) {\n    var km = Math.round(dist/1000 * 10) / 10\n    var content;\n    if (msg.type === \"vecinal\") {\n        // kmvecinal : 'üî• Alerta de posible fuego a {{km}} –∫–º de distancia (fuente NASA):''\n        content = t('kmvecinal', {km: km});\n    } else if (msg.type === \"modis\" || msg.type === \"viirs\") {\n        // kmnasa : 'üî• Alerta vecinal de fuego a {{km}} –∫–º de distancia:''\n        content = t('kmnasa', {km: km});\n    }\n    var caption = {\n        payload : {\n          chatId : msg.payload.chatId,\n          type : \"message\",\n          content: content\n        }\n    }\n    \n    var notification = {\n        payload : {\n          chatId : msg.payload.chatId,\n          type : \"location\",\n          content: {\n             longitude: msg.lon,\n             latitude: msg.lat \n          }\n        },\n        caption: caption,\n        i18n: t\n    }\n    \n    var newMsg = {\n        payload: {\n            chatId: msg.payload.chatId,\n            geo: { $near : {\n                $geometry: { \n                    type: \"Point\",  \n                    coordinates: [\n                        msg.lon,\n                        msg.lat\n                    ] },\n                $minDistance: 0,\n                $maxDistance: 500 // Junto notificaciones en un radio de 0.5km \n                }\n            }\n        },\n        notification: notification,\n        caption: caption,\n        i18n: t\n    };\n    \n    node.send(newMsg);\n}\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 220,
        "y": 100,
        "wires": [
            [
                "c0e6a5d.fb1e058"
            ]
        ]
    },
    {
        "id": "6cfebdf8.84ef74",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "send location",
        "func": "var t = msg.i18n;\nvar km = msg.payload[0].distance;\nif (msg.payload.length > 0) {\n    var caption = {\n        payload : {\n          chatId : msg.payload[0].chatId,\n          type : \"message\",\n          content: t('kmdistancia', {km: km})\n        }\n    }\n    \n    var location = {\n        payload : {\n          chatId : msg.payload[0].chatId,\n          type : \"location\",\n          content: {\n             longitude: msg.payload[0].location.lon,\n             latitude: msg.payload[0].location.lat\n          }\n        }\n    }\n    return [caption, location, null];\n}",
        "outputs": "2",
        "noerr": 0,
        "x": 1070,
        "y": 840,
        "wires": [
            [
                "fbac8488.5194a8"
            ],
            [
                "74146dac.0d0704"
            ]
        ],
        "outputLabels": [
            "caption",
            "location"
        ]
    },
    {
        "id": "54c7f5d3.8c4e7c",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "no susc",
        "func": "var t = msg.i18n;\nif (msg.payload.length === 0) {\n    msg.payload.type = \"message\";\n    msg.payload.content = t('No est√°s suscrito/a a ninguna alerta');\n    msg.payload.chatId = msg.chatId;\n    return msg;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1060,
        "y": 800,
        "wires": [
            [
                "fbac8488.5194a8"
            ]
        ]
    },
    {
        "id": "82292481.dd9428",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "update km",
        "func": "var km = Number(msg.payload.content.replace(/(a |em |en |)([0-9]+)[ ]*km( around| arredor|)/, \"$2\"));\nvar newMsg = {\n    query : {\n        // No busca bien con _id, \n        // duplicamos chatId\n        chatId : msg.payload.chatId \n    },\n    payload: {\n       $set: {        \n           distance : km\n       }\n    },\n    i18n: msg.i18n\n};\n\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 590,
        "y": 640,
        "wires": [
            [
                "10d562eb.b0de5d",
                "f26677b3.07e7f8"
            ]
        ]
    },
    {
        "id": "c063defc.417ea",
        "type": "mongodb out",
        "z": "95e78a8b.50a428",
        "mongodb": "51a7af07.93444",
        "name": "save notis",
        "collection": "notifications",
        "payonly": false,
        "upsert": true,
        "multi": true,
        "operation": "store",
        "x": 1190,
        "y": 60,
        "wires": []
    },
    {
        "id": "53f7be24.9be16",
        "type": "mongodb in",
        "z": "95e78a8b.50a428",
        "mongodb": "51a7af07.93444",
        "name": "find notis",
        "collection": "notifications",
        "operation": "find",
        "x": 600,
        "y": 100,
        "wires": [
            [
                "990b8bb6.bacdd8"
            ]
        ]
    },
    {
        "id": "6329567.da6b7a8",
        "type": "function",
        "z": "95e78a8b.50a428",
        "name": "noti query",
        "func": "if (msg.payload.type === \"location\") {\n    var newMsg = {\n        chatId: msg.payload.chatId,\n        geo: {\n            type: \"Point\",\n            coordinates: [ \n                msg.payload.content.longitude,\n                msg.payload.content.latitude\n            ]\n        }\n    };\n    return newMsg;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1020,
        "y": 60,
        "wires": [
            [
                "c063defc.417ea"
            ]
        ]
    },
    {
        "id": "990b8bb6.bacdd8",
        "type": "function",
        "z": "95e78a8b.50a428",
        "name": "save and send",
        "func": "if (msg.payload.length === 0) {\n    // No yet notified save and \n    // send notifications\n    return [ msg.notification, [msg.caption, msg.notification], null];\n} else {\n    // Already notified, do nothing\n}\n",
        "outputs": "2",
        "noerr": 0,
        "x": 800,
        "y": 100,
        "wires": [
            [
                "6329567.da6b7a8"
            ],
            [
                "cf97891b.2928a8"
            ]
        ]
    },
    {
        "id": "c0e6a5d.fb1e058",
        "type": "delay",
        "z": "95e78a8b.50a428",
        "name": "rate 5s",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "5",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 420,
        "y": 100,
        "wires": [
            [
                "53f7be24.9be16"
            ]
        ]
    },
    {
        "id": "cf97891b.2928a8",
        "type": "delay",
        "z": "95e78a8b.50a428",
        "name": "rate 1x2s",
        "pauseType": "rate",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "2",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 1020,
        "y": 100,
        "wires": [
            [
                "d79d8e7b.539c8"
            ]
        ]
    },
    {
        "id": "6294a71e.647c58",
        "type": "debug",
        "z": "2b8628df.fdcca8",
        "name": "false positive",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 740,
        "y": 320,
        "wires": []
    },
    {
        "id": "70cddff9.2dbfb",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "save geofind",
        "func": "var newMsg = {\n    query : {\n        // No busca bien con _id, \n        // duplicamos chatId\n        chatId : msg.chatId \n    },\n    payload: {\n       $set: {        \n            location: {\n                lat: msg.payload.lat,\n                lon: msg.payload.lon,\n                text: msg.address\n            },\n            // _id: msg.chatId,\n            chatId: msg.chatId,\n            geo: {\n                type: \"Point\",\n                coordinates: [msg.payload.lon, msg.payload.lat]\n            },\n            distance: 5\n        }\n    },\n    location: {\n        lat: msg.payload.lat,\n        lon: msg.payload.lon\n    },\n    // _id: msg.chatId,\n    chatId: msg.chatId,\n    i18n: msg.i18n\n    \n}\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1780,
        "y": 540,
        "wires": [
            [
                "4f819d77.37fcc4",
                "771c05f7.78a3ac",
                "bed1aee.d1d745",
                "25c52409.dd295c"
            ]
        ]
    },
    {
        "id": "10eb3fd5.6d416",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "save location",
        "func": "var newMsg = {\n    query : {\n        // No busca bien con _id, \n        // duplicamos chatId\n        chatId : msg.payload.chatId \n    },\n    // payload $set for updates\n    payload: {\n       $set: {        \n    location: {\n        lat: msg.payload.content.latitude,\n        lon: msg.payload.content.longitude\n    },\n    // _id: msg.payload.chatId,\n    chatId: msg.payload.chatId,\n    geo: {\n        type: \"Point\",\n        coordinates: [\n            msg.payload.content.longitude, \n            msg.payload.content.latitude]\n    },\n    distance: 5\n       }\n    },\n    location: {\n        lat: msg.payload.content.latitude,\n        lon: msg.payload.content.longitude\n    },\n    chatId: msg.payload.chatId,\n    i18n: msg.i18n\n}\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1650,
        "y": 600,
        "wires": [
            [
                "bed1aee.d1d745",
                "771c05f7.78a3ac",
                "25c52409.dd295c"
            ]
        ]
    },
    {
        "id": "543a368a.8447b8",
        "type": "config",
        "z": "93cb4937.6fc068",
        "name": "config-dev",
        "properties": [
            {
                "p": "ftp-path",
                "pt": "global",
                "to": "/tmp/",
                "tot": "str"
            },
            {
                "p": "sends-news-to",
                "pt": "global",
                "to": "all",
                "tot": "str"
            },
            {
                "p": "conf-path",
                "pt": "global",
                "to": "./",
                "tot": "str"
            }
        ],
        "active": true,
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "73b0043e.3d68dc",
        "type": "config",
        "z": "93cb4937.6fc068",
        "name": "config-prod",
        "properties": [
            {
                "p": "ftp-path",
                "pt": "global",
                "to": "/data/",
                "tot": "str"
            },
            {
                "p": "sends-news-to",
                "pt": "global",
                "to": "all",
                "tot": "str"
            },
            {
                "p": "conf-path",
                "pt": "global",
                "to": "/data/",
                "tot": "str"
            }
        ],
        "active": false,
        "x": 330,
        "y": 40,
        "wires": []
    },
    {
        "id": "48cdccd8.2399a4",
        "type": "delay",
        "z": "93cb4937.6fc068",
        "name": "d 300ms",
        "pauseType": "delay",
        "timeout": "300",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 2380,
        "y": 640,
        "wires": [
            [
                "f9199a3f.b81058"
            ]
        ]
    },
    {
        "id": "92cf1a70.8b3e38",
        "type": "telegram command",
        "z": "93cb4937.6fc068",
        "name": "/suscribirme",
        "command": "/suscribirme",
        "bot": "f93d1a38.c43218",
        "x": 110,
        "y": 240,
        "wires": [
            [
                "a1932f34.2ab98"
            ],
            []
        ]
    },
    {
        "id": "f3249bab.90eae8",
        "type": "delay",
        "z": "93cb4937.6fc068",
        "name": "rate",
        "pauseType": "rate",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 570,
        "y": 800,
        "wires": [
            [
                "7636ac6a.243324"
            ]
        ]
    },
    {
        "id": "a1932f34.2ab98",
        "type": "delay",
        "z": "93cb4937.6fc068",
        "name": "rate",
        "pauseType": "rate",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 270,
        "y": 240,
        "wires": [
            [
                "be0cbd6.2efaf4"
            ]
        ]
    },
    {
        "id": "98bfcdd0.736cf",
        "type": "delay",
        "z": "93cb4937.6fc068",
        "name": "rate",
        "pauseType": "rate",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "2",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 790,
        "y": 380,
        "wires": [
            [
                "b870e649.02f3a8"
            ]
        ]
    },
    {
        "id": "c89c411b.79f73",
        "type": "delay",
        "z": "93cb4937.6fc068",
        "name": "rate",
        "pauseType": "rate",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 890,
        "y": 480,
        "wires": [
            [
                "9951a307.647d"
            ]
        ]
    },
    {
        "id": "d79d8e7b.539c8",
        "type": "delay",
        "z": "95e78a8b.50a428",
        "name": "rate 20x1m",
        "pauseType": "rate",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "20",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 1190,
        "y": 100,
        "wires": [
            [
                "a890056b.ebcff8",
                "a8447ee4.5f9bc"
            ]
        ]
    },
    {
        "id": "8cffd8ff.5786d8",
        "type": "ui_chart",
        "z": "2b8628df.fdcca8",
        "name": "to dash",
        "group": "601660c.cd104a",
        "order": 1,
        "width": "0",
        "height": "0",
        "label": "Usuarios cercanos",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "useOldStyle": false,
        "x": 1320,
        "y": 140,
        "wires": [
            [
                "ac0b5f28.dea74"
            ],
            []
        ]
    },
    {
        "id": "c7da78e3.f6ea28",
        "type": "function",
        "z": "2b8628df.fdcca8",
        "name": "users near (hangs!)",
        "func": "var newMsg  = {\n    payload: msg.payload.length,\n    label: 'Usuarios en la zona (notif. ' + msg.type + ')'\n}\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1110,
        "y": 140,
        "wires": [
            [
                "8cffd8ff.5786d8"
            ]
        ]
    },
    {
        "id": "d8b00aa6.5027f8",
        "type": "function",
        "z": "3f0768a7.1fac78",
        "name": "count active",
        "func": "if (Array.isArray(msg.payload)) {\n    var newMsg  = {\n        payload: msg.payload.length,\n        topic: \"Fuegos activos (\" + msg.type + \"\"\n    }\n    return newMsg;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 210,
        "y": 60,
        "wires": [
            [
                "44fbc396.81360c"
            ]
        ]
    },
    {
        "id": "44fbc396.81360c",
        "type": "ui_chart",
        "z": "3f0768a7.1fac78",
        "name": "to dash",
        "group": "601660c.cd104a",
        "order": 2,
        "width": "0",
        "height": "0",
        "label": "Fuegos activos en el mundo (fuente NASA)",
        "chartType": "line",
        "legend": "false",
        "xformat": "Y-M-D",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "604800",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "useOldStyle": false,
        "x": 400,
        "y": 60,
        "wires": [
            [
                "c4c96710.0c14f8"
            ],
            []
        ]
    },
    {
        "id": "abe7d7fb.2c4708",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "inc subs",
        "func": "// var day = context.global.moment.utc().dayOfYear()\n\nvar newMsg = {\n    query : {\n        // day: day,\n        name: \"numsus\"\n    },\n    payload: {\n        $inc: { value: 1 }\n    }\n}\n\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1040,
        "y": 740,
        "wires": [
            [
                "4bd722d5.8df87c"
            ]
        ]
    },
    {
        "id": "4bd722d5.8df87c",
        "type": "mongodb out",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "update stats",
        "collection": "fstats",
        "payonly": false,
        "upsert": true,
        "multi": false,
        "operation": "update",
        "x": 1230,
        "y": 740,
        "wires": []
    },
    {
        "id": "64500fb0.8e131",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "in desubs",
        "func": "// var day = context.global.moment.utc().dayOfYear()\n\nvar newMsg = {\n    query : {\n        // day: day,\n        name: \"numdesus\"\n    },\n    payload: {\n        $inc: { value: 1 }\n    }\n}\n\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 940,
        "y": 520,
        "wires": [
            [
                "659f7d56.aca1d4"
            ]
        ]
    },
    {
        "id": "659f7d56.aca1d4",
        "type": "mongodb out",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "update stats",
        "collection": "fstats",
        "payonly": false,
        "upsert": true,
        "multi": false,
        "operation": "update",
        "x": 1110,
        "y": 540,
        "wires": []
    },
    {
        "id": "475edba3.768d04",
        "type": "mongodb out",
        "z": "95e78a8b.50a428",
        "mongodb": "51a7af07.93444",
        "name": "update stats",
        "collection": "fstats",
        "payonly": false,
        "upsert": true,
        "multi": false,
        "operation": "update",
        "x": 1510,
        "y": 60,
        "wires": []
    },
    {
        "id": "a890056b.ebcff8",
        "type": "function",
        "z": "95e78a8b.50a428",
        "name": "inc subs",
        "func": "// var day = context.global.moment.utc().dayOfYear()\n\nvar newMsg = {\n    query : {\n        // day: day,\n        name: \"sendnotis\"\n    },\n    payload: {\n        $inc: { value: 1 }\n    }\n}\n\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1360,
        "y": 60,
        "wires": [
            [
                "475edba3.768d04"
            ]
        ]
    },
    {
        "id": "c6746cf.d2d809",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "all",
        "func": "// empty payload == all\nvar newMsg = {\n    payload: {\n    }}\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 370,
        "y": 80,
        "wires": [
            [
                "afa80f90.4891d"
            ]
        ]
    },
    {
        "id": "b3f1e61b.568c08",
        "type": "inject",
        "z": "93cb4937.6fc068",
        "name": "delete day notis",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "00 0 * * *",
        "once": false,
        "x": 140,
        "y": 80,
        "wires": [
            [
                "c6746cf.d2d809"
            ]
        ]
    },
    {
        "id": "afa80f90.4891d",
        "type": "mongodb out",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "delete notis",
        "collection": "notifications",
        "payonly": false,
        "upsert": true,
        "multi": true,
        "operation": "delete",
        "x": 530,
        "y": 80,
        "wires": []
    },
    {
        "id": "cbe0e85b.a53018",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "112",
        "func": "var t = msg.i18n;\nvar newMsg = {\n    payload: {\n        type: \"message\",\n        content: t('No olvides llamar al üìû112 si no lo has hecho ya para avisar a los servicios de emergencia üöí'),\n        chatId : msg.payload.chatId\n    },\n    i18n: msg.i18n\n};\nreturn newMsg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 570,
        "y": 760,
        "wires": [
            [
                "373aa2ef.0aac9e"
            ]
        ]
    },
    {
        "id": "1292920f.64d29e",
        "type": "delay",
        "z": "93cb4937.6fc068",
        "name": "rate",
        "pauseType": "rate",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 570,
        "y": 440,
        "wires": [
            [
                "b0289aa8.88a968"
            ]
        ]
    },
    {
        "id": "b0289aa8.88a968",
        "type": "delay",
        "z": "93cb4937.6fc068",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 720,
        "y": 440,
        "wires": [
            [
                "22b64555.dd2e7a"
            ]
        ]
    },
    {
        "id": "9620588a.113218",
        "type": "google geocoding",
        "z": "c644db46.3854c8",
        "name": "Geo Fire",
        "geocodeBy": "address",
        "address": "",
        "lat": "",
        "lon": "",
        "googleAPI": "9f205dc2.bd858",
        "bounds": "",
        "language": "",
        "region": "",
        "components": "",
        "x": 780,
        "y": 320,
        "wires": [
            [
                "b9c8c0db.ee0be"
            ]
        ]
    },
    {
        "id": "5c52af18.0b854",
        "type": "telegram reply",
        "z": "c644db46.3854c8",
        "name": "get reply",
        "bot": "f93d1a38.c43218",
        "x": 360,
        "y": 320,
        "wires": [
            [
                "4cd4a2cd.e15ecc"
            ]
        ]
    },
    {
        "id": "4230490a.147bf8",
        "type": "function",
        "z": "c644db46.3854c8",
        "name": "write pos",
        "func": "var t = msg.i18n;\nmsg.payload.type = 'message';\nmsg.payload.content = t('Escribir localizaci√≥n del fuego (por ej. tu pueblo, una calle, etc). Si usas un m√≥vil tambi√©n puedes adjuntar una ubicaci√≥n pulsando el clip:');\n\nvar opts = {\n  reply_markup: JSON.stringify({\n    force_reply: true,\n  })\n};\n\nmsg.payload.options = opts;\nreturn msg;\n",
        "outputs": "1",
        "noerr": 0,
        "x": 100,
        "y": 320,
        "wires": [
            [
                "320b1cf9.d609d4"
            ]
        ]
    },
    {
        "id": "60ee8a37.032aa4",
        "type": "subflow:c644db46.3854c8",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 580,
        "y": 600,
        "wires": []
    },
    {
        "id": "b0495fbe.5ecca",
        "type": "function",
        "z": "c6a40c11.dfc6b",
        "name": "volver btn",
        "func": "var t = msg.i18n;\nvar opts = {\n    // reply_to_message_id: msg.payload.messageId,\n    reply_to_message_id : null,\n    reply_markup: JSON.stringify({\n        force_reply: true,\n        keyboard: [ \n            [{text: t(\"‚¨ÖÔ∏è Volver\")}]\n        ], \n        'resize_keyboard' : true, \n        'one_time_keyboard' : false\n        })\n    };\nmsg.payload.type = \"message\";\nmsg.payload.options = opts;\nreturn [msg];",
        "outputs": 1,
        "noerr": 0,
        "x": 250,
        "y": 120,
        "wires": [
            [
                "1e1d9c8f.87ccc3"
            ]
        ]
    },
    {
        "id": "8e21846c.61c698",
        "type": "function",
        "z": "c644db46.3854c8",
        "name": "ask confirmation",
        "func": "var t = msg.i18n;\n\nvar isUser = msg.payload.chatId > 0;\n\ncontext.global.keyboard = { pending : true };\n\nvar opts = {\n  reply_to_message_id: msg.payload.messageId,\n  reply_markup: JSON.stringify({\n    \"inline_keyboard\": [[\n                {\n                    \"text\": t('S√≠'),\n                    \"callback_data\": \"notify_fire\"\n                },\n                {\n                    \"text\": t('No'),\n                    \"callback_data\": \"no_notify_fire\"\n                }]\n            ]\n  })\n};\n\nvar key = 'location-' + msg.payload.chatId;\nglobal.set(key, msg);\n\nvar newMsg = {\n    payload : {\n        chatId: msg.payload.chatId,\n        type: 'message',\n        content: t('Vas a notificar a los vecinos cercanos sobre este fuego ¬øest√°s seguro/a?'),\n        options: opts\n    }\n};\n\nif (isUser) {\n  //  msg.payload.content += ' Te solicitaremos t√∫ contacto como medida de seguridad.';\n}\n\nreturn [newMsg, null];",
        "outputs": "1",
        "noerr": 0,
        "x": 1310,
        "y": 220,
        "wires": [
            [
                "eda1038.09ff8"
            ]
        ]
    },
    {
        "id": "a95a87ec.d0c648",
        "type": "function",
        "z": "156e20df.86399f",
        "name": "send location",
        "func": "var caption = {\n    payload : {\n      chatId : msg.chatId,\n      type : \"message\",\n      content: msg.caption\n    }\n}\n\nvar location = {\n    payload : {\n      chatId : msg.chatId,\n      type : \"location\",\n      content: {\n         longitude: msg.location.lon,\n         latitude: msg.location.lat\n      }\n    }\n}\nreturn [msg, location, caption];",
        "outputs": "3",
        "noerr": 0,
        "x": 310,
        "y": 160,
        "wires": [
            [
                "748b9d33.3e7354"
            ],
            [
                "dac16e62.49529"
            ],
            [
                "4617874.e42eb78"
            ]
        ],
        "outputLabels": [
            "msg",
            "location",
            "caption"
        ]
    },
    {
        "id": "771c05f7.78a3ac",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "subs caption",
        "func": "var t = msg.i18n;\nmsg.caption = t('Este es el mapa del lugar al que te subscribes');\nmsg.payload.chatId = msg.chatId;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1990,
        "y": 640,
        "wires": [
            [
                "ad6ea913.641818"
            ]
        ]
    },
    {
        "id": "ad6ea913.641818",
        "type": "subflow:156e20df.86399f",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 2200,
        "y": 640,
        "wires": [
            [
                "48cdccd8.2399a4"
            ]
        ]
    },
    {
        "id": "46ab5b3e.b67004",
        "type": "subflow:156e20df.86399f",
        "z": "c644db46.3854c8",
        "name": "",
        "x": 1260,
        "y": 320,
        "wires": [
            [
                "ad92a3e7.bb743"
            ]
        ]
    },
    {
        "id": "6d492c2d.a26024",
        "type": "function",
        "z": "c644db46.3854c8",
        "name": "caption, etc",
        "func": "var t = msg.i18n;\nmsg.caption = t('Este es el mapa del lugar donde crees que hay un fuego');\nmsg.location.text = msg.address;\nmsg.payload.chatId = msg.chatId;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1090,
        "y": 320,
        "wires": [
            [
                "46ab5b3e.b67004"
            ]
        ]
    },
    {
        "id": "f0bdf975.8486e8",
        "type": "telegram command",
        "z": "93cb4937.6fc068",
        "name": "/fuego",
        "command": "/fuego",
        "bot": "f93d1a38.c43218",
        "x": 90,
        "y": 900,
        "wires": [
            [
                "269ca556.b7a1ba"
            ],
            []
        ]
    },
    {
        "id": "dac16e62.49529",
        "type": "delay",
        "z": "156e20df.86399f",
        "name": "d 300ms",
        "pauseType": "delay",
        "timeout": "300",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 540,
        "y": 220,
        "wires": [
            [
                "307c3839.005448"
            ]
        ]
    },
    {
        "id": "748b9d33.3e7354",
        "type": "delay",
        "z": "156e20df.86399f",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 540,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "74146dac.0d0704",
        "type": "delay",
        "z": "93cb4937.6fc068",
        "name": "d 300ms",
        "pauseType": "delay",
        "timeout": "300",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 1240,
        "y": 860,
        "wires": [
            [
                "33cd0275.71172e"
            ]
        ]
    },
    {
        "id": "4a109a88.7389a4",
        "type": "function",
        "z": "9968fcc5.ed33c",
        "name": "men√∫ distancia",
        "func": "var t = msg.i18n;\ncontext.global.keyboard = { pending : true };\n\n// if (msg.payload.type == 'message') {\nvar opts = {\n  // reply_to_message_id: msg.payload.messageId,\n  reply_markup: JSON.stringify({\n    force_reply: true,\n    keyboard: [ \n        [{text: t('a 5 km')}, {text: t('a 10 km')}],\n        [{text: t('a 20 km')}, {text: t('a 40 km')} ],\n        [{text: t('a 100 km')}, {text: t('‚¨ÖÔ∏è Cancelar')} ]],\n      'resize_keyboard' : true, \n      'one_time_keyboard' : true\n  })\n};\n\nmsg.payload.type = 'message';\nmsg.payload.content = t('¬øA que distancia a la redonda quieres recibir notificaciones?');\nmsg.payload.options = opts;\n\nreturn msg;\n//}\n",
        "outputs": "1",
        "noerr": 0,
        "x": 360,
        "y": 120,
        "wires": [
            [
                "aa2956c1.cdd168"
            ]
        ]
    },
    {
        "id": "f9199a3f.b81058",
        "type": "subflow:9968fcc5.ed33c",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 2560,
        "y": 640,
        "wires": []
    },
    {
        "id": "19b16d50.b6eed3",
        "type": "telegram command",
        "z": "93cb4937.6fc068",
        "name": "/distancia",
        "command": "/distancia",
        "bot": "f93d1a38.c43218",
        "x": 100,
        "y": 1060,
        "wires": [
            [
                "192c6f7a.054a91"
            ],
            []
        ]
    },
    {
        "id": "192c6f7a.054a91",
        "type": "delay",
        "z": "93cb4937.6fc068",
        "name": "rate",
        "pauseType": "rate",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 290,
        "y": 1060,
        "wires": [
            [
                "16c436c8.0c8dc9"
            ]
        ]
    },
    {
        "id": "7d6a8c23.8b1694",
        "type": "subflow:9968fcc5.ed33c",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 600,
        "y": 1060,
        "wires": []
    },
    {
        "id": "539a53d4.268c7c",
        "type": "subflow:9968fcc5.ed33c",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 600,
        "y": 860,
        "wires": []
    },
    {
        "id": "d6336a1e.3ad888",
        "type": "subflow:c644db46.3854c8",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 1780,
        "y": 680,
        "wires": []
    },
    {
        "id": "5eea2f81.66eb7",
        "type": "debug",
        "z": "9968fcc5.ed33c",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 570,
        "y": 180,
        "wires": []
    },
    {
        "id": "48b0356c.7fd7ac",
        "type": "debug",
        "z": "156e20df.86399f",
        "name": "all sendloc",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 310,
        "y": 220,
        "wires": []
    },
    {
        "id": "862cd972.e97388",
        "type": "telegram receiver",
        "z": "93cb4937.6fc068",
        "name": "rec",
        "bot": "f93d1a38.c43218",
        "saveDataDir": "",
        "x": 950,
        "y": 640,
        "wires": [
            [
                "349ef6f8.98e88a"
            ],
            []
        ]
    },
    {
        "id": "f0552abc.9ccb78",
        "type": "function",
        "z": "76bd701f.29d0f",
        "name": "query sub",
        "func": "msg.chatId = msg.payload.chatId;\nmsg.originalPayload = msg.payload;\nmsg.payload = {chatId: msg.chatId };\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 580,
        "y": 100,
        "wires": [
            [
                "9a2aeae1.fa4bf8"
            ]
        ]
    },
    {
        "id": "9a2aeae1.fa4bf8",
        "type": "mongodb in",
        "z": "76bd701f.29d0f",
        "mongodb": "51a7af07.93444",
        "name": "find sub",
        "collection": "subscriptions",
        "operation": "find",
        "x": 720,
        "y": 100,
        "wires": [
            [
                "56722a87.7bd4b4"
            ]
        ]
    },
    {
        "id": "875a7c37.8bb0a",
        "type": "function",
        "z": "76bd701f.29d0f",
        "name": "start menu",
        "func": "context.global.keyboard = { pending : true };\n\nvar t = msg.i18n;\n\n// https://apps.timwhitlock.info/emoji/tables/unicode\n\n// is subs or not\nvar subs = msg.payload.length === 0;\nmsg.payload = msg.originalPayload;\n\nif (subs) {\n    // Ya suscrito\n    var opts = {\n        // reply_to_message_id: msg.payload.messageId,\n        reply_markup:\n        JSON.stringify(\n            {\n                keyboard: [ \n                    [{text: t('üì£ Suscribirme a fuegos en mi zona')}],\n                    [{text: t('üî• Notificar un fuego nuevo')} ], \n                    [{text: t('‚ô• Apoya esta iniciativa')}, {text: t('üìñ M√°s info')}, ] ],\n                'resize_keyboard' : true, \n                // 'one_time_keyboard' : true\n            })\n    };\n} else {\n    var opts = {\n        // reply_to_message_id: msg.payload.messageId,\n        reply_markup:\n        JSON.stringify(\n            {\n                keyboard: [ \n                    [{text: t('üì£ Suscrito a nuevos fuegos')}],\n                    [{text: t('Desuscribirme')}, {text: t('üî• Notificar un fuego nuevo')} ], \n                    [{text: t('‚ô• Apoya esta iniciativa')}, {text: t('üìñ M√°s info')}, ] ],\n                'resize_keyboard' : true, \n                // 'one_time_keyboard' : true\n            })\n    };\n}\n\n// node.log(typeof msg.payload.content);\n\nif (typeof msg.payload.content === 'undefined' || msg.payload.content === null ||\n    (typeof msg.payload.content === 'string' &&\n    msg.payload.content.match(/‚¨ÖÔ∏è .*/)) ||\n    msg.payload.content === '') {\n    msg.payload.content = t('Elige una de las opciones:');\n} else {\n    // Only for debugging\n    // msg.payload.content = msg.payload.content + \".\";\n}\n\nmsg.payload.chatId = msg.chatId;\n\nif (typeof msg.payload.type === 'undefined' || msg.payload.type === null) {\n    msg.payload.type = \"message\";\n}\n\nopts.disable_notification = true;\nmsg.payload.options = opts;\n\nreturn [ msg ];",
        "outputs": "1",
        "noerr": 0,
        "x": 1090,
        "y": 100,
        "wires": [
            [
                "b2e2ccf3.f0498"
            ]
        ]
    },
    {
        "id": "55ebd8f8.436e38",
        "type": "subflow:76bd701f.29d0f",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 570,
        "y": 340,
        "wires": []
    },
    {
        "id": "bf50334e.7ac3a",
        "type": "subflow:76bd701f.29d0f",
        "z": "465e67f.6ebf598",
        "name": "",
        "x": 350,
        "y": 40,
        "wires": []
    },
    {
        "id": "596d56e2.54f5e8",
        "type": "delay",
        "z": "76bd701f.29d0f",
        "name": "start drop",
        "pauseType": "rate",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 280,
        "y": 100,
        "wires": [
            [
                "b3331045.d30b3"
            ]
        ]
    },
    {
        "id": "730cf241.49734c",
        "type": "switch",
        "z": "c644db46.3854c8",
        "name": "",
        "property": "payload.type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "location",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "outputs": 2,
        "x": 150,
        "y": 120,
        "wires": [
            [
                "ad92a3e7.bb743"
            ],
            [
                "4230490a.147bf8"
            ]
        ],
        "outputLabels": [
            "location",
            "message"
        ]
    },
    {
        "id": "349ef6f8.98e88a",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "is loc",
        "func": "if (msg.payload.type === 'location' && \n    typeof msg.geo === 'undefined') {\n    // node.log(\"Location received\");  \n    return msg;\n} else {\n    // return null;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1110,
        "y": 640,
        "wires": [
            [
                "69a62d00.26b314"
            ]
        ]
    },
    {
        "id": "1e112e4e.062b82",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "payl",
        "active": false,
        "console": "false",
        "complete": "payload",
        "x": 1410,
        "y": 560,
        "wires": []
    },
    {
        "id": "5b42be73.7ac18",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "loc-lang",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1420,
        "y": 600,
        "wires": []
    },
    {
        "id": "52271fef.7036",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "all",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1790,
        "y": 480,
        "wires": []
    },
    {
        "id": "baa17b12.6767a8",
        "type": "subflow:465e67f.6ebf598",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 1240,
        "y": 700,
        "wires": []
    },
    {
        "id": "fbac8488.5194a8",
        "type": "subflow:465e67f.6ebf598",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 1440,
        "y": 800,
        "wires": []
    },
    {
        "id": "dd53d5e0.fdd0b8",
        "type": "debug",
        "z": "c644db46.3854c8",
        "name": "near?",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 670,
        "y": 20,
        "wires": []
    },
    {
        "id": "ad92a3e7.bb743",
        "type": "function",
        "z": "c644db46.3854c8",
        "name": "near today?",
        "func": "var date = new Date();\nvar formated = context.global.moment(date).format('YYYYMMDD');\nmsg.originalMessage = msg.payload;\nmsg.originalLocation = msg.location;\nvar lon = msg.location.lon;\nvar lat = msg.location.lat;\n\nmsg.payload = {\n    geo:\n       { $near : {\n            $geometry: { \n                type: \"Point\",  \n                coordinates: [lon, lat]\n            },\n            $minDistance: 0,\n            $maxDistance: 200\n          }\n       },\n    dateformat: formated\n   }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 390,
        "y": 60,
        "wires": [
            [
                "a05c3c94.f331f"
            ]
        ]
    },
    {
        "id": "a05c3c94.f331f",
        "type": "mongodb in",
        "z": "c644db46.3854c8",
        "mongodb": "51a7af07.93444",
        "name": "find",
        "collection": "avisosfuego",
        "operation": "find",
        "x": 550,
        "y": 60,
        "wires": [
            [
                "af778312.fcd62"
            ]
        ]
    },
    {
        "id": "19f3b34b.f8ebcd",
        "type": "function",
        "z": "c644db46.3854c8",
        "name": "send Orig",
        "func": "var newMsg = {\n    payload: msg.originalMessage,\n    location: msg.originalLocation,\n    i18n: msg.i18n,\n};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1140,
        "y": 220,
        "wires": [
            [
                "8e21846c.61c698"
            ]
        ]
    },
    {
        "id": "af778312.fcd62",
        "type": "switch",
        "z": "c644db46.3854c8",
        "name": "already",
        "property": "payload.length",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "outputs": 2,
        "x": 680,
        "y": 60,
        "wires": [
            [
                "91cf9b3e.1b8b78"
            ],
            [
                "73053858.f6f538"
            ]
        ]
    },
    {
        "id": "91cf9b3e.1b8b78",
        "type": "function",
        "z": "c644db46.3854c8",
        "name": "already notif",
        "func": "var t = msg.i18n;\n// node.log(\"i18n: \" + typeof t);\nvar newMsg = {\n    payload: {\n        type: \"message\",\n        chatId: msg.originalMessage.chatId,\n        content: t('Este fuego o uno muy cercano ya ha sido notificado por otra persona anteriormente. ¬°Gracias!')\n    },\n    i18n: t\n};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 850,
        "y": 60,
        "wires": [
            [
                "9c7b7220.fab4c"
            ]
        ]
    },
    {
        "id": "9c7b7220.fab4c",
        "type": "subflow:c6a40c11.dfc6b",
        "z": "c644db46.3854c8",
        "x": 1170,
        "y": 60,
        "wires": []
    },
    {
        "id": "73053858.f6f538",
        "type": "function",
        "z": "c644db46.3854c8",
        "name": "today limits?",
        "func": "var date = new Date();\nvar formated = context.global.moment(date).format('YYYYMMDD');\n/*msg.originalMessage = msg.payload;\nmsg.originalLocation = msg.location;*/\nmsg.payload = {\n    chatId: msg.payload.chatId,\n    dateformat: formated\n   }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 120,
        "wires": [
            [
                "3083c74e.b35258"
            ]
        ]
    },
    {
        "id": "3083c74e.b35258",
        "type": "mongodb in",
        "z": "c644db46.3854c8",
        "mongodb": "51a7af07.93444",
        "name": "find",
        "collection": "avisosfuego",
        "operation": "find",
        "x": 830,
        "y": 120,
        "wires": [
            [
                "a227a0dc.c36ca"
            ]
        ]
    },
    {
        "id": "a227a0dc.c36ca",
        "type": "switch",
        "z": "c644db46.3854c8",
        "name": "already",
        "property": "payload.length",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "outputs": 2,
        "x": 960,
        "y": 120,
        "wires": [
            [
                "d9561c77.e3ca9"
            ],
            [
                "19f3b34b.f8ebcd"
            ]
        ]
    },
    {
        "id": "acfaa5f4.f3b898",
        "type": "function",
        "z": "c644db46.3854c8",
        "name": "limits notif",
        "func": "var t = msg.i18n;\n\nvar newMsg = {\n    payload: {\n        type: \"message\",\n        chatId: msg.originalMessage.chatId,\n        content: t('Ya hab√≠as notificado un fuego hoy. Si por alg√∫n motivo necesitas reportar m√°s de un fuego al d√≠a, ponte en contacto con nosotros: info@comunes.org ¬°Gracias!')\n    },\n    i18n: t\n}\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1300,
        "y": 140,
        "wires": [
            [
                "873d85b7.cdd238"
            ]
        ]
    },
    {
        "id": "873d85b7.cdd238",
        "type": "subflow:c6a40c11.dfc6b",
        "z": "c644db46.3854c8",
        "x": 1450,
        "y": 140,
        "wires": []
    },
    {
        "id": "d9561c77.e3ca9",
        "type": "switch",
        "z": "c644db46.3854c8",
        "name": "admin?",
        "property": "originalMessage.chatId",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "4885772",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "outputs": 2,
        "x": 1140,
        "y": 120,
        "wires": [
            [
                "19f3b34b.f8ebcd"
            ],
            [
                "acfaa5f4.f3b898"
            ]
        ]
    },
    {
        "id": "9ef9c4c5.a68d08",
        "type": "function",
        "z": "11cb3f4d.6e0081",
        "name": "update active fires",
        "func": "var type = msg.type;\nvar collection = \"activefires\" + type; // to detect new fires \n\nvar now = new Date();\nglobal.set('active-now', now);\nflow.set('active-collection', collection);\nflow.set('active-type', type);\n\n\nvar updates = [];\n\n// for (var i = 0; i < 10; i++) {\nfor (var i = 0; i < msg.payload.length; i++) {\n    var pay = msg.payload[i];\n    var lat = pay.latitude;\n    var lon = pay.longitude;\n    if (typeof lat === 'number' && typeof lon === 'number')  {\n        // Sometimes the data is not well formed/downloaded\n        var id = {\n            type: \"Point\",\n            coordinates: [ lon, lat ]\n        };\n        \n        // dates sample\n        // acq_date: \"2017-11-09\"\n        ///acq_time: \"06:30\"\n        var acdate = pay.acq_date;\n        var actime = pay.acq_time;\n        var when = context.global.moment.utc(acdate + \" \" + actime, \"YYYY-MM-DD HH:mm\").valueOf();\n\n        var setcommon = {\n            _id: id,\n            updatedAt: now,\n            type: type,\n            when : when,\n            acq_date: acdate,\n            acq_time: actime,\n            scan : pay.scan,\n            track : pay.track,\n            satellite : pay.satellite,\n            confidence : pay.confidence,\n            version : pay.version,\n            frp : pay.frp,\n            daynight : pay.daynight,\n        };\n        var setdiff;\n        if (type === \"modis\") {\n            setdiff = {\n                brightness : pay.brightness,\n                bright_t31 : pay.bright_t31\n            };\n        } else { // viirs\n            setdiff = {\n                bright_ti4 : pay.bright_ti4,\n                bright_ti5 : pay.bright_ti5,\n            };\n        }\n        \n        var setjoin = Object.assign(setcommon, setdiff);\n        \n        // remove empties\n        /* Object.keys(setjoin).forEach((key) => (setjoin[key] === null || typeof setjoin[key] === 'undefined') && \n               delete setjoin[key]); */\n\n        var set = { \n            $set: setjoin,\n            $setOnInsert: { createdAt: now }\n        };\n        \n        /* mongo basic\n        var update = {};\n        update.payload = set;\n        update.query = { _id:  id };\n        updates.push(update);\n        */\n        \n        // http://mongodb.github.io/node-mongodb-native/2.1/api/Collection.html#bulkWrite\n        // { updateOne: { filter: {a:2}, update: {$set: {a:2}}, upsert:true } }\n        updates.push({ updateOne: { filter: {_id: id}, update: set, upsert:true } });\n    }\n}\n\nvar bulkUpdate = {};\nbulkUpdate.collection = collection;\n// http://mongodb.github.io/node-mongodb-native/2.1/api/Collection.html#bulkWrite\n// https://docs.mongodb.com/manual/reference/write-concern/\nbulkUpdate.payload = [updates, {w: 1, wtimeout: 60000}];\nreturn bulkUpdate;",
        "outputs": "1",
        "noerr": 0,
        "x": 210,
        "y": 140,
        "wires": [
            [
                "54968e5b.432b1"
            ]
        ],
        "outputLabels": [
            "update/save"
        ]
    },
    {
        "id": "d982859c.d8dea8",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "args",
        "func": "var newMsg = {\n    payload: {\n        type: \"location\",\n        chatId: msg.payload.chatId\n    },\n    location: {\n        lon: msg.payload.content.longitude,\n        lat: msg.payload.content.latitude,\n        text: \"\"\n    },\n    i18n: msg.i18n\n};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1630,
        "y": 680,
        "wires": [
            [
                "d6336a1e.3ad888",
                "9c0ff2b9.ff7bc"
            ]
        ]
    },
    {
        "id": "9c0ff2b9.ff7bc",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "all",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1770,
        "y": 740,
        "wires": []
    },
    {
        "id": "8facbcf3.bbd35",
        "type": "debug",
        "z": "4a3c7cc0.965dd4",
        "name": "all",
        "active": true,
        "console": false,
        "complete": "true",
        "x": 510,
        "y": 160,
        "wires": []
    },
    {
        "id": "ef152257.faf05",
        "type": "comment",
        "z": "4a3c7cc0.965dd4",
        "name": "payload: name, lat, lon, layer, ..., icon, iconColor, photoUrl, deleted",
        "info": "layer, speed, bearing, accuracy, icon, iconColor, photoUrl, deleted",
        "x": 720,
        "y": 260,
        "wires": []
    },
    {
        "id": "7a257dc0.bf8594",
        "type": "subflow:4a3c7cc0.965dd4",
        "z": "d29a1c6a.5a89e",
        "name": "",
        "x": 350,
        "y": 100,
        "wires": []
    },
    {
        "id": "c4c96710.0c14f8",
        "type": "persist in",
        "z": "3f0768a7.1fac78",
        "name": "nasa-fire-active",
        "storageNode": "2c23f46.8edd30c",
        "x": 580,
        "y": 60,
        "wires": []
    },
    {
        "id": "b3460bb5.6fb918",
        "type": "persist out",
        "z": "3f0768a7.1fac78",
        "name": "nasa-fire-active",
        "storageNode": "2c23f46.8edd30c",
        "x": 200,
        "y": 100,
        "wires": [
            [
                "44fbc396.81360c"
            ]
        ]
    },
    {
        "id": "6187e791.e5f488",
        "type": "function",
        "z": "d29a1c6a.5a89e",
        "name": "neigh - args",
        "func": "// https://earthdata.nasa.gov/what-is-new-collection-6-modis-active-fire-data\nvar point = msg.location? msg: msg.payload;\n\nvar lat = point.location.lat;\nvar lon = point.location.lon;\nvar pname = \"\" + lat + \"/\" + lon;\npname += \"/\" + point.chatId? \"neighbourhood\" : \"neigh-alert/\" + point.dateformat;\n\n// https://github.com/dceejay/RedMap/issues/29\n// A kind of \"update\" (del & add)\nvar delMsg = {\n    payload: {\n        name: pname,\n        lat: lat,\n        lon: lon,\n        layer: point.chatId? \"Neighbourhood\": \"Neighbourhood alerts\",\n        deleted: true\n    }\n}\nnode.send(delMsg);\n\nvar addMsg = {\n    payload: {\n        name: pname,\n        lat: lat,\n        lon: lon,\n        layer: point.chatId? \"Neighbourhood\": \"Neighbourhood alerts\",\n        icon: point.chatId? \"fa-user\": \"fa-fire\",\n        iconColor: point.chatId? \"green\": \"red\",\n        addtoheatmap: false, // only rest to the heatmap\n        // radius: point.distance? point.distance * 1000: null,\n        // color: \"red\",\n        // fillColor: \"red\",\n        // intensity: intensity,\n        // weight: intensity,\n        // radius: 10000, // radius,\n        // fillOpacity: 1,\n        // weblink only with markers\n        // weblink: \"http://example.com\"\n        // photoUrl: \"http://loremflickr.com/320/240/wildfire\"\n    }\n};\n\nif (point.distance) {\n    var radiusDel = {\n        payload: {\n            name: pname,\n            lat: lat,\n            lon: lon,\n            layer: \"Neighbourhood area\",\n            deleted: true\n        }\n    }\n    node.send(radiusDel);\n    \n    var radius = {\n        payload: {\n            name: pname,\n            lat: lat,\n            lon: lon,\n            layer: \"Neighbourhood area\",\n            // icon:  \"hostile\",\n            // nColor: \"green\",\n            addtoheatmap: false,\n            radius: point.distance * 1000,\n            color: \"#145A32\",\n            fillColor: \"green\",\n            // intensity: intensity,\n            // weight: intensity,\n            fillOpacity: .1,\n            // weblink: \"http://example.com\"\n            // photoUrl: \"http://loremflickr.com/320/240/wildfire\"\n        }\n    }\n    node.send(radius);\n}\n\nreturn addMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 190,
        "y": 100,
        "wires": [
            [
                "7a257dc0.bf8594"
            ]
        ]
    },
    {
        "id": "ac0b5f28.dea74",
        "type": "persist in",
        "z": "2b8628df.fdcca8",
        "name": "near-neighbours",
        "storageNode": "db913a18.f8bf88",
        "x": 1520,
        "y": 140,
        "wires": []
    },
    {
        "id": "ce1799a1.35d408",
        "type": "persist out",
        "z": "2b8628df.fdcca8",
        "name": "near-neighbours",
        "storageNode": "db913a18.f8bf88",
        "x": 1110,
        "y": 100,
        "wires": [
            [
                "8cffd8ff.5786d8"
            ]
        ]
    },
    {
        "id": "cf23a5a.9eacd58",
        "type": "worldmap",
        "z": "4a3c7cc0.965dd4",
        "name": "",
        "lat": "‚Ä®40.4",
        "lon": "-3.6833333",
        "zoom": "6",
        "layer": "OSM grey",
        "cluster": "0",
        "maxage": "20000",
        "usermenu": "hide",
        "layers": "show",
        "x": 550,
        "y": 220,
        "wires": []
    },
    {
        "id": "3534f560.645aea",
        "type": "inject",
        "z": "93cb4937.6fc068",
        "name": "onInit",
        "topic": "",
        "payload": "",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 810,
        "y": 80,
        "wires": [
            [
                "f2c9762e.6c90a8"
            ]
        ]
    },
    {
        "id": "25c52409.dd295c",
        "type": "subflow:d29a1c6a.5a89e",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 2010,
        "y": 540,
        "wires": []
    },
    {
        "id": "251e2d7f.4e64c2",
        "type": "debug",
        "z": "d29a1c6a.5a89e",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 170,
        "y": 140,
        "wires": []
    },
    {
        "id": "57d802c7.63cd2c",
        "type": "worldmap in",
        "z": "91777bb3.922328",
        "name": "",
        "x": 320,
        "y": 100,
        "wires": [
            [
                "620ec824.128428"
            ]
        ]
    },
    {
        "id": "532b1add.453374",
        "type": "debug",
        "z": "91777bb3.922328",
        "name": "all",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 470,
        "y": 160,
        "wires": []
    },
    {
        "id": "620ec824.128428",
        "type": "function",
        "z": "91777bb3.922328",
        "name": "on connected",
        "func": "if (msg.payload && msg.payload.action && msg.payload.action == \"connected\") {\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 540,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "a30ccf58.3a1e",
        "type": "function",
        "z": "2f0217a5.051978",
        "name": "find prev false positive register",
        "func": "if (msg.originalMessage && \n    msg.originalMessage.reply_to_message &&\n    msg.originalMessage.reply_to_message.location) {\n    var lon = msg.originalMessage.reply_to_message.location.longitude;\n    var lat = msg.originalMessage.reply_to_message.location.latitude;\n    // TODO: must be a NASA fire\n    var find = {};\n    find.payload = {\n    geo:\n       { $near : {\n            $geometry: { \n                type: \"Point\",  \n                coordinates: [lon, lat]\n            },\n            $minDistance: 0,\n            $maxDistance: 200\n          }\n        },\n        chatId: msg.chatId\n    };\n    find.originalMessage = msg.originalMessage;\n    find.chatId = msg.chatId;\n    find.i18n = msg.i18n;\n    return find;\n}\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 390,
        "y": 400,
        "wires": [
            [
                "9eef9e79.27f5b"
            ]
        ]
    },
    {
        "id": "9eef9e79.27f5b",
        "type": "mongodb in",
        "z": "2f0217a5.051978",
        "mongodb": "51a7af07.93444",
        "name": "falsepositives count",
        "collection": "falsepositives",
        "operation": "find",
        "x": 680,
        "y": 400,
        "wires": [
            [
                "7f8ce0c9.99ac4"
            ]
        ]
    },
    {
        "id": "7f8ce0c9.99ac4",
        "type": "switch",
        "z": "2f0217a5.051978",
        "name": "already",
        "property": "payload.length",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "outputs": 2,
        "x": 860,
        "y": 400,
        "wires": [
            [
                "d7931057.66ab7"
            ],
            [
                "677cc27e.bad8ec",
                "ed07b302.7a6b7"
            ]
        ]
    },
    {
        "id": "677cc27e.bad8ec",
        "type": "function",
        "z": "2f0217a5.051978",
        "name": "save",
        "func": "var date = new Date();\nvar formated = context.global.moment(date).format('YYYYMMDD');\n\nvar orig = msg.originalMessage;\nvar lon = orig.reply_to_message.location.longitude;\nvar lat = orig.reply_to_message.location.latitude;\n\nvar chatId = msg.chatId;\n\nvar reg = {\n    query : {\n        // solo un fuego por usuario por ahora\n        chatId : chatId,\n        geo: {\n            type: \"Point\",\n            coordinates: [lon, lat]\n        }\n    },\n    payload: {\n        $set: {        \n            chatId: chatId,\n            when: date,\n            whendateformat: formated,\n            geo: {\n                type: \"Point\",\n                coordinates: [lon, lat]\n            }\n        }\n    },\n}\nreturn reg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1050,
        "y": 460,
        "wires": [
            [
                "88e9dc11.5af31"
            ]
        ]
    },
    {
        "id": "88e9dc11.5af31",
        "type": "mongodb out",
        "z": "2f0217a5.051978",
        "mongodb": "51a7af07.93444",
        "name": "insert",
        "collection": "falsepositives",
        "payonly": false,
        "upsert": true,
        "multi": false,
        "operation": "update",
        "x": 1210,
        "y": 460,
        "wires": []
    },
    {
        "id": "9f730cf9.c7a3b",
        "type": "subflow:2f0217a5.051978",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 590,
        "y": 920,
        "wires": [
            [
                "63a864bc.f82b1c"
            ]
        ]
    },
    {
        "id": "63a864bc.f82b1c",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "all",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 750,
        "y": 920,
        "wires": []
    },
    {
        "id": "ef71cdfb.1f93",
        "type": "debug",
        "z": "2f0217a5.051978",
        "name": "false positive entry",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 270,
        "y": 140,
        "wires": []
    },
    {
        "id": "ed07b302.7a6b7",
        "type": "function",
        "z": "2f0217a5.051978",
        "name": "thanks!",
        "func": "var t = msg.i18n;\n\nvar thx = {};\nthx.payload = {};\nthx.payload.type = \"message\";\nthx.payload.chatId = msg.chatId;\nthx.payload.content = t('üëå Tomamos nota, ¬°gracias por colaborar!');\nreturn thx;",
        "outputs": 1,
        "noerr": 0,
        "x": 1050,
        "y": 500,
        "wires": [
            [
                "eab4c7fe.fd7828"
            ]
        ]
    },
    {
        "id": "d7931057.66ab7",
        "type": "function",
        "z": "2f0217a5.051978",
        "name": "already!",
        "func": "var t = msg.i18n;\n\nvar thx = {};\nthx.payload = {};\nthx.payload.type = \"message\";\nthx.payload.chatId = msg.chatId;\nthx.payload.content = t(\"Ya marcaste este fuego como 'falso positivo'. Gracias en cualquier caso...\");\nreturn thx;",
        "outputs": 1,
        "noerr": 0,
        "x": 1060,
        "y": 340,
        "wires": [
            [
                "364970ea.3f564"
            ]
        ]
    },
    {
        "id": "d76ddf98.d3de9",
        "type": "function",
        "z": "2b8628df.fdcca8",
        "name": "false positive?",
        "func": "var query = {}\nquery.payload = {\n    geo:\n       { $near : {\n            $geometry: { \n                type: \"Point\",  \n                coordinates: [ msg.lon, msg.lat]\n            },\n            $minDistance: 0,\n            $maxDistance: 200\n          }\n       }\n   }\nquery.originalMessage = msg;\nreturn query;",
        "outputs": 1,
        "noerr": 0,
        "x": 220,
        "y": 240,
        "wires": [
            [
                "61abc532.9a0afc"
            ]
        ]
    },
    {
        "id": "61abc532.9a0afc",
        "type": "mongodb in",
        "z": "2b8628df.fdcca8",
        "mongodb": "51a7af07.93444",
        "name": "find",
        "collection": "falsepositives",
        "operation": "find",
        "x": 390,
        "y": 240,
        "wires": [
            [
                "9e65a744.1a6a68"
            ]
        ]
    },
    {
        "id": "9e65a744.1a6a68",
        "type": "function",
        "z": "2b8628df.fdcca8",
        "name": "false?",
        "func": "if (msg.payload.length > 0) {\n    // node.log(\"False positive\");\n    return [null, msg.originalMessage];\n} else {\n    // node.log(\"Not false positive\");\n    return [msg.originalMessage, null];\n}",
        "outputs": "2",
        "noerr": 0,
        "x": 530,
        "y": 240,
        "wires": [
            [
                "59c0890d.7d97e8"
            ],
            []
        ],
        "outputLabels": [
            "not false positive",
            "false"
        ]
    },
    {
        "id": "60fdfcd6.2a6d84",
        "type": "function",
        "z": "c644db46.3854c8",
        "name": "set location",
        "func": "msg.chatId = msg.payload.chatId;\nvar content = msg.payload.content;\nmsg.location = {};\n\nif (content && content.latitude) {\n    // Is a shared location (clip)\n    msg.location.lat = content.latitude;\n    msg.location.lon = content.longitude;\n    return [null, msg];\n} else {\n    // Is a writen location\n    msg.location.address = content;\n    return [msg, null];\n}",
        "outputs": "2",
        "noerr": 0,
        "x": 630,
        "y": 320,
        "wires": [
            [
                "9620588a.113218"
            ],
            []
        ],
        "outputLabels": [
            "address",
            "lat,lon already"
        ]
    },
    {
        "id": "f2c9762e.6c90a8",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "i18n conf",
        "func": "var i = context.global.i18next;\nvar backend = context.global.i18nextbackend;\n\nvar backOpts = {\n  // path where resources get loaded from\n  loadPath: global.get('conf-path') + './locales/{{lng}}/{{ns}}.json',\n\n  // path to post missing resources\n  addPath: global.get('conf-path') + './locales/{{lng}}/{{ns}}.missing.json',\n\n  // jsonIndent to use when storing json files\n  jsonIndent: 2\n};\n\ni.use(backend)\n .init({\n  backend: backOpts,\n  lng: 'es',\n  //fallbackLng: 'es',\n  fallbackLng: { \n    'en-US': ['en'], \n    'en-GB': ['en'],\n    'pt-BR': ['pt'],\n    'default': ['es']\n    },\n  whitelist: false,  \n  // whitelist: ['es', 'en'], // allowed languages\n  load: 'all', // es-ES -> es, en-US -> en\n  debug: false,\n  ns: 'telegram-bot',\n  defaultNS: 'telegram-bot',\n  saveMissing: false, // if true seems it's fails to getResourceBundle\n  saveMissingTo: 'all',\n  keySeparator: '√ü',\n  nsSeparator: '√∞',\n  pluralSeparator: 'ƒë',\n}, function(err, t) {\n    // initialized and ready to go!\n    const es = i.getFixedT('es');\n    const en = i.getFixedT('en');\n    const pt = i.getFixedT('pt');\n    const ast = i.getFixedT('ast');\n    const gl = i.getFixedT('gl');\n    global.set('lang-es', es);\n    global.set('lang-en', en);\n    global.set('lang-ast', ast);\n    global.set('lang-pt', pt);\n    global.set('lang-gl', gl);\n    i.loadLanguages(['es', 'en', 'pt', 'ast', 'gl'], function() {\n        // var t = global.get('lang-pt');\n        // node.log(t('S√≠'));\n    });\n});\n",
        "outputs": 1,
        "noerr": 0,
        "x": 960,
        "y": 80,
        "wires": [
            [
                "1f93ce66.41da62"
            ]
        ]
    },
    {
        "id": "1f93ce66.41da62",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "payl",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1110,
        "y": 80,
        "wires": []
    },
    {
        "id": "373aa2ef.0aac9e",
        "type": "subflow:e81a68fa.695e38",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 710,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "dd683e99.7c126",
        "type": "telegram sender",
        "z": "e81a68fa.695e38",
        "name": "",
        "bot": "f93d1a38.c43218",
        "x": 450,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "33cd0275.71172e",
        "type": "subflow:e81a68fa.695e38",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 1410,
        "y": 860,
        "wires": [
            []
        ]
    },
    {
        "id": "5541b1d7.23da4",
        "type": "function",
        "z": "6995c6a.1a0bf38",
        "name": "set i18n if not set",
        "func": "if (typeof msg.i18n === 'undefined') {\n    var current = msg.lang;\n    if (current.match(/^es/)) {\n        //node.log(\"Current language Spanish\");\n        msg.i18n = global.get('lang-es');\n    } else if (current.match(/^gl/)) {\n        // node.log(\"Current language Galego\");\n        msg.i18n = global.get('lang-gl');\n    } else if (current.match(/^en/)) {\n        // node.log(\"Current language English\");\n        msg.i18n = global.get('lang-en');\n    } else if (current.match(/^ast/)) {\n        // node.log(\"Current language Asturian\");\n        msg.i18n = global.get('lang-ast');\n    } else if (current.match(/^pt/)) {\n        // node.log(\"Current language Portuguese\");\n        msg.i18n = global.get('lang-pt');\n    }\n}\n\nif (typeof msg.i18n !== 'function') {\n    // fallback to Spanish\n    node.log(\"Fallback language Spanish\");\n    msg.i18n = global.get('lang-es');\n} else {\n    // node.log(\"i18n already configured\");\n} \n\n// console.assert(typeof msg.i18n === 'function', 'wooops problem setting i18n');\n\n// node.log(\"Type of i18n \" + typeof msg.i18n);\n\nreturn [msg, null]; ",
        "outputs": "1",
        "noerr": 0,
        "x": 310,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "f4470f67.a877d",
        "type": "delay",
        "z": "93cb4937.6fc068",
        "name": "rate",
        "pauseType": "rate",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 570,
        "y": 480,
        "wires": [
            [
                "1b848c63.4e2bf4"
            ]
        ]
    },
    {
        "id": "e9667844.7ff518",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "start opts",
        "func": "if (context.global.keyboardlang && context.global.keyboardlang.pending) {\n    // Lang response do nothing here\n} else {\n    var output = [];\n    var opt = msg.payload.content;\n    var t = msg.i18n;\n    // node.log(\"Type of i18n \" + typeof t);\n    \n    if (opt === \"/start@rednodetest_bot\") {\n      output[0] = msg; return output;\n    } else if (opt === \"/start@TodosContraElFuego_bot\") {\n      output[0] = msg; return output;\n    } else if (opt === \"/inicio@rednodetest_bot\") {\n      output[0] = msg; return output;\n    } else if (opt === \"/inicio\") {\n      output[0] = msg; return output;\n    } else if (opt === \"/inicio@TodosContraElFuego_bot\") {\n      output[0] = msg; return output;\n    } else if (opt === t(\"‚¨ÖÔ∏è Volver\")) {\n      output[0] = msg; return output;\n    } else if (opt === t(\"‚¨ÖÔ∏è Cancelar\")) {\n      output[0] = msg; return output;\n    } else if (opt === t(\"üì£ Suscribirme a fuegos en mi zona\")) {\n      output[1] = msg; return output;\n    } else if (opt === \"/suscribirme@rednodetest_bot\") {\n      output[1] = msg; return output;\n    } else if (opt === \"/suscribirme@TodosContraElFuego_bot\") {\n      output[1] = msg; return output;\n    } else if (opt === t(\"üìñ M√°s info\")) {\n      output[2] = msg; return output;\n    } else if (opt === t(\"‚ô• Apoya esta iniciativa\")) {\n      output[2] = msg; return output;\n    } else if (opt === t(\"üî• Notificar un fuego nuevo\")) {\n      output[3] = msg; return output;\n    } else if (opt === t(\"üìù Escribir mi posici√≥n\")) {\n      output[4] = msg; return output;\n    } else if (opt === t(\"üìù Escribir localizaci√≥n fuego\")) {\n      output[5] = msg; return output;\n    } else if ((opt + \"\").match(new RegExp(\"^(a |em |en |)[0-9]*[ ]*km( around| arredor|)\",'i'))) {\n      output[6] = msg; return output;\n    } else if (opt === t(\"üì£ Suscrito a nuevos fuegos\")) {\n      output[7] = msg; return output;\n    } else if (opt === \"/info@rednodetest_bot\") {\n      output[7] = msg; return output;\n    } else if (opt === \"/info@TodosContraElFuego_bot\") {\n      output[7] = msg; return output;\n    } else if (opt === \"/distancia@rednodetest_bot\") {\n      output[8] = msg; return output;\n    } else if (opt === \"/distancia@TodosContraElFuego_bot\") {\n      output[8] = msg; return output;\n    } else if (opt === t(\"üìç El fuego est√° en mi ubicaci√≥n\")) {\n      output[9] = msg; return output;\n    } else if ((opt + \"\").match(new RegExp(\"(falsa alarma|falso positivo|es una industria|industria)\",'i'))) {\n      output[10] = msg; return output;\n    } else if (opt === t(\"Desuscribirme\")) {\n      output[11] = msg; return output;\n    } else if (opt === \"/lang@rednodetest_bot\") {\n      output[12] = msg; return output;\n    } else if (opt === \"/lang@TodosContraElFuego_bot\") {\n      output[12] = msg; return output;\n    } else if (opt === \"/mylang\") {\n    } else if (opt === \"/lang\") {\n      // do nothing\n    } else {\n      output[13] = msg; return output;\n    }\n}",
        "outputs": "14",
        "noerr": 0,
        "x": 300,
        "y": 480,
        "wires": [
            [
                "55ebd8f8.436e38"
            ],
            [
                "be0cbd6.2efaf4"
            ],
            [
                "33879e8b.3151b2"
            ],
            [
                "1292920f.64d29e",
                "fa14bb16.1c3248",
                "cbe0e85b.a53018"
            ],
            [
                "f4470f67.a877d"
            ],
            [
                "60ee8a37.032aa4"
            ],
            [
                "82292481.dd9428"
            ],
            [
                "f3249bab.90eae8"
            ],
            [
                "539a53d4.268c7c"
            ],
            [
                "60ee8a37.032aa4"
            ],
            [
                "9f730cf9.c7a3b"
            ],
            [
                "529f65ba.a3f03c",
                "33879e8b.3151b2"
            ],
            [
                "e0417a.e678ee88"
            ],
            [
                "c37e7408.e43de8",
                "e0bc7e33.2a795"
            ]
        ],
        "outputLabels": [
            "start",
            "subscribe",
            "more info, desubscribe, support...",
            "Notify new fire",
            "Write my position",
            "Write fire position",
            "in n km",
            "info",
            "distance",
            "fire in my location",
            "false alarm",
            "desubscription",
            "lang",
            "others"
        ]
    },
    {
        "id": "11e83fb2.09a37",
        "type": "subflow:4384af8e.a7409",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 150,
        "y": 480,
        "wires": [
            [
                "e9667844.7ff518"
            ]
        ]
    },
    {
        "id": "9b7f71f8.cb024",
        "type": "inject",
        "z": "93cb4937.6fc068",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 100,
        "y": 980,
        "wires": [
            [
                "47a779c9.a8f538"
            ]
        ]
    },
    {
        "id": "47a779c9.a8f538",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "test cmd",
        "func": "var newmsg = {};\nnewmsg.payload = {};\nnewmsg.payload.content = \"‚ô• Apoya esta iniciativa\";\nnewmsg.payload.content = \"a 10 km\";\nnewmsg.originalMessage = {};\nnewmsg.originalMessage.from = {};\nnewmsg.originalMessage.from.language_code = \"es-ES\";\nreturn newmsg;\n            ",
        "outputs": 1,
        "noerr": 0,
        "x": 240,
        "y": 980,
        "wires": [
            []
        ]
    },
    {
        "id": "b3331045.d30b3",
        "type": "subflow:4384af8e.a7409",
        "z": "76bd701f.29d0f",
        "name": "",
        "x": 430,
        "y": 100,
        "wires": [
            [
                "f0552abc.9ccb78"
            ]
        ]
    },
    {
        "id": "4cd4a2cd.e15ecc",
        "type": "subflow:4384af8e.a7409",
        "z": "c644db46.3854c8",
        "x": 490,
        "y": 320,
        "wires": [
            [
                "60fdfcd6.2a6d84"
            ]
        ]
    },
    {
        "id": "bb4817df.01de48",
        "type": "subflow:4384af8e.a7409",
        "z": "93cb4937.6fc068",
        "x": 1510,
        "y": 480,
        "wires": [
            [
                "189c6a9b.aab975"
            ]
        ]
    },
    {
        "id": "6906bc92.3ea1d4",
        "type": "debug",
        "z": "128790f6.dee0df",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 1370,
        "y": 200,
        "wires": []
    },
    {
        "id": "20aeace7.594e64",
        "type": "function",
        "z": "128790f6.dee0df",
        "name": "current susc",
        "func": "var newMsg = {};\nnewMsg.notification = msg;\nnewMsg.payload = {};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 510,
        "y": 200,
        "wires": [
            [
                "6e448899.3af328"
            ]
        ]
    },
    {
        "id": "6e448899.3af328",
        "type": "mongodb in",
        "z": "128790f6.dee0df",
        "mongodb": "51a7af07.93444",
        "name": "find susc",
        "collection": "subscriptions",
        "operation": "find",
        "x": 700,
        "y": 200,
        "wires": [
            [
                "ace2d6f2.4362f8"
            ]
        ]
    },
    {
        "id": "ace2d6f2.4362f8",
        "type": "function",
        "z": "128790f6.dee0df",
        "name": "to who?",
        "func": "var who = global.get('sends-news-to');\nif ( who === 'all') {\n    return msg;\n} else {\n    var newMsg = {};\n    newMsg.payload = [];\n    newMsg.notification = msg.notification;\n    var sp = who.split(\",\");\n    for (var i = 0; i < sp.length; i++) {\n        var chatId = sp[i];\n        newMsg.payload[i] = { chatId: chatId };\n    }\n    return newMsg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 860,
        "y": 200,
        "wires": [
            [
                "199dadf2.46a4b2",
                "26b36dd6.0fc162"
            ]
        ]
    },
    {
        "id": "a5da0c46.379c6",
        "type": "function",
        "z": "128790f6.dee0df",
        "name": "ask confirmation",
        "func": "// var t = global.get(\"i18n-es\");\n// No internacionalizamos esta parte por ahora\n\ncontext.global.keyboard = { pending : true };\n\nvar opts = {\n  reply_to_message_id: msg.payload.messageId,\n  reply_markup: JSON.stringify({\n    \"inline_keyboard\": [[\n                {\n                    \"text\": 'S√≠',\n                    \"callback_data\": \"news_send\"\n                },\n                {\n                    \"text\": 'No',\n                    \"callback_data\": \"news_no_send\"\n                }]\n            ]\n  })\n};\n\nvar newMsg = {\n    payload : {\n        chatId: msg.payload.chatId,\n        type: 'message',\n        content: 'Vas a enviar estas novedades a todos los usuarios ¬øest√°s seguro?',\n        options: opts\n    }\n};\n\nglobal.set('notification', msg);\n\nreturn [newMsg, null];",
        "outputs": "1",
        "noerr": 0,
        "x": 1090,
        "y": 60,
        "wires": [
            [
                "9a57fc1b.84c16"
            ]
        ]
    },
    {
        "id": "4675b760.d24348",
        "type": "function",
        "z": "128790f6.dee0df",
        "name": "set send opts",
        "func": "msg.payload.type = \"message\";\nmsg.payload.options = {};\nmsg.payload.options.parse_mode = \"Markdown\";\nmsg.payload.options.disable_web_page_preview = true; \nmsg.payload.options.disable_notification = true;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 720,
        "y": 60,
        "wires": [
            [
                "6618aac1.2a3744",
                "4fe7fb99.30eb64"
            ]
        ]
    },
    {
        "id": "b4cf9be5.550978",
        "type": "function",
        "z": "128790f6.dee0df",
        "name": "test news",
        "func": "var news = {};\nnews.payload = {};\nnews.payload.content  = \"üì£ * Novedades de @TodosContraElFuego_bot *\\r\\n\";\nnews.payload.content += \"\\r\\n\";\nnews.payload.content += \"‚ûñ A veces habr√°s visto que llegan notificaciones de fuegos de industrias como incineradoras, sider√∫rgicas, refiner√≠as, etc. \"\nnews.payload.content += \"Ahora puedes ayudarnos a marcar estos 'falsos positivos'. Para ello pulsa en el mapa de la notificaci√≥n de uno de estos fuegos y pulsa 'Responder' con un mensaje que diga 'falso positivo' o 'industria' para que estos fuegos no sean notificados en un futuro. Gracias.\\r\\n\";\nnews.payload.content += \"‚ûñ Estamos traduciendo este bot al asturiano, gallego, ingl√©s, portugu√©s, etc. Puedes participar [en la traducci√≥n](https://translate.comunes.org/projects/todos-contra-el-fuego/todoscontraelfuego_bot/).\\r\\n\";\nnews.payload.content += \"‚ûñ A petici√≥n de usuarios/amigos de Latinoam√©rica, ahora procesamos alertas de fuegos tambi√©n de otras partes del mundo, no solo Europa.\\r\\n\";\n// this is me, for preview:\nnews.payload.chatId = 4885772;\nreturn news;",
        "outputs": 1,
        "noerr": 0,
        "x": 530,
        "y": 60,
        "wires": [
            [
                "4675b760.d24348"
            ]
        ]
    },
    {
        "id": "b2a86687.974fc8",
        "type": "inject",
        "z": "128790f6.dee0df",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 120,
        "y": 60,
        "wires": [
            [
                "903240b.81669c"
            ]
        ]
    },
    {
        "id": "903240b.81669c",
        "type": "delay",
        "z": "128790f6.dee0df",
        "name": "rate 1x1m",
        "pauseType": "rate",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "30",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 310,
        "y": 60,
        "wires": [
            [
                "b4cf9be5.550978"
            ]
        ]
    },
    {
        "id": "765837ba.bc31e8",
        "type": "function",
        "z": "128790f6.dee0df",
        "name": "answer confirm",
        "func": "// Not translated right now\n// var t = msg.i18n;\n\nvar show_alert = false; // you can set this to true to open a dialog with the answer in the client.\nvar notification = global.get('notification');\n\nif (notification !== null) {\n    // node.log(\"Notification callback\");\n    msg.payload.options = show_alert;\n    \n    global.set('notification', null);\n    // msg.payload.content contains the callback data from the keyboard.\n    if (msg.payload.content === 'news_send') {\n        return [notification, null];\n    } else if (msg.payload.content === 'news_no_send') {\n        var newMsg = {\n            payload: {\n                type: \"message\",\n                content: 'Notificaci√≥n cancelada',\n                chatId: msg.payload.chatId\n            }\n        };\n        return [null, newMsg];\n    }\n}",
        "outputs": "2",
        "noerr": 0,
        "x": 300,
        "y": 200,
        "wires": [
            [
                "20aeace7.594e64"
            ],
            [
                "df3bdc0f.4cd2f"
            ]
        ],
        "outputLabels": [
            "notification",
            "No"
        ]
    },
    {
        "id": "df3bdc0f.4cd2f",
        "type": "telegram sender",
        "z": "128790f6.dee0df",
        "name": "send",
        "bot": "f93d1a38.c43218",
        "x": 490,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "6618aac1.2a3744",
        "type": "telegram sender",
        "z": "128790f6.dee0df",
        "name": "send",
        "bot": "f93d1a38.c43218",
        "x": 910,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "9a57fc1b.84c16",
        "type": "telegram sender",
        "z": "128790f6.dee0df",
        "name": "send",
        "bot": "f93d1a38.c43218",
        "x": 1270,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "74385b88.39eb04",
        "type": "telegram callback_query",
        "z": "128790f6.dee0df",
        "name": "callback",
        "command": "",
        "bot": "f93d1a38.c43218",
        "x": 100,
        "y": 200,
        "wires": [
            [
                "765837ba.bc31e8"
            ]
        ]
    },
    {
        "id": "4fe7fb99.30eb64",
        "type": "delay",
        "z": "128790f6.dee0df",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 900,
        "y": 60,
        "wires": [
            [
                "a5da0c46.379c6"
            ]
        ]
    },
    {
        "id": "977bb03b.dc94f",
        "type": "delay",
        "z": "128790f6.dee0df",
        "name": "rate 1x2s",
        "pauseType": "rate",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "2",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 1220,
        "y": 260,
        "wires": [
            [
                "bd6813b1.2cab5"
            ]
        ]
    },
    {
        "id": "bd6813b1.2cab5",
        "type": "delay",
        "z": "128790f6.dee0df",
        "name": "rate 10x1m",
        "pauseType": "rate",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "10",
        "nbRateUnits": "1",
        "rateUnits": "minute",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 1250,
        "y": 340,
        "wires": [
            [
                "bff4fef3.9fe3e"
            ]
        ]
    },
    {
        "id": "49f7750c.76675c",
        "type": "telegram sender",
        "z": "128790f6.dee0df",
        "name": "send",
        "bot": "f93d1a38.c43218",
        "x": 1590,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "199dadf2.46a4b2",
        "type": "function",
        "z": "128790f6.dee0df",
        "name": "send to all",
        "func": "var noti = msg.notification;\nfor (var i = 0; i < msg.payload.length; i++) {\n    var chatId = msg.payload[i].chatId;\n    noti.payload.chatId = chatId;\n    if (noti.payload.content === 'empty') {\n        noti.payload.content = '';\n    }\n    if (chatId !== 9998999) {  // test chatId\n        node.send(noti);\n    }\n}\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1030,
        "y": 200,
        "wires": [
            [
                "d5cbb344.cf8db",
                "977bb03b.dc94f"
            ]
        ]
    },
    {
        "id": "152ee632.13c3fa",
        "type": "comment",
        "z": "93cb4937.6fc068",
        "name": "Warning: Listeners like /commands in subflows can be duplicated",
        "info": "",
        "x": 270,
        "y": 1140,
        "wires": []
    },
    {
        "id": "9d03d653.8cca68",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "lang response",
        "func": "if (context.global.keyboardlang && context.global.keyboardlang.pending) {\n    var langs = {\n        'Asturianu': 'ast',\n        'Catal√†': 'ca',\n        'Espa√±ol': 'es',\n        'English': 'en',\n        'Galego': 'gl',\n        'Portugu√™s': 'pt',\n        'Portugu√™s do Brasil': 'pt_BR'\n        // Euskara\n    };\n    \n    if (msg.payload.content.match(/(Asturianu)|(Espa√±ol)|(English)|(Galego)|(Portugu√™s)|(Portugu√™s do Brasil)/i)) {\n        msg.lang = langs[msg.payload.content];\n        \n        // For start menu:\n        msg.payload.content = '';\n        return [msg, null];   \n    } else\n    {\n        return [null, msg];   \n    }\n}\n",
        "outputs": "2",
        "noerr": 0,
        "x": 480,
        "y": 1260,
        "wires": [
            [
                "f6fa435d.52b8f",
                "bb1ffea3.4e9f4"
            ],
            [
                "1475a6c1.176199"
            ]
        ],
        "outputLabels": [
            "correct answer",
            "incorrect answer"
        ]
    },
    {
        "id": "1475a6c1.176199",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "wrong answer ignore",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 740,
        "y": 1320,
        "wires": []
    },
    {
        "id": "f6fa435d.52b8f",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "update user",
        "func": "var orig = msg.originalMessage;\n\ncontext.global.keyboardlang.pending = false;\n \nvar update = {\n    query : {\n        // No busca bien con _id, \n        // duplicamos chatId\n        telegramChatId : msg.payload.chatId \n    },\n    payload: {\n       $set: {        \n           telegramChatId : msg.payload.chatId,\n           telegramUsername : orig.from.username,\n           telegramFirstName : orig.from.first_name,\n           telegramLanguageCode : orig.from.language_code,\n           lang : msg.lang,\n           updated: new Date()\n       }\n    },\n    i18n: msg.i18n\n};\n\nreturn update;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 790,
        "y": 1260,
        "wires": [
            [
                "fed0561d.343aa8",
                "1b51742a.93af1c"
            ]
        ]
    },
    {
        "id": "fed0561d.343aa8",
        "type": "mongodb out",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "update user",
        "collection": "users",
        "payonly": false,
        "upsert": true,
        "multi": false,
        "operation": "update",
        "x": 1010,
        "y": 1260,
        "wires": []
    },
    {
        "id": "1b51742a.93af1c",
        "type": "Cache out",
        "z": "93cb4937.6fc068",
        "name": "users-lang-in",
        "cache": "488013b6.1183ec",
        "keyType": "msg",
        "keyProperty": "payload.$set.telegramChatId",
        "valueType": "msg",
        "valueProperty": "payload.$set.lang",
        "ttlType": "msg",
        "ttlProperty": "",
        "useString": false,
        "x": 1010,
        "y": 1320,
        "wires": []
    },
    {
        "id": "bb1ffea3.4e9f4",
        "type": "subflow:465e67f.6ebf598",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 980,
        "y": 1180,
        "wires": []
    },
    {
        "id": "81be2f6c.56aa8",
        "type": "function",
        "z": "4384af8e.a7409",
        "name": "user? no:ask-lang",
        "func": "if (msg.payload.length === 0) {\n    msg.payload = msg.originalPayload;\n    return [msg, null];\n} else {\n    // user register\n    var lang = msg.payload[0].lang;\n    msg.payload = msg.originalPayload;\n    msg.lang = lang;\n    return [null, msg];\n}\n\n",
        "outputs": "2",
        "noerr": 0,
        "x": 1370,
        "y": 60,
        "wires": [
            [
                "4e79d201.8c93bc"
            ],
            [
                "c46a6a2.a934698",
                "e11dde1f.ea412"
            ]
        ],
        "outputLabels": [
            "ask",
            "we have lang"
        ]
    },
    {
        "id": "6173b8ee.c73038",
        "type": "Cache in",
        "z": "4384af8e.a7409",
        "name": "users-lang-out",
        "cache": "488013b6.1183ec",
        "keyType": "msg",
        "keyProperty": "chatId",
        "valueType": "msg",
        "valueProperty": "lang",
        "useString": false,
        "x": 640,
        "y": 100,
        "wires": [
            [
                "6b27a3a5.4208dc"
            ]
        ]
    },
    {
        "id": "5ade250d.5e12fc",
        "type": "function",
        "z": "4384af8e.a7409",
        "name": "query user",
        "func": "msg.chatId = msg.payload.chatId;\nmsg.payload = {\"telegramChatId\": msg.chatId };\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1010,
        "y": 60,
        "wires": [
            [
                "8f334917.ef75c8"
            ]
        ]
    },
    {
        "id": "8f334917.ef75c8",
        "type": "mongodb in",
        "z": "4384af8e.a7409",
        "mongodb": "51a7af07.93444",
        "name": "find users",
        "collection": "users",
        "operation": "find",
        "x": 1180,
        "y": 60,
        "wires": [
            [
                "81be2f6c.56aa8"
            ]
        ]
    },
    {
        "id": "6b27a3a5.4208dc",
        "type": "function",
        "z": "4384af8e.a7409",
        "name": "no cached?",
        "func": "if (typeof msg.lang === 'undefined'  || msg.lang === null) {\n    // node.log(\"Lang no cached\");\n    return [msg, null];\n} else {\n    // node.log(\"Lang cached\");\n    return [null, msg];\n}",
        "outputs": "2",
        "noerr": 0,
        "x": 810,
        "y": 100,
        "wires": [
            [
                "5ade250d.5e12fc"
            ],
            [
                "c46a6a2.a934698"
            ]
        ],
        "outputLabels": [
            "no cached",
            "cached"
        ]
    },
    {
        "id": "faffc082.4386a",
        "type": "telegram receiver",
        "z": "93cb4937.6fc068",
        "name": "",
        "bot": "f93d1a38.c43218",
        "saveDataDir": "",
        "x": 120,
        "y": 1260,
        "wires": [
            [
                "9d03d653.8cca68"
            ],
            [
                "43864735.d1af38"
            ]
        ]
    },
    {
        "id": "57e40a1.1461bf4",
        "type": "debug",
        "z": "4384af8e.a7409",
        "name": "keyboard active!",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 480,
        "y": 140,
        "wires": []
    },
    {
        "id": "43864735.d1af38",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 310,
        "y": 1340,
        "wires": []
    },
    {
        "id": "e2e4dfd1.88c4b",
        "type": "debug",
        "z": "4384af8e.a7409",
        "name": "chatId",
        "active": true,
        "console": "false",
        "complete": "payload.chatId",
        "x": 450,
        "y": 180,
        "wires": []
    },
    {
        "id": "afdf0d2.1f75ef",
        "type": "function",
        "z": "4384af8e.a7409",
        "name": "set chatId",
        "func": "if (context.global.keyboardlang && context.global.keyboardlang.pending) {\n  // do nothing   \n  return [null, msg]\n} else {\n    msg.chatId = msg.payload.chatId;\n    msg.originalPayload = msg.payload;\n    flow.set('payload-assert', msg.payload);\n    flow.set('payload-chatId', msg.chatId);\n    return [msg, null];\n}",
        "outputs": "2",
        "noerr": 0,
        "x": 300,
        "y": 100,
        "wires": [
            [
                "edb02cb3.e23b7"
            ],
            [
                "57e40a1.1461bf4"
            ]
        ],
        "outputLabels": [
            "continue",
            "do nothing"
        ]
    },
    {
        "id": "a2c7e3af.c055f",
        "type": "telegram sender",
        "z": "e6f3db8c.48eac8",
        "name": "send",
        "bot": "f93d1a38.c43218",
        "x": 590,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "4091f971.ce23f8",
        "type": "function",
        "z": "e6f3db8c.48eac8",
        "name": "ask-lang",
        "func": "context.global.keyboardlang = { pending : true };\n// no user\nvar opts = {\n    disable_notification : true,\n    // reply_to_message_id: msg.payload.messageId,\n    reply_markup: JSON.stringify({\n        keyboard: [ \n            [{text: 'Asturianu'}, {text: 'Espa√±ol'}, ],\n            [{text: 'English'}, {text: 'Galego'}, ],\n            [{text: 'Portugu√™s'}, /* {text: 'Portugu√™s do Brasil'}, */ ]\n            ],\n      'resize_keyboard' : true, \n      'one_time_keyboard' : true\n      \n    })\n};\nmsg.payload.chatId = msg.payload.chatId? msg.payload.chatId : msg.chatId;\nmsg.payload.type = \"message\";\nmsg.payload.content = 'Escoge tu idioma / Choose your language:';\nmsg.payload.options = opts;\nreturn [msg, null];\n",
        "outputs": "2",
        "noerr": 0,
        "x": 260,
        "y": 100,
        "wires": [
            [
                "3d9b789b.37b188"
            ],
            []
        ],
        "outputLabels": [
            "ask",
            "we have lang"
        ]
    },
    {
        "id": "f47aa14b.72c2b",
        "type": "telegram command",
        "z": "93cb4937.6fc068",
        "name": "/lang",
        "command": "/lang",
        "bot": "f93d1a38.c43218",
        "x": 90,
        "y": 1180,
        "wires": [
            [
                "5e792abd.c19084"
            ],
            []
        ]
    },
    {
        "id": "5e792abd.c19084",
        "type": "subflow:e6f3db8c.48eac8",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 385,
        "y": 1180,
        "wires": []
    },
    {
        "id": "4e79d201.8c93bc",
        "type": "subflow:e6f3db8c.48eac8",
        "z": "4384af8e.a7409",
        "name": "",
        "x": 1580,
        "y": 60,
        "wires": []
    },
    {
        "id": "69a62d00.26b314",
        "type": "subflow:4384af8e.a7409",
        "z": "93cb4937.6fc068",
        "x": 1250,
        "y": 640,
        "wires": [
            [
                "5b42be73.7ac18",
                "fdba8b7a.1a1b08"
            ]
        ]
    },
    {
        "id": "b8099eb5.315a1",
        "type": "function",
        "z": "2b8628df.fdcca8",
        "name": "is lang set?",
        "func": "if (msg.payload.length === 0) {\n    // fallback\n    msg.lang = 'es';\n    msg.payload = msg.originalPayload;\n    return [msg, null];\n} else {\n    // user register\n    var lang = msg.payload[0].lang;\n    msg.payload = msg.originalPayload;\n    msg.lang = lang;\n    return [null, msg];\n}\n\n",
        "outputs": "2",
        "noerr": 0,
        "x": 2010,
        "y": 200,
        "wires": [
            [
                "6f05d6e0.346e98"
            ],
            [
                "6f05d6e0.346e98"
            ]
        ],
        "outputLabels": [
            "ask",
            "we have lang"
        ]
    },
    {
        "id": "1e94769b.4a6099",
        "type": "mongodb in",
        "z": "2b8628df.fdcca8",
        "mongodb": "51a7af07.93444",
        "name": "find users",
        "collection": "users",
        "operation": "find",
        "x": 1840,
        "y": 200,
        "wires": [
            [
                "b8099eb5.315a1"
            ]
        ]
    },
    {
        "id": "89857846.7f0968",
        "type": "function",
        "z": "2b8628df.fdcca8",
        "name": "query user",
        "func": "msg.chatId = msg.payload.chatId;\nmsg.originalPayload = msg.payload;\nmsg.payload = {\"telegramChatId\": msg.chatId };\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1670,
        "y": 200,
        "wires": [
            [
                "1e94769b.4a6099"
            ]
        ]
    },
    {
        "id": "999d94d.8b58768",
        "type": "function",
        "z": "2b8628df.fdcca8",
        "name": "no cached?",
        "func": "if (typeof msg.lang === 'undefined'  || msg.lang === null) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}",
        "outputs": "2",
        "noerr": 0,
        "x": 1470,
        "y": 240,
        "wires": [
            [
                "89857846.7f0968"
            ],
            [
                "6f05d6e0.346e98"
            ]
        ],
        "outputLabels": [
            "no cached",
            "cached"
        ]
    },
    {
        "id": "bd354f75.34da3",
        "type": "Cache in",
        "z": "2b8628df.fdcca8",
        "name": "users-lang-out",
        "cache": "488013b6.1183ec",
        "keyType": "msg",
        "keyProperty": "payload.chatId",
        "valueType": "msg",
        "valueProperty": "lang",
        "useString": true,
        "x": 1260,
        "y": 240,
        "wires": [
            [
                "999d94d.8b58768"
            ]
        ]
    },
    {
        "id": "1986ad37.928233",
        "type": "split",
        "z": "2b8628df.fdcca8",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 1070,
        "y": 240,
        "wires": [
            [
                "bd354f75.34da3"
            ]
        ]
    },
    {
        "id": "6f05d6e0.346e98",
        "type": "function",
        "z": "2b8628df.fdcca8",
        "name": "join",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2170,
        "y": 240,
        "wires": [
            [
                "2a9cd9af.ae25c6"
            ]
        ]
    },
    {
        "id": "e39f3d19.34c0f",
        "type": "subflow:6995c6a.1a0bf38",
        "z": "4384af8e.a7409",
        "name": "",
        "x": 1780,
        "y": 240,
        "wires": [
            [
                "1586a4b5.782b9b"
            ]
        ]
    },
    {
        "id": "2a9cd9af.ae25c6",
        "type": "subflow:6995c6a.1a0bf38",
        "z": "2b8628df.fdcca8",
        "x": 2340,
        "y": 240,
        "wires": [
            [
                "1041069a.2c84b9"
            ]
        ]
    },
    {
        "id": "b47755bb.64af48",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "save",
        "func": "var date = new Date();\nvar formated = context.global.moment(date).format('YYYYMMDD');\nvar lon = msg.location.lon;\nvar lat = msg.location.lat;\nvar text = msg.location.text;\n\nvar chatId = msg.payload.chatId;\n\nvar newMsg = {\n    query : {\n        // solo un fuego por usuario por ahora\n        chatId : chatId \n    },\n    payload: {\n       $set: {        \n    location: {\n        lat: lat,\n        lon: lon,\n        text: text // msg.address\n    },\n    // _id: msg.chatId,\n    chatId: msg.chatId,\n    aviso: date,\n    dateformat: formated,\n    geo: {\n        type: \"Point\",\n        coordinates: [lon, lat]\n    }\n    }\n    },\n    location: {\n        lat: lat,\n        lon: lon\n    },\n    chatId: chatId,\n    \n}\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 1560,
        "wires": [
            [
                "3980d36e.8c5dfc",
                "585ace97.26933"
            ]
        ]
    },
    {
        "id": "3980d36e.8c5dfc",
        "type": "mongodb out",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "save fuego",
        "collection": "avisosfuego",
        "payonly": false,
        "upsert": true,
        "multi": false,
        "operation": "update",
        "x": 970,
        "y": 1560,
        "wires": []
    },
    {
        "id": "76cd31f0.40e6",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "inc fuegos",
        "func": "var day = context.global.moment.utc().dayOfYear();\n\nvar newMsg = {\n    query : {\n        day: day,\n        name: \"numfuegos\"\n    },\n    payload: {\n        $inc: { value: 1 }\n    }\n};\n\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 710,
        "y": 1520,
        "wires": [
            [
                "b9afc1e.d78db4"
            ]
        ]
    },
    {
        "id": "b9afc1e.d78db4",
        "type": "mongodb out",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "update stats",
        "collection": "fstats",
        "payonly": false,
        "upsert": true,
        "multi": false,
        "operation": "update",
        "x": 970,
        "y": 1520,
        "wires": []
    },
    {
        "id": "f7be44bd.5d84f8",
        "type": "telegram callback_query",
        "z": "93cb4937.6fc068",
        "name": "callback_query",
        "command": "",
        "bot": "f93d1a38.c43218",
        "x": 120,
        "y": 1480,
        "wires": [
            [
                "b81751c6.f7b84",
                "e75ad8bd.147e48"
            ]
        ]
    },
    {
        "id": "4964dee.a0c6e2",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "answer confirm",
        "func": "var t = msg.i18n;\n\nvar show_alert = false; // you can set this to true to open a dialog with the answer in the client.\n\nmsg.payload.options = show_alert;\nvar key = 'location-' + msg.payload.chatId;\nvar location = global.get(key);\n\nif (location !== null) {\n    // node.log(\"Location confirm callback\");\n    global.set(key, null);\n    // msg.payload.content contains the callback data from the keyboard.\n    if (msg.payload.content === 'notify_fire') {\n        // msg.payload.content = i.t('üì£ Alerta recibida, ¬°gracias!');\n        msg.payload.content = t('üì£ Alerta recibida, ¬°gracias!');\n        // node.log(location.payload.content);\n        return [msg, location, null];\n    } else if (msg.payload.content === 'no_notify_fire') {\n        var newMsg = {\n            payload: {\n                type: \"message\",\n                content: t('Aviso cancelado'),\n                chatId: msg.payload.chatId\n            },\n            i18n: t\n        };\n        return [null, null, newMsg];\n    }\n}",
        "outputs": "3",
        "noerr": 0,
        "x": 480,
        "y": 1480,
        "wires": [
            [
                "a1aac5f6.cf0228",
                "9cc764dc.591728"
            ],
            [
                "76cd31f0.40e6",
                "b47755bb.64af48",
                "b19e4ad8.90f058"
            ],
            [
                "a1aac5f6.cf0228"
            ]
        ],
        "outputLabels": [
            "S√≠",
            "Location",
            "No"
        ]
    },
    {
        "id": "a1aac5f6.cf0228",
        "type": "subflow:c6a40c11.dfc6b",
        "z": "93cb4937.6fc068",
        "x": 770,
        "y": 1480,
        "wires": []
    },
    {
        "id": "e75ad8bd.147e48",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "previous confirm",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 390,
        "y": 1560,
        "wires": []
    },
    {
        "id": "311b07de.9a7238",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "send notis!",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 870,
        "y": 1700,
        "wires": []
    },
    {
        "id": "6fe5f874.cf4978",
        "type": "subflow:2b8628df.fdcca8",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 990,
        "y": 1640,
        "wires": []
    },
    {
        "id": "b19e4ad8.90f058",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "args",
        "func": "var newMsg = {\n    type: \"vecinal\",\n    lon: msg.location.lon,\n    lat: msg.location.lat\n}\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 1640,
        "wires": [
            [
                "311b07de.9a7238",
                "6fe5f874.cf4978"
            ]
        ]
    },
    {
        "id": "585ace97.26933",
        "type": "subflow:d29a1c6a.5a89e",
        "z": "93cb4937.6fc068",
        "x": 990,
        "y": 1600,
        "wires": []
    },
    {
        "id": "2ccdf622.74c9ba",
        "type": "comment",
        "z": "93cb4937.6fc068",
        "name": "location attached is received also in the switch",
        "info": "",
        "x": 210,
        "y": 1420,
        "wires": []
    },
    {
        "id": "b81751c6.f7b84",
        "type": "subflow:4384af8e.a7409",
        "z": "93cb4937.6fc068",
        "x": 310,
        "y": 1480,
        "wires": [
            [
                "4964dee.a0c6e2",
                "e75ad8bd.147e48"
            ]
        ]
    },
    {
        "id": "9524e182.148b2",
        "type": "debug",
        "z": "2b8628df.fdcca8",
        "name": "positive?",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 450,
        "y": 160,
        "wires": []
    },
    {
        "id": "fbdce741.552298",
        "type": "debug",
        "z": "2b8628df.fdcca8",
        "name": "positive result",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 540,
        "y": 320,
        "wires": []
    },
    {
        "id": "74a88d3a.e6fe64",
        "type": "debug",
        "z": "2b8628df.fdcca8",
        "name": "users near?",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 1090,
        "y": 180,
        "wires": []
    },
    {
        "id": "50bb0492.b20fbc",
        "type": "debug",
        "z": "2b8628df.fdcca8",
        "name": "user near",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 1240,
        "y": 280,
        "wires": []
    },
    {
        "id": "d1901604.d1e3a8",
        "type": "debug",
        "z": "2b8628df.fdcca8",
        "name": "user result",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 2330,
        "y": 180,
        "wires": []
    },
    {
        "id": "3eff4b32.9114b4",
        "type": "subflow:465e67f.6ebf598",
        "z": "128790f6.dee0df",
        "x": 1600,
        "y": 400,
        "wires": []
    },
    {
        "id": "c60831ef.7bc3a",
        "type": "function",
        "z": "1bbd6687.58eae9",
        "name": "geo?",
        "func": "var t = msg.i18n;\nif (msg.status === 'OK') {\n    return [msg, null];\n} else {\n    var noti = {};\n    noti.payload = {};\n    noti.payload.chatId = msg.chatId;\n    noti.payload.type = \"message\";\n    noti.i18n = msg.i18n;\n    noti.payload.content = t(\"Lo siento, no podemos localizar ese lugar\");\n    return [null, noti];\n}",
        "outputs": "2",
        "noerr": 0,
        "x": 250,
        "y": 80,
        "wires": [
            [],
            [
                "1c7bb3.5a30b44e"
            ]
        ],
        "outputLabels": [
            "geo",
            "failed to geo"
        ]
    },
    {
        "id": "1c7bb3.5a30b44e",
        "type": "subflow:c6a40c11.dfc6b",
        "z": "1bbd6687.58eae9",
        "x": 390,
        "y": 180,
        "wires": []
    },
    {
        "id": "b9c8c0db.ee0be",
        "type": "subflow:1bbd6687.58eae9",
        "z": "c644db46.3854c8",
        "name": "",
        "x": 930,
        "y": 320,
        "wires": [
            [
                "6d492c2d.a26024"
            ]
        ]
    },
    {
        "id": "daebf6ef.f07908",
        "type": "subflow:1bbd6687.58eae9",
        "z": "93cb4937.6fc068",
        "x": 1610,
        "y": 540,
        "wires": [
            [
                "70cddff9.2dbfb"
            ]
        ]
    },
    {
        "id": "d5cbb344.cf8db",
        "type": "function",
        "z": "128790f6.dee0df",
        "name": "counter",
        "func": "c = context.get('counter') || 0;\nc += 1;\ncontext.set('counter', c);\n\nnode.status({fill:\"green\",shape:\"ring\",text:c});\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1220,
        "y": 200,
        "wires": [
            [
                "6906bc92.3ea1d4",
                "c3cd9894.0f4098"
            ]
        ]
    },
    {
        "id": "2e950a20.784d56",
        "type": "inject",
        "z": "5501c3cc.11327c",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 140,
        "y": 120,
        "wires": [
            [
                "36d5ed85.92faa2"
            ]
        ]
    },
    {
        "id": "36d5ed85.92faa2",
        "type": "function",
        "z": "5501c3cc.11327c",
        "name": "counter no reset",
        "func": "c = context.get('counter') || 0;\nc += 1;\ncontext.set('counter', c);\n\nnode.status({fill:\"green\",shape:\"dot\",text:c});\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 370,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "90683393.0463b",
        "type": "function",
        "z": "5501c3cc.11327c",
        "name": "detect lang change",
        "func": "if (msg.payload.content &&\n    msg.payload.content.match(/^[‚ô•‚¨ÖÔ∏èüìñüì£üî•üì£üìùüìçüìù]+ .*/)) {\n    node.log(\"Detect lang changed\");\n    return [null, msg];\n}\nelse \n    return [msg, null];",
        "outputs": "2",
        "noerr": 0,
        "x": 750,
        "y": 160,
        "wires": [
            [],
            [
                "d1767c0c.2aaad",
                "54be8ab0.25fa74"
            ]
        ]
    },
    {
        "id": "54be8ab0.25fa74",
        "type": "debug",
        "z": "5501c3cc.11327c",
        "name": "all",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 990,
        "y": 200,
        "wires": []
    },
    {
        "id": "d1767c0c.2aaad",
        "type": "subflow:76bd701f.29d0f",
        "z": "5501c3cc.11327c",
        "x": 990,
        "y": 160,
        "wires": []
    },
    {
        "id": "59bde767.a4c4a8",
        "type": "function",
        "z": "5501c3cc.11327c",
        "name": "test something",
        "func": "",
        "outputs": 1,
        "noerr": 0,
        "x": 360,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "427cb9c9.0ef938",
        "type": "inject",
        "z": "5501c3cc.11327c",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 120,
        "y": 480,
        "wires": [
            [
                "59bde767.a4c4a8"
            ]
        ]
    },
    {
        "id": "77e79521.bcb3bc",
        "type": "function",
        "z": "5501c3cc.11327c",
        "name": "use lang",
        "func": "var en = msg.i18n;\nnode.log(\"en: \" + typeof en + \" \" + en('Desuscribirme'));\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 580,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "4be8c098.1e6e5",
        "type": "comment",
        "z": "93cb4937.6fc068",
        "name": "lang response",
        "info": "",
        "x": 110,
        "y": 1320,
        "wires": []
    },
    {
        "id": "e2d3ccae.d4b75",
        "type": "comment",
        "z": "93cb4937.6fc068",
        "name": "new fire response",
        "info": "",
        "x": 130,
        "y": 1540,
        "wires": []
    },
    {
        "id": "885ee90f.2464f8",
        "type": "comment",
        "z": "95e78a8b.50a428",
        "name": "users notifications are removed everyday",
        "info": "",
        "x": 300,
        "y": 160,
        "wires": []
    },
    {
        "id": "9b050a0a.961c38",
        "type": "function",
        "z": "5501c3cc.11327c",
        "name": "on/off",
        "func": "var c = context.get('switch') || false;\n\nvar update = function (c) {\n    node.status({fill:c? \"green\": \"red\",shape: c? \"dot\":\"ring\", text: c? \"on\": \"off\"});\n}\n\nif (msg.payload.switch) {\n    c = !c;\n    context.set('switch', c);\n    update(c);\n} else {\n    update(c);\n    if (c) {\n        return msg;\n    }    \n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 510,
        "y": 600,
        "wires": [
            [
                "785425b4.1d028c"
            ]
        ]
    },
    {
        "id": "6ade62.c8bf51a",
        "type": "inject",
        "z": "5501c3cc.11327c",
        "name": "on/off",
        "topic": "",
        "payload": "{\"switch\":true}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 330,
        "y": 540,
        "wires": [
            [
                "9b050a0a.961c38"
            ]
        ]
    },
    {
        "id": "8b3df4e9.c08ec8",
        "type": "inject",
        "z": "5501c3cc.11327c",
        "name": "",
        "topic": "",
        "payload": "Hello!",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 330,
        "y": 600,
        "wires": [
            [
                "9b050a0a.961c38"
            ]
        ]
    },
    {
        "id": "785425b4.1d028c",
        "type": "debug",
        "z": "5501c3cc.11327c",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 650,
        "y": 600,
        "wires": []
    },
    {
        "id": "16c436c8.0c8dc9",
        "type": "subflow:4384af8e.a7409",
        "z": "93cb4937.6fc068",
        "x": 430,
        "y": 1060,
        "wires": [
            [
                "7d6a8c23.8b1694"
            ]
        ]
    },
    {
        "id": "35d1de38.e04672",
        "type": "subflow:4384af8e.a7409",
        "z": "93cb4937.6fc068",
        "x": 270,
        "y": 800,
        "wires": [
            [
                "829ed9c9.8cd588"
            ]
        ]
    },
    {
        "id": "269ca556.b7a1ba",
        "type": "subflow:4384af8e.a7409",
        "z": "93cb4937.6fc068",
        "x": 320,
        "y": 680,
        "wires": [
            [
                "1292920f.64d29e"
            ]
        ]
    },
    {
        "id": "3abe9bb7.e50244",
        "type": "tcp in",
        "z": "557e0255.d1220c",
        "name": "test :6789 ",
        "server": "server",
        "host": "",
        "port": "6789",
        "datamode": "stream",
        "datatype": "utf8",
        "newline": "\\n",
        "topic": "",
        "base64": false,
        "x": 120,
        "y": 80,
        "wires": [
            [
                "95b8009f.b410c",
                "e2056e63.a9e84"
            ]
        ]
    },
    {
        "id": "95b8009f.b410c",
        "type": "function",
        "z": "557e0255.d1220c",
        "name": "input msg test",
        "func": "var chatId = 9998999;\nvar rec = msg.payload;\n\nmsg.payload = {\n    \"chatId\": chatId,\n    \"messageId\":99999,\n    \"type\": \"message\",\n    \"content\":\"\"\n    };\nmsg.originalMessage = {\n    \"message_id\":99999,\n    \"from\": {\n        \"id\": chatId,\n        \"is_bot\":false,\n        \"first_name\":\"testnick\",\n        \"username\":\"test_nick\",\n        \"language_code\": \"es-ES\"},\n        \"chat\": {\n            \"id\": chatId,\n            \"first_name\":\"testnick\",\n            \"username\": \"test_nick\",\n            \"type\": \"private\"\n        },\"date\":1510102651,\n        \"text\": rec,\n        \"entities\":[{\"offset\":0,\"length\":6,\"type\":\"bot_command\"}]\n};\n\nif (rec === \"/start\") {\n    context.global.keyboardlang = { pending : false };\n    return [msg, null, null, null];\n} else if (rec === \"/lang\") {\n    context.global.keyboardlang = { pending : false };\n    return [null, msg, null, null];\n} else if (rec === \"location\") {\n    msg.payload = {\"chatId\":chatId,\"messageId\":11563,\"type\":\"location\",\"content\":{\"latitude\":21.197681,\"longitude\":-13.312859}};\n    return [null, null, msg, null];\n} else if (rec === \"\") {\n    msg.payload = \"Ready!\\n\";\n    return [null, null, null, msg];\n} else {\n    msg.payload.content = rec;\n    return [null, null, msg, null];\n}\n\n/*\n{\"payload\":{\"chatId\":4885772,\"messageId\":11563,\"type\":\"location\",\"content\":{\"latitude\":21.197681,\"longitude\":-13.312859}},\"originalMessage\":{\"message_id\":11563,\"from\":{\"id\":4885772,\"is_bot\":false,\"first_name\":\"vjrj\",\"username\":\"vj_rj\",\"language_code\":\"es-ES\"},\"chat\":{\"id\":4885772,\"first_name\":\"vjrj\",\"username\":\"vj_rj\",\"type\":\"private\"},\"date\":1510114140,\"reply_to_message\":{\"message_id\":11562,\"from\":{\"id\":457126364,\"is_bot\":true,\"first_name\":\"¬°Tod@s contra el Desarrollo!\",\"username\":\"rednodetest_bot\"},\"chat\":{\"id\":4885772,\"first_name\":\"vjrj\",\"username\":\"vj_rj\",\"type\":\"private\"},\"date\":1510114109,\"text\":\"Indica cal a posici√≥n a vixiar (por ex. a t√∫a aldea, r√∫a, vivenda,  etc). Se est√°s a utilizar un m√≥bil podes anexar tam√©n unha localizaci√≥n premendo no clip\"},\"location\":{\"latitude\":21.197681,\"longitude\":-13.312859}},\"_msgid\":\"872d3ee7.01903\"} */\n/* REAL one:\n{\"payload\": {\n    \"chatId\":7777777,\n    \"messageId\":11442,\n    \"type\": \"message\",\n    \"content\":\"\"\n    },\n\"originalMessage\":{\n    \"message_id\":11442,\n    \"from\": {\n        \"id\":7777777,\n        \"is_bot\":false,\n        \"first_name\":\"somenick\",\n        \"username\":\"some_nick\",\n        \"language_code\": \"es-ES\"},\n        \"chat\": {\n            \"id\":7777777,\n            \"first_name\":\"somenick\",\n            \"username\": \"some_nick\",\n            \"type\": \"private\"\n        },\"date\":1510102651,\n        \"text\":\"/start\",\n        \"entities\":[{\"offset\":0,\"length\":6,\"type\":\"bot_command\"}]\n    },\n\"_msgid\":\"79e9eba6.722994\"\n} */",
        "outputs": "4",
        "noerr": 0,
        "x": 340,
        "y": 80,
        "wires": [
            [
                "e2056e63.a9e84"
            ],
            [],
            [],
            [
                "6604bcf8.bf3a84"
            ]
        ],
        "outputLabels": [
            "start",
            "lang",
            "others",
            "ack"
        ]
    },
    {
        "id": "dadeaa31.8d2c18",
        "type": "function",
        "z": "fe0c8b72.8a51a8",
        "name": "is a test?",
        "func": "if (msg.payload && msg.payload.chatId === 9998999) {\n    // Is a test message, print output in payload for send via tcp\n    if (msg.payload && msg.payload.content) {\n        var cnt = msg.payload.content;\n        var pay = msg.payload;\n        msg.payload = cnt + \"\\n\";\n        \n        if (pay.options && pay.options.reply_markup) {\n            var reply = JSON.parse(pay.options.reply_markup);\n            var keys = reply.keyboard || reply.inline_keyboard;\n            if (keys) {\n                for (var i = 0; i < keys.length; i++) {\n                    if (Array.isArray(keys[i])) {\n                        for (var j = 0; j < keys[i].length; j++) {\n                            msg.payload += \"[\" + keys[i][j].text + \"]\";\n                        }\n                        msg.payload += \"\\n\";\n                    } else {\n                        msg.payload += \"[\" + keys[i].text + \"]\";\n                    }\n                }\n                //msg.payload += \"\\n\";\n            }\n            //msg.payload += \"\\n\";\n        }\n    } else {\n        msg.payload = \"ack\\n\";\n    }\n    return [null, msg];\n} else {\n    return [msg, null];\n}\n    /* Real\n    payload: {\n            \"content\": \"Elige una de las opciones:\",\"chatId\":4885772,\"type\":\"message\",\"options\":{\"reply_markup\":\"{\\\"keyboard\\\":[[{\\\"text\\\":\\\"üì£ Suscrito a nuevos fuegos\\\"}],[{\\\"text\\\":\\\"Desuscribirme\\\"},{\\\"text\\\":\\\"üî• Notificar un fuego nuevo\\\"}],[{\\\"text\\\":\\\"‚ô• Apoya esta iniciativa\\\"},{\\\"text\\\":\\\"üìñ M√°s info\\\"}]],\\\"resize_keyboard\\\":true}\",\"disable_notification\":true}} \n            }\n        */\n  /*      \n        var opts = {\n  // reply_to_message_id: msg.payload.messageId,\n  reply_markup: JSON.stringify({\n    force_reply: true,\n    keyboard: [ \n        [{text: t('a 5 km')}, {text: t('a 10 km')}],\n        [{text: t('a 20 km')}, {text: t('a 40 km')} ],\n        [{text: t('a 100 km')}, {text: t('‚¨ÖÔ∏è Cancelar')} ]],\n      'resize_keyboard' : true, \n      'one_time_keyboard' : true\n  })\n};\n*/",
        "outputs": "2",
        "noerr": 0,
        "x": 220,
        "y": 60,
        "wires": [
            [],
            [
                "c1c4b1a2.fcf2f"
            ]
        ],
        "outputLabels": [
            "real msg",
            "test msg"
        ]
    },
    {
        "id": "4e437841.9b8a58",
        "type": "debug",
        "z": "76bd701f.29d0f",
        "name": "start output",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 1290,
        "y": 160,
        "wires": []
    },
    {
        "id": "c1c4b1a2.fcf2f",
        "type": "tcp out",
        "z": "fe0c8b72.8a51a8",
        "host": "",
        "port": "6789",
        "beserver": "reply",
        "base64": false,
        "end": false,
        "name": "tcp :6789",
        "x": 400,
        "y": 120,
        "wires": []
    },
    {
        "id": "3d9b789b.37b188",
        "type": "subflow:fe0c8b72.8a51a8",
        "z": "e6f3db8c.48eac8",
        "x": 440,
        "y": 100,
        "wires": [
            [
                "a2c7e3af.c055f"
            ]
        ]
    },
    {
        "id": "5fb93052.0736a",
        "type": "debug",
        "z": "fe0c8b72.8a51a8",
        "name": "tcp out",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 390,
        "y": 160,
        "wires": []
    },
    {
        "id": "f3418b4a.16c128",
        "type": "subflow:fe0c8b72.8a51a8",
        "z": "e81a68fa.695e38",
        "name": "",
        "x": 240,
        "y": 40,
        "wires": [
            [
                "dd683e99.7c126"
            ]
        ]
    },
    {
        "id": "b870e649.02f3a8",
        "type": "subflow:e81a68fa.695e38",
        "z": "93cb4937.6fc068",
        "x": 950,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "574b0512.1f89ac",
        "type": "subflow:e81a68fa.695e38",
        "z": "93cb4937.6fc068",
        "x": 1030,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "1e1d9c8f.87ccc3",
        "type": "subflow:e81a68fa.695e38",
        "z": "c6a40c11.dfc6b",
        "x": 490,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "aa2956c1.cdd168",
        "type": "subflow:e81a68fa.695e38",
        "z": "9968fcc5.ed33c",
        "x": 570,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "9951a307.647d",
        "type": "subflow:e81a68fa.695e38",
        "z": "93cb4937.6fc068",
        "x": 1030,
        "y": 480,
        "wires": [
            [
                "57988778.321178",
                "b052941e.4306e8"
            ]
        ]
    },
    {
        "id": "2b4ae0ff.b8f4a",
        "type": "link in",
        "z": "93cb4937.6fc068",
        "name": "/start",
        "links": [
            "e0c7d1c8.f4c64",
            "cfcc965c.921128"
        ],
        "x": 215,
        "y": 320,
        "wires": [
            [
                "55ebd8f8.436e38"
            ]
        ]
    },
    {
        "id": "73d9c14e.3f5d8",
        "type": "link in",
        "z": "93cb4937.6fc068",
        "name": "location",
        "links": [
            "ef39738e.0c383",
            "6d50e228.268eac"
        ],
        "x": 955,
        "y": 600,
        "wires": [
            [
                "349ef6f8.98e88a"
            ]
        ]
    },
    {
        "id": "89c5dc5e.6c881",
        "type": "link in",
        "z": "93cb4937.6fc068",
        "name": "other",
        "links": [
            "b77cd057.d584d",
            "da0408ba.8cc8b8"
        ],
        "x": 55,
        "y": 480,
        "wires": [
            [
                "11e83fb2.09a37"
            ]
        ]
    },
    {
        "id": "77f4e314.54a59c",
        "type": "link in",
        "z": "93cb4937.6fc068",
        "name": "lang",
        "links": [
            "4ec55575.36665c",
            "7f1d2825.26cab8",
            "e0417a.e678ee88"
        ],
        "x": 255,
        "y": 1200,
        "wires": [
            [
                "5e792abd.c19084"
            ]
        ]
    },
    {
        "id": "f4ebe282.6a894",
        "type": "link in",
        "z": "93cb4937.6fc068",
        "name": "lang-resp",
        "links": [
            "849e7348.7e94c",
            "3f59d0ce.bdd8d"
        ],
        "x": 355,
        "y": 1220,
        "wires": [
            [
                "9d03d653.8cca68"
            ]
        ]
    },
    {
        "id": "b53c3cf6.699f6",
        "type": "subflow:557e0255.d1220c",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 90,
        "y": 620,
        "wires": [
            [
                "e0c7d1c8.f4c64"
            ],
            [
                "4ec55575.36665c"
            ],
            [
                "ef39738e.0c383",
                "b77cd057.d584d",
                "849e7348.7e94c"
            ]
        ]
    },
    {
        "id": "e0c7d1c8.f4c64",
        "type": "link out",
        "z": "93cb4937.6fc068",
        "name": "/start",
        "links": [
            "2b4ae0ff.b8f4a"
        ],
        "x": 175,
        "y": 580,
        "wires": []
    },
    {
        "id": "ef39738e.0c383",
        "type": "link out",
        "z": "93cb4937.6fc068",
        "name": "",
        "links": [
            "73d9c14e.3f5d8"
        ],
        "x": 195,
        "y": 620,
        "wires": []
    },
    {
        "id": "b77cd057.d584d",
        "type": "link out",
        "z": "93cb4937.6fc068",
        "name": "other",
        "links": [
            "89c5dc5e.6c881"
        ],
        "x": 195,
        "y": 680,
        "wires": []
    },
    {
        "id": "4ec55575.36665c",
        "type": "link out",
        "z": "93cb4937.6fc068",
        "name": "lang",
        "links": [
            "77f4e314.54a59c"
        ],
        "x": 215,
        "y": 600,
        "wires": []
    },
    {
        "id": "849e7348.7e94c",
        "type": "link out",
        "z": "93cb4937.6fc068",
        "name": "lang resp",
        "links": [
            "f4ebe282.6a894"
        ],
        "x": 215,
        "y": 640,
        "wires": []
    },
    {
        "id": "99d32045.c775e",
        "type": "inject",
        "z": "93cb4937.6fc068",
        "name": "update stats",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "1800",
        "crontab": "",
        "once": false,
        "x": 130,
        "y": 1900,
        "wires": [
            [
                "a2c70f7c.ebd19"
            ]
        ]
    },
    {
        "id": "8be77355.e4b82",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "current susc",
        "func": "msg.payload = {};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 570,
        "y": 1840,
        "wires": [
            [
                "c674c40f.c7e778",
                "9b0a38a9.07b988"
            ]
        ]
    },
    {
        "id": "c674c40f.c7e778",
        "type": "mongodb in",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "count susc",
        "collection": "subscriptions",
        "operation": "count",
        "x": 790,
        "y": 1840,
        "wires": [
            [
                "58ad5a16.021874",
                "fdcc349d.ccb418"
            ]
        ]
    },
    {
        "id": "df3b630.a229ea",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "count susc",
        "func": "var newMsg = {\n    payload : {\n        name: \"numsus\"\n    },\n    projection: { \n        value: \n        1\n        \n    }\n};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 570,
        "y": 1880,
        "wires": [
            [
                "f129ff2a.f2843"
            ]
        ]
    },
    {
        "id": "f129ff2a.f2843",
        "type": "mongodb in",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "find stats",
        "collection": "fstats",
        "operation": "find",
        "x": 780,
        "y": 1880,
        "wires": [
            [
                "39f43b07.3083e4"
            ]
        ]
    },
    {
        "id": "39f43b07.3083e4",
        "type": "ui_text",
        "z": "93cb4937.6fc068",
        "group": "601660c.cd104a",
        "order": 5,
        "width": 0,
        "height": 0,
        "name": "sus",
        "label": "Suscripciones en el tiempo",
        "format": "{{msg.payload[0].value}}",
        "layout": "row-spread",
        "x": 950,
        "y": 1880,
        "wires": []
    },
    {
        "id": "58ad5a16.021874",
        "type": "ui_text",
        "z": "93cb4937.6fc068",
        "group": "601660c.cd104a",
        "order": 4,
        "width": 0,
        "height": 0,
        "name": "subs real",
        "label": "Subscripciones actuales",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 960,
        "y": 1840,
        "wires": []
    },
    {
        "id": "6e94e3ec.29eafc",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "count susc",
        "func": "var newMsg = {\n    payload : {\n        name: \"numdesus\"\n    },\n    projection: { \n        value: \n        1\n        \n    }\n};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 570,
        "y": 1920,
        "wires": [
            [
                "d790d688.c755c8"
            ]
        ]
    },
    {
        "id": "d790d688.c755c8",
        "type": "mongodb in",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "find stats",
        "collection": "fstats",
        "operation": "find",
        "x": 780,
        "y": 1920,
        "wires": [
            [
                "92dfe851.a1b278"
            ]
        ]
    },
    {
        "id": "92dfe851.a1b278",
        "type": "ui_text",
        "z": "93cb4937.6fc068",
        "group": "601660c.cd104a",
        "order": 6,
        "width": 0,
        "height": 0,
        "name": "desus",
        "label": "Desucripciones",
        "format": "{{msg.payload[0].value}}",
        "layout": "row-spread",
        "x": 950,
        "y": 1920,
        "wires": []
    },
    {
        "id": "a7eaa9d3.8d2808",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "count notis",
        "func": "var newMsg = {\n    payload : {\n        name: \"sendnotis\"\n    },\n    projection: { \n        value: \n        1\n        \n    }\n};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "x": 570,
        "y": 1960,
        "wires": [
            [
                "ca5bbef.da2244"
            ]
        ]
    },
    {
        "id": "ca5bbef.da2244",
        "type": "mongodb in",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "find stats",
        "collection": "fstats",
        "operation": "find",
        "x": 780,
        "y": 1960,
        "wires": [
            [
                "3c951498.389fac"
            ]
        ]
    },
    {
        "id": "3c951498.389fac",
        "type": "ui_text",
        "z": "93cb4937.6fc068",
        "group": "601660c.cd104a",
        "order": 7,
        "width": 0,
        "height": 0,
        "name": "notis",
        "label": "Notificaciones enviadas",
        "format": "{{msg.payload[0].value}}",
        "layout": "row-spread",
        "x": 950,
        "y": 1960,
        "wires": []
    },
    {
        "id": "28213612.28e18a",
        "type": "ui_text",
        "z": "93cb4937.6fc068",
        "group": "601660c.cd104a",
        "order": 8,
        "width": 0,
        "height": 0,
        "name": "avisos",
        "label": "Avisos recibidos",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 950,
        "y": 2000,
        "wires": []
    },
    {
        "id": "2cb7dc7e.180204",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "count all",
        "func": "msg.payload = {};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 560,
        "y": 2000,
        "wires": [
            [
                "a7f24748.36afe8"
            ]
        ]
    },
    {
        "id": "a7f24748.36afe8",
        "type": "mongodb in",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "count fuegos",
        "collection": "avisosfuego",
        "operation": "count",
        "x": 790,
        "y": 2000,
        "wires": [
            [
                "28213612.28e18a"
            ]
        ]
    },
    {
        "id": "61f539b5.950d08",
        "type": "ui_chart",
        "z": "93cb4937.6fc068",
        "name": "to dash",
        "group": "601660c.cd104a",
        "order": 3,
        "width": "0",
        "height": "0",
        "label": "Avisos diarios",
        "chartType": "line",
        "legend": "false",
        "xformat": "Y-M-D",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "useOldStyle": false,
        "x": 960,
        "y": 2040,
        "wires": [
            [
                "c36fe8.87636018"
            ],
            []
        ]
    },
    {
        "id": "997b33bf.c90ae",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "alertas hoy",
        "func": "var today = context.global.moment(new Date()).format('YYYYMMDD');\nmsg.payload = {\n    dateformat: today\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 570,
        "y": 2040,
        "wires": [
            [
                "709eb6b4.327e58",
                "3d1aa6a7.5a128a"
            ]
        ]
    },
    {
        "id": "709eb6b4.327e58",
        "type": "mongodb in",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "count fuegos",
        "collection": "avisosfuego",
        "operation": "count",
        "x": 790,
        "y": 2040,
        "wires": [
            [
                "61f539b5.950d08"
            ]
        ]
    },
    {
        "id": "c36fe8.87636018",
        "type": "persist in",
        "z": "93cb4937.6fc068",
        "name": "dayly-file-alerts",
        "storageNode": "103d89d5.f04ab6",
        "x": 1140,
        "y": 2040,
        "wires": []
    },
    {
        "id": "64e6a443.2ab69c",
        "type": "persist out",
        "z": "93cb4937.6fc068",
        "name": "dayly-file-alerts",
        "storageNode": "103d89d5.f04ab6",
        "x": 980,
        "y": 2080,
        "wires": [
            [
                "61f539b5.950d08"
            ]
        ]
    },
    {
        "id": "3d1aa6a7.5a128a",
        "type": "mongodb in",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "find fuegos",
        "collection": "avisosfuego",
        "operation": "find",
        "x": 790,
        "y": 2120,
        "wires": [
            [
                "3de8df77.b4acb"
            ]
        ]
    },
    {
        "id": "d0f89010.cdf26",
        "type": "subflow:d29a1c6a.5a89e",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 1140,
        "y": 2120,
        "wires": []
    },
    {
        "id": "3de8df77.b4acb",
        "type": "split",
        "z": "93cb4937.6fc068",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 950,
        "y": 2120,
        "wires": [
            [
                "d0f89010.cdf26"
            ]
        ]
    },
    {
        "id": "9b0a38a9.07b988",
        "type": "mongodb in",
        "z": "93cb4937.6fc068",
        "mongodb": "51a7af07.93444",
        "name": "find susc",
        "collection": "subscriptions",
        "operation": "find",
        "x": 780,
        "y": 1800,
        "wires": [
            [
                "ebb1176c.563dd8"
            ]
        ]
    },
    {
        "id": "ebb1176c.563dd8",
        "type": "split",
        "z": "93cb4937.6fc068",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 950,
        "y": 1800,
        "wires": [
            [
                "b952a17b.820bb"
            ]
        ]
    },
    {
        "id": "b952a17b.820bb",
        "type": "subflow:d29a1c6a.5a89e",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 1140,
        "y": 1800,
        "wires": []
    },
    {
        "id": "fdcc349d.ccb418",
        "type": "ui_chart",
        "z": "93cb4937.6fc068",
        "name": "to dash",
        "group": "601660c.cd104a",
        "order": 2,
        "width": "0",
        "height": "0",
        "label": "Suscripciones",
        "chartType": "line",
        "legend": "false",
        "xformat": "Y-M-D",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "useOldStyle": false,
        "x": 1120,
        "y": 1840,
        "wires": [
            [
                "b6ba07c8.358c38"
            ],
            []
        ]
    },
    {
        "id": "d5c8bece.6075c",
        "type": "persist out",
        "z": "93cb4937.6fc068",
        "name": "suscriptions-in-time",
        "storageNode": "cb34ee3.be2b31",
        "x": 1150,
        "y": 1880,
        "wires": [
            [
                "fdcc349d.ccb418"
            ]
        ]
    },
    {
        "id": "b6ba07c8.358c38",
        "type": "persist in",
        "z": "93cb4937.6fc068",
        "name": "suscriptions-in-time",
        "storageNode": "cb34ee3.be2b31",
        "x": 1330,
        "y": 1840,
        "wires": []
    },
    {
        "id": "a2c70f7c.ebd19",
        "type": "subflow:91777bb3.922328",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 330,
        "y": 1900,
        "wires": [
            [
                "8be77355.e4b82",
                "df3b630.a229ea",
                "6e94e3ec.29eafc",
                "a7eaa9d3.8d2808",
                "2cb7dc7e.180204",
                "997b33bf.c90ae"
            ]
        ]
    },
    {
        "id": "b2e2ccf3.f0498",
        "type": "subflow:e81a68fa.695e38",
        "z": "76bd701f.29d0f",
        "name": "",
        "x": 1270,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "9cc764dc.591728",
        "type": "subflow:e81a68fa.695e38",
        "z": "93cb4937.6fc068",
        "x": 690,
        "y": 1440,
        "wires": [
            []
        ]
    },
    {
        "id": "eda1038.09ff8",
        "type": "subflow:e81a68fa.695e38",
        "z": "c644db46.3854c8",
        "x": 1490,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "320b1cf9.d609d4",
        "type": "subflow:e81a68fa.695e38",
        "z": "c644db46.3854c8",
        "x": 230,
        "y": 320,
        "wires": [
            [
                "5c52af18.0b854"
            ]
        ]
    },
    {
        "id": "fdba8b7a.1a1b08",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "sus o fire?",
        "func": "var key = 'locationtopic-' + msg.payload.chatId;\nvar type = global.get(key);\nglobal.set(key, null);\nif (type == 'sus') {\n    return [msg, null];\n} else if (type == 'newfire') {\n    return [null, msg];\n}\nnode.warm(\"Wrong location received\")",
        "outputs": "2",
        "noerr": 0,
        "x": 1430,
        "y": 640,
        "wires": [
            [
                "10eb3fd5.6d416"
            ],
            [
                "d982859c.d8dea8"
            ]
        ],
        "outputLabels": [
            "sus",
            "fire"
        ]
    },
    {
        "id": "26070084.ca2db",
        "type": "switch",
        "z": "5501c3cc.11327c",
        "name": "susc o fuego?",
        "property": "locationtopic",
        "propertyType": "global",
        "rules": [
            {
                "t": "eq",
                "v": "sus",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "nuevofuego",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "outputs": 2,
        "x": 140,
        "y": 680,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "4617874.e42eb78",
        "type": "subflow:e81a68fa.695e38",
        "z": "156e20df.86399f",
        "x": 530,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "307c3839.005448",
        "type": "subflow:e81a68fa.695e38",
        "z": "156e20df.86399f",
        "x": 710,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "ca9ae1e8.6507f",
        "type": "subflow:e81a68fa.695e38",
        "z": "95e78a8b.50a428",
        "x": 1350,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "eab4c7fe.fd7828",
        "type": "subflow:e81a68fa.695e38",
        "z": "2f0217a5.051978",
        "x": 1210,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "364970ea.3f564",
        "type": "subflow:e81a68fa.695e38",
        "z": "2f0217a5.051978",
        "x": 1210,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "6604bcf8.bf3a84",
        "type": "tcp out",
        "z": "557e0255.d1220c",
        "host": "",
        "port": "",
        "beserver": "reply",
        "base64": false,
        "end": false,
        "name": "tcp reply empty msgs",
        "x": 760,
        "y": 240,
        "wires": []
    },
    {
        "id": "e2056e63.a9e84",
        "type": "debug",
        "z": "557e0255.d1220c",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 710,
        "y": 300,
        "wires": []
    },
    {
        "id": "5031ecc8.ccb184",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "catch error ----------------------",
        "active": true,
        "console": "true",
        "complete": "true",
        "x": 330,
        "y": 160,
        "wires": []
    },
    {
        "id": "2c822866.453948",
        "type": "catch",
        "z": "93cb4937.6fc068",
        "name": "catch all",
        "scope": null,
        "x": 100,
        "y": 160,
        "wires": [
            [
                "5031ecc8.ccb184"
            ]
        ]
    },
    {
        "id": "d35010eb.26fdd",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "set location",
        "func": "msg.chatId = msg.payload.chatId;\nvar content = msg.payload.content;\n\nmsg.location = {};\n\nif (content && content.latitude) {\n    // Is a shared location (clip)\n    msg.location.lat = content.latitude;\n    msg.location.lon = content.longitude;\n    return [null, msg];\n} else {\n    // Is a writen location\n    msg.address = content;\n    msg.location.address = content;\n    return [msg, null];\n}\n\nreturn msg;",
        "outputs": "2",
        "noerr": 0,
        "x": 1330,
        "y": 480,
        "wires": [
            [
                "bb4817df.01de48"
            ],
            []
        ],
        "outputLabels": [
            "address",
            "shared location"
        ]
    },
    {
        "id": "62f992fa.519cec",
        "type": "persist out",
        "z": "c8522537.c6f908",
        "name": "nasa-new-fire-actives",
        "storageNode": "9a28d188.bb94e",
        "x": 200,
        "y": 80,
        "wires": [
            [
                "796f3781.151c38"
            ]
        ]
    },
    {
        "id": "796f3781.151c38",
        "type": "ui_chart",
        "z": "c8522537.c6f908",
        "name": "to dash",
        "group": "601660c.cd104a",
        "order": 2,
        "width": "0",
        "height": "0",
        "label": "Fuegos activos nuevos",
        "chartType": "line",
        "legend": "false",
        "xformat": "Y-M-D",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": "1",
        "removeOlderPoints": "",
        "removeOlderUnit": "604800",
        "cutout": 0,
        "useOneColor": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "useOldStyle": false,
        "x": 420,
        "y": 40,
        "wires": [
            [
                "67495f5f.e8643"
            ],
            []
        ]
    },
    {
        "id": "67495f5f.e8643",
        "type": "persist in",
        "z": "c8522537.c6f908",
        "name": "nasa-new-fire-actives",
        "storageNode": "9a28d188.bb94e",
        "x": 640,
        "y": 40,
        "wires": []
    },
    {
        "id": "8d910d3f.7ff39",
        "type": "function",
        "z": "c8522537.c6f908",
        "name": "count active",
        "func": "if (Array.isArray(msg.payload)) {\n    var newMsg  = {\n        payload: msg.payload.length,\n        topic: \"Fuegos activos nuevos (\" + msg.type + \")\"\n    }\n    return newMsg;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 210,
        "y": 40,
        "wires": [
            [
                "796f3781.151c38"
            ]
        ]
    },
    {
        "id": "17c09c20.9d4a84",
        "type": "function",
        "z": "2f0217a5.051978",
        "name": "find fire viirs",
        "func": "if (msg.originalMessage && \n    msg.originalMessage.reply_to_message &&\n    msg.originalMessage.reply_to_message.location) {\n    var lon = msg.originalMessage.reply_to_message.location.longitude;\n    var lat = msg.originalMessage.reply_to_message.location.latitude;\n    var find = {};\n    find.payload = {\n    _id:\n       { $near : {\n            $geometry: { \n                type: \"Point\",  \n                coordinates: [lon, lat]\n            },\n            $minDistance: 0,\n            $maxDistance: 50\n          }\n        },\n    };\n    find.originalMessage = msg.originalMessage;\n    find.chatId = msg.payload.chatId;\n    find.i18n = msg.i18n;\n    return find;\n}\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 190,
        "y": 60,
        "wires": [
            [
                "20bf7bfd.05f774"
            ]
        ]
    },
    {
        "id": "20bf7bfd.05f774",
        "type": "mongodb in",
        "z": "2f0217a5.051978",
        "mongodb": "51a7af07.93444",
        "name": "viirs count",
        "collection": "activefiresviirs",
        "operation": "count",
        "x": 390,
        "y": 60,
        "wires": [
            [
                "557a9912.ee75e8"
            ]
        ]
    },
    {
        "id": "46c68055.7e566",
        "type": "function",
        "z": "2f0217a5.051978",
        "name": "find fire modis",
        "func": "if (msg.originalMessage) {\n    var lon = msg.originalMessage.reply_to_message.location.longitude;\n    var lat = msg.originalMessage.reply_to_message.location.latitude;\n    var find = {};\n    find.payload = {\n    _id:\n       { $near : {\n            $geometry: { \n                type: \"Point\",  \n                coordinates: [lon, lat]\n            },\n            $minDistance: 0,\n            $maxDistance: 50\n          }\n        },\n    };\n    find.originalMessage = msg.originalMessage;\n    find.chatId = msg.chatId;\n    find.i18n = msg.i18n;\n    return find;\n}\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 760,
        "y": 60,
        "wires": [
            [
                "60501805.4a76b8"
            ]
        ]
    },
    {
        "id": "60501805.4a76b8",
        "type": "mongodb in",
        "z": "2f0217a5.051978",
        "mongodb": "51a7af07.93444",
        "name": "viirs count",
        "collection": "activefiresmodis",
        "operation": "count",
        "x": 930,
        "y": 60,
        "wires": [
            [
                "dce22962.386f98"
            ]
        ]
    },
    {
        "id": "557a9912.ee75e8",
        "type": "switch",
        "z": "2f0217a5.051978",
        "name": "nasa fire?",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 560,
        "y": 60,
        "wires": [
            [
                "46c68055.7e566"
            ],
            [
                "a30ccf58.3a1e"
            ]
        ]
    },
    {
        "id": "dce22962.386f98",
        "type": "switch",
        "z": "2f0217a5.051978",
        "name": "nasa fire?",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 1080,
        "y": 60,
        "wires": [
            [
                "280900e5.654d3"
            ],
            [
                "a30ccf58.3a1e"
            ]
        ]
    },
    {
        "id": "280900e5.654d3",
        "type": "function",
        "z": "2f0217a5.051978",
        "name": "not active!",
        "func": "var t = msg.i18n;\n\nvar thx = {};\nthx.payload = {};\nthx.payload.type = \"message\";\nthx.payload.chatId = msg.chatId;\nthx.payload.content = t(\"No tenemos registrado un fuego activo en ese lugar\");\nreturn thx;",
        "outputs": 1,
        "noerr": 0,
        "x": 1050,
        "y": 280,
        "wires": [
            [
                "2b5fa53f.8b255a"
            ]
        ]
    },
    {
        "id": "2b5fa53f.8b255a",
        "type": "subflow:e81a68fa.695e38",
        "z": "2f0217a5.051978",
        "x": 1210,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "88caef4a.db39e",
        "type": "debug",
        "z": "2f0217a5.051978",
        "name": "find nasa 2",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 1250,
        "y": 140,
        "wires": []
    },
    {
        "id": "55e258a.51dd4a8",
        "type": "debug",
        "z": "2f0217a5.051978",
        "name": "find nasa 1",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 730,
        "y": 140,
        "wires": []
    },
    {
        "id": "7efc5567.7d712c",
        "type": "debug",
        "z": "2f0217a5.051978",
        "name": "find false positive",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 670,
        "y": 460,
        "wires": []
    },
    {
        "id": "ceeae061.7eb55",
        "type": "debug",
        "z": "2f0217a5.051978",
        "name": "false positive count",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 930,
        "y": 540,
        "wires": []
    },
    {
        "id": "1041069a.2c84b9",
        "type": "subflow:95e78a8b.50a428",
        "z": "2b8628df.fdcca8",
        "name": "",
        "x": 2530,
        "y": 240,
        "wires": []
    },
    {
        "id": "430ec153.ed1f8",
        "type": "comment",
        "z": "95e78a8b.50a428",
        "name": "msg.payload.location and chatId for user info",
        "info": "",
        "x": 310,
        "y": 40,
        "wires": []
    },
    {
        "id": "a8447ee4.5f9bc",
        "type": "subflow:465e67f.6ebf598",
        "z": "95e78a8b.50a428",
        "x": 1520,
        "y": 100,
        "wires": []
    },
    {
        "id": "59bd465d.f6ae48",
        "type": "function",
        "z": "5501c3cc.11327c",
        "name": "test active fires",
        "func": "var type = \"viirs\";\nvar collection = \"activefires\" + type; // to detect new fires \nvar now = global.get('lastact');\nvar newfires = {};\nnewfires.type = type;\nnewfires.collection = collection;\nnewfires.payload = {\n    createdAt: new Date(now)\n};\nreturn newfires;\n",
        "outputs": "1",
        "noerr": 0,
        "x": 540,
        "y": 760,
        "wires": [
            [
                "9484585b.8339a8",
                "10e6ffe2.fab67"
            ]
        ],
        "outputLabels": [
            "update/save"
        ]
    },
    {
        "id": "e6581364.42858",
        "type": "inject",
        "z": "5501c3cc.11327c",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 340,
        "y": 760,
        "wires": [
            [
                "59bd465d.f6ae48"
            ]
        ]
    },
    {
        "id": "10e6ffe2.fab67",
        "type": "debug",
        "z": "5501c3cc.11327c",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 810,
        "y": 860,
        "wires": []
    },
    {
        "id": "9484585b.8339a8",
        "type": "mongodb in",
        "z": "5501c3cc.11327c",
        "mongodb": "51a7af07.93444",
        "name": "new active fires",
        "collection": "",
        "operation": "find",
        "x": 760,
        "y": 740,
        "wires": [
            [
                "10e6ffe2.fab67"
            ]
        ]
    },
    {
        "id": "26b36dd6.0fc162",
        "type": "debug",
        "z": "128790f6.dee0df",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 1010,
        "y": 260,
        "wires": []
    },
    {
        "id": "bff4fef3.9fe3e",
        "type": "function",
        "z": "128790f6.dee0df",
        "name": "on/off",
        "func": "var c = context.get('switch') || false;\n\nvar update = function (c) {\n    node.status({fill:c? \"green\": \"red\",shape: c? \"dot\":\"ring\", text: c? \"on\": \"off\"});\n}\n\nif (msg.payload.switch) {\n    c = !c;\n    context.set('switch', c);\n    update(c);\n} else {\n    update(c);\n    if (c) {\n        return msg;\n    }    \n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1410,
        "y": 340,
        "wires": [
            [
                "49f7750c.76675c",
                "3eff4b32.9114b4"
            ]
        ]
    },
    {
        "id": "6767dc05.9d1a14",
        "type": "inject",
        "z": "128790f6.dee0df",
        "name": "on/off",
        "topic": "",
        "payload": "{\"switch\":true}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 1230,
        "y": 400,
        "wires": [
            [
                "bff4fef3.9fe3e"
            ]
        ]
    },
    {
        "id": "c3cd9894.0f4098",
        "type": "debug",
        "z": "128790f6.dee0df",
        "name": "send to chatId",
        "active": true,
        "console": "false",
        "complete": "payload.chatId",
        "x": 1400,
        "y": 240,
        "wires": []
    },
    {
        "id": "54968e5b.432b1",
        "type": "mongodb2 in",
        "z": "11cb3f4d.6e0081",
        "service": "_ext_",
        "configNode": "d5287e69.2b449",
        "name": "bulkWrite",
        "collection": "",
        "operation": "bulkWrite",
        "x": 400,
        "y": 140,
        "wires": [
            [
                "9c69454c.af1928"
            ]
        ]
    },
    {
        "id": "35871943.67ee96",
        "type": "debug",
        "z": "11cb3f4d.6e0081",
        "name": "update",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 550,
        "y": 180,
        "wires": []
    },
    {
        "id": "2f350204.d4c09e",
        "type": "mongodb2 in",
        "z": "11cb3f4d.6e0081",
        "service": "_ext_",
        "configNode": "d5287e69.2b449",
        "name": "deleteMany",
        "collection": "",
        "operation": "deleteMany",
        "x": 790,
        "y": 140,
        "wires": [
            [
                "3150215a.5e429e"
            ]
        ]
    },
    {
        "id": "e548f509.8b1958",
        "type": "mongodb2 in",
        "z": "11cb3f4d.6e0081",
        "service": "_ext_",
        "configNode": "d5287e69.2b449",
        "name": "find",
        "collection": "",
        "operation": "find.toArray",
        "x": 1190,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "6c4b8a1f.1c02a4",
        "type": "debug",
        "z": "11cb3f4d.6e0081",
        "name": "find all",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 1390,
        "y": 260,
        "wires": []
    },
    {
        "id": "e58b1a65.b4b888",
        "type": "debug",
        "z": "11cb3f4d.6e0081",
        "name": "del",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 950,
        "y": 180,
        "wires": []
    },
    {
        "id": "9c69454c.af1928",
        "type": "function",
        "z": "11cb3f4d.6e0081",
        "name": "del not active fires",
        "func": "if (msg.payload.ok || !msg.error) {\n    // var type = flow.get('type');\n    var now = global.get('active-now');\n    var collection = flow.get('active-collection');\n    \n    // del not active fires\n    var del = {};\n    del.collection = collection;\n    // http://mongodb.github.io/node-mongodb-native/2.1/api/Collection.html#deleteMany\n    // deleteMany(filter, options, callback)\n    del.payload = [{updatedAt: {$ne: now}}, null];\n    return del;\n} else {\n    node.log(\"Error in update\" + msg.error);\n    return msg;\n}",
        "outputs": "1",
        "noerr": 0,
        "x": 590,
        "y": 140,
        "wires": [
            [
                "2f350204.d4c09e"
            ]
        ]
    },
    {
        "id": "3150215a.5e429e",
        "type": "function",
        "z": "11cb3f4d.6e0081",
        "name": "find new active fires",
        "func": "if (msg.payload.ok || !msg.error) {\n    var type = msg.type;\n    var now = global.get('active-now');\n    global.set('active-now', null); // we disable timestamp to semaphore deadlock detection\n    var type = flow.get('active-type');\n    var collection = flow.get('active-collection');\n    \n    var newfires = {};\n    newfires.type = type;\n    newfires.collection = collection;\n    // http://mongodb.github.io/node-mongodb-native/2.1/api/Collection.html#find\n    newfires.payload = [{ createdAt: now }];\n    return newfires;\n} else {\n    node.log(\"Error in deletion\" + msg.error);\n    return msg;\n}",
        "outputs": "1",
        "noerr": 0,
        "x": 1000,
        "y": 140,
        "wires": [
            [
                "e548f509.8b1958"
            ]
        ]
    },
    {
        "id": "c37e7408.e43de8",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "detect lang change",
        "func": "if (msg.payload.content &&\n    msg.payload.content.match(/^[‚ô•‚¨ÖÔ∏èüìñüì£üî•üì£üìùüìçüìù]+ .*/)) {\n    node.log(\"Detect lang changed\");\n    return msg;\n}\n",
        "outputs": "1",
        "noerr": 0,
        "x": 610,
        "y": 1020,
        "wires": [
            [
                "63abfabd.c35504",
                "87d143dc.3e3b3"
            ]
        ]
    },
    {
        "id": "87d143dc.3e3b3",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "lang changed?",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 880,
        "y": 1060,
        "wires": []
    },
    {
        "id": "63abfabd.c35504",
        "type": "subflow:76bd701f.29d0f",
        "z": "93cb4937.6fc068",
        "x": 850,
        "y": 1020,
        "wires": []
    },
    {
        "id": "765fb9d8.730558",
        "type": "e-mail",
        "z": "5501c3cc.11327c",
        "server": "selver.comunes.org",
        "port": "587",
        "secure": false,
        "name": "vjrj@ourproject.org",
        "dname": "no-reply to vjrj",
        "x": 460,
        "y": 180,
        "wires": []
    },
    {
        "id": "e4fc71c5.ae308",
        "type": "function",
        "z": "5501c3cc.11327c",
        "name": "test email",
        "func": "        var email = {};\n        email.topic = \"Test email\";\n        email.payload = \"Pues eso...\";\n        return email;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 280,
        "y": 180,
        "wires": [
            [
                "765fb9d8.730558"
            ]
        ]
    },
    {
        "id": "2c31df23.b95e6",
        "type": "inject",
        "z": "5501c3cc.11327c",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 120,
        "y": 180,
        "wires": [
            [
                "e4fc71c5.ae308"
            ]
        ]
    },
    {
        "id": "f78bdf2e.e07e8",
        "type": "subflow:76bd701f.29d0f",
        "z": "5501c3cc.11327c",
        "x": 470,
        "y": 240,
        "wires": []
    },
    {
        "id": "4e9c6a21.dbe994",
        "type": "inject",
        "z": "5501c3cc.11327c",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 120,
        "y": 240,
        "wires": [
            [
                "c9213523.ff07b8"
            ]
        ]
    },
    {
        "id": "c9213523.ff07b8",
        "type": "function",
        "z": "5501c3cc.11327c",
        "name": "test msg",
        "func": "var m = {}\nm.payload = {};\nm.chatId = 4885772;\nm.payload.chatId = 4885772;\nm.payload.content = \"Testingggg...\";\nreturn m;",
        "outputs": 1,
        "noerr": 0,
        "x": 280,
        "y": 240,
        "wires": [
            [
                "f78bdf2e.e07e8"
            ]
        ]
    },
    {
        "id": "cbe6ee70.2be05",
        "type": "debug",
        "z": "76bd701f.29d0f",
        "name": "all after lang",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 570,
        "y": 140,
        "wires": []
    },
    {
        "id": "67bf84ab.ff905c",
        "type": "debug",
        "z": "4384af8e.a7409",
        "name": "no cached",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 1130,
        "y": 100,
        "wires": []
    },
    {
        "id": "f2de1625.f47288",
        "type": "debug",
        "z": "76bd701f.29d0f",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 670,
        "y": 200,
        "wires": []
    },
    {
        "id": "e5f28b05.bf6ea8",
        "type": "debug",
        "z": "76bd701f.29d0f",
        "name": "subs",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 910,
        "y": 40,
        "wires": []
    },
    {
        "id": "79f1e71d.6acff8",
        "type": "debug",
        "z": "76bd701f.29d0f",
        "name": "all before lang",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 460,
        "y": 60,
        "wires": []
    },
    {
        "id": "32402b32.78e694",
        "type": "debug",
        "z": "4384af8e.a7409",
        "name": "cached",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 1200,
        "y": 140,
        "wires": []
    },
    {
        "id": "496139f7.6cf4b8",
        "type": "debug",
        "z": "4384af8e.a7409",
        "name": "cached?",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 800,
        "y": 60,
        "wires": []
    },
    {
        "id": "81ab9c35.b5e65",
        "type": "debug",
        "z": "4384af8e.a7409",
        "name": "before cache",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 590,
        "y": 60,
        "wires": []
    },
    {
        "id": "7bba7c0.77e4f84",
        "type": "subflow:76bd701f.29d0f",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 1210,
        "y": 580,
        "wires": []
    },
    {
        "id": "fa14bb16.1c3248",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "new fire",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 580,
        "y": 680,
        "wires": []
    },
    {
        "id": "c46a6a2.a934698",
        "type": "assert",
        "z": "4384af8e.a7409",
        "name": "assert setLang",
        "rules": [
            {
                "property": "payload.chatId",
                "propertyType": "msg",
                "type": "eq",
                "value": "payload-assert.chatId",
                "valueType": "flow",
                "failMsg": "Wrong chatId returned after lang setting"
            },
            {
                "property": "lang",
                "propertyType": "msg",
                "type": "type",
                "value": "string",
                "failMsg": "Wrong lang returned after lang setting"
            },
            {
                "property": "payload.content",
                "propertyType": "msg",
                "type": "eq",
                "value": "payload-assert.content",
                "valueType": "flow",
                "failMsg": "Wrong content returned after lang setting"
            },
            {
                "property": "chatId",
                "propertyType": "msg",
                "type": "eq",
                "value": "payload-assert.chatId",
                "valueType": "flow",
                "failMsg": ""
            }
        ],
        "x": 1600,
        "y": 240,
        "wires": [
            [
                "e39f3d19.34c0f"
            ]
        ]
    },
    {
        "id": "edb02cb3.e23b7",
        "type": "function",
        "z": "4384af8e.a7409",
        "name": "lang?",
        "func": "if (typeof msg.lang === 'string') {\n  // do nothing   \n  return [null, msg]\n} else {\n  return [msg, null];\n}",
        "outputs": "2",
        "noerr": 0,
        "x": 450,
        "y": 100,
        "wires": [
            [
                "6173b8ee.c73038"
            ],
            [
                "c46a6a2.a934698"
            ]
        ],
        "outputLabels": [
            "no lang",
            "lang"
        ]
    },
    {
        "id": "e11dde1f.ea412",
        "type": "Cache out",
        "z": "4384af8e.a7409",
        "name": "cache",
        "cache": "488013b6.1183ec",
        "keyType": "msg",
        "keyProperty": "chatId",
        "valueType": "msg",
        "valueProperty": "lang",
        "ttlType": "msg",
        "ttlProperty": "",
        "useString": false,
        "x": 1590,
        "y": 100,
        "wires": []
    },
    {
        "id": "593e8a9f.d2fd54",
        "type": "assert",
        "z": "5501c3cc.11327c",
        "name": "Payload < 100",
        "rules": [
            {
                "property": "payload",
                "propertyType": "msg",
                "type": "lt",
                "value": "100",
                "valueType": "num",
                "failMsg": ""
            }
        ],
        "x": 342,
        "y": 837,
        "wires": [
            [
                "7f762f9d.71602"
            ]
        ]
    },
    {
        "id": "7f762f9d.71602",
        "type": "debug",
        "z": "5501c3cc.11327c",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 590,
        "y": 840,
        "wires": []
    },
    {
        "id": "4d49b9c8.a65f18",
        "type": "inject",
        "z": "5501c3cc.11327c",
        "name": "",
        "topic": "",
        "payload": "50",
        "payloadType": "num",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 92,
        "y": 835,
        "wires": [
            [
                "593e8a9f.d2fd54"
            ]
        ]
    },
    {
        "id": "8a57658e.867158",
        "type": "inject",
        "z": "5501c3cc.11327c",
        "name": "",
        "topic": "",
        "payload": "150",
        "payloadType": "num",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 92,
        "y": 897,
        "wires": [
            [
                "593e8a9f.d2fd54"
            ]
        ]
    },
    {
        "id": "1586a4b5.782b9b",
        "type": "assert",
        "z": "4384af8e.a7409",
        "name": "assert setI18n",
        "rules": [
            {
                "property": "payload.chatId",
                "propertyType": "msg",
                "type": "eq",
                "value": "payload-assert.chatId",
                "valueType": "flow",
                "failMsg": "Wrong chatId returned after lang setting"
            },
            {
                "property": "lang",
                "propertyType": "msg",
                "type": "type",
                "value": "string",
                "failMsg": "Wrong lang returned after lang setting"
            },
            {
                "property": "payload.content",
                "propertyType": "msg",
                "type": "eq",
                "value": "payload-assert.content",
                "valueType": "flow",
                "failMsg": "Wrong content returned after lang setting"
            },
            {
                "property": "i18n",
                "propertyType": "msg",
                "type": "nnull",
                "failMsg": ""
            },
            {
                "property": "chatId",
                "propertyType": "msg",
                "type": "eq",
                "value": "payload-assert.chatId",
                "valueType": "flow",
                "failMsg": "wrong msg.chatId"
            }
        ],
        "x": 1980,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "21c6b163.12e99e",
        "type": "function",
        "z": "76bd701f.29d0f",
        "name": "asserts",
        "func": "flow.set('payload-assert', msg.payload);\n// flow.set('chatId-assert', msg.chatId);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 120,
        "y": 100,
        "wires": [
            [
                "596d56e2.54f5e8"
            ]
        ]
    },
    {
        "id": "56722a87.7bd4b4",
        "type": "assert",
        "z": "76bd701f.29d0f",
        "name": "assert pre-start",
        "rules": [
            {
                "property": "originalPayload.content",
                "propertyType": "msg",
                "type": "eq",
                "value": "payload-assert.content",
                "valueType": "flow",
                "failMsg": "Wrong payload"
            },
            {
                "property": "chatId",
                "propertyType": "msg",
                "type": "type",
                "value": "number",
                "failMsg": "No chatId"
            },
            {
                "property": "i18n",
                "propertyType": "msg",
                "type": "nnull",
                "failMsg": ""
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "type": "type",
                "value": "array",
                "failMsg": "Wrong subs result"
            },
            {
                "property": "originalPayload.chatId",
                "propertyType": "msg",
                "type": "eq",
                "value": "payload-assert.chatId",
                "valueType": "flow",
                "failMsg": ""
            }
        ],
        "x": 900,
        "y": 100,
        "wires": [
            [
                "875a7c37.8bb0a"
            ]
        ]
    },
    {
        "id": "da7e1a7c.19d3c8",
        "type": "assert",
        "z": "76bd701f.29d0f",
        "name": "assert initial-start",
        "rules": [],
        "x": 210,
        "y": 160,
        "wires": [
            [
                "21c6b163.12e99e"
            ]
        ]
    },
    {
        "id": "e0417a.e678ee88",
        "type": "link out",
        "z": "93cb4937.6fc068",
        "name": "lang",
        "links": [
            "77f4e314.54a59c"
        ],
        "x": 535,
        "y": 720,
        "wires": []
    },
    {
        "id": "a06c9e0.494806",
        "type": "function",
        "z": "5501c3cc.11327c",
        "name": "counter",
        "func": "var c = context.get('counter') || false;\n\nvar update = function (c) {\n    node.status({fill:\"green\",shape:\"dot\",text:c});\n}\n\nif (msg.payload.counter) {\n    c = 0;\n    context.set('counter', c);\n    update(c);\n} else {\n    c += 1;\n    context.set('counter', c);\n    update(c);\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 960,
        "y": 540,
        "wires": [
            [
                "15cc01b0.ff80be"
            ]
        ]
    },
    {
        "id": "53a9608e.e527a",
        "type": "inject",
        "z": "5501c3cc.11327c",
        "name": "reset",
        "topic": "",
        "payload": "{\"counter\":true}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 770,
        "y": 480,
        "wires": [
            [
                "a06c9e0.494806"
            ]
        ]
    },
    {
        "id": "c1b4bd12.f0d9d",
        "type": "inject",
        "z": "5501c3cc.11327c",
        "name": "",
        "topic": "",
        "payload": "Hello!",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 770,
        "y": 540,
        "wires": [
            [
                "a06c9e0.494806"
            ]
        ]
    },
    {
        "id": "15cc01b0.ff80be",
        "type": "debug",
        "z": "5501c3cc.11327c",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 1090,
        "y": 540,
        "wires": []
    },
    {
        "id": "83c851d.12e2ab",
        "type": "inject",
        "z": "93cb4937.6fc068",
        "name": "reset",
        "topic": "",
        "payload": "{\"counter\":true}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 90,
        "y": 300,
        "wires": [
            [
                "17af36df.d20ff9"
            ]
        ]
    },
    {
        "id": "17af36df.d20ff9",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "counter",
        "func": "var c = context.get('counter') || false;\n\nvar update = function (c) {\n    node.status({fill:\"green\",shape:\"dot\",text:c});\n}\n\nif (msg.payload.counter) {\n    c = 0;\n    context.set('counter', c);\n    update(c);\n} else {\n    c += 1;\n    context.set('counter', c);\n    update(c);\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 260,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "829ed9c9.8cd588",
        "type": "assert",
        "z": "93cb4937.6fc068",
        "name": "i18n",
        "rules": [
            {
                "property": "i18n",
                "propertyType": "msg",
                "type": "nnull",
                "failMsg": ""
            }
        ],
        "x": 390,
        "y": 800,
        "wires": [
            [
                "f3249bab.90eae8"
            ]
        ]
    },
    {
        "id": "83d02c40.cf2b6",
        "type": "assert",
        "z": "4384af8e.a7409",
        "name": "assert init-lang",
        "rules": [
            {
                "property": "payload.chatId",
                "propertyType": "msg",
                "type": "type",
                "value": "number",
                "failMsg": "Wrong chatId in lang enter"
            }
        ],
        "x": 140,
        "y": 100,
        "wires": [
            [
                "afdf0d2.1f75ef"
            ]
        ]
    },
    {
        "id": "71ddbc3a.d5e9a4",
        "type": "subflow:4384af8e.a7409",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 730,
        "y": 2220,
        "wires": [
            [
                "5983db7f.7b6614"
            ]
        ]
    },
    {
        "id": "2d3ed690.563dfa",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "show lang",
        "func": "var t = msg.i18n;\nvar m = {}\nm.payload = {};\nm.payload.chatId = msg.chatId;\nm.payload.content = \"Lenguaje \" + msg.lang + \", sample: \" + t('Desuscribirme') + ', ' + t('kmdistancia', {km: 99});\nm.payload.type = \"message\";\nreturn m;",
        "outputs": 1,
        "noerr": 0,
        "x": 1080,
        "y": 2240,
        "wires": [
            [
                "eee020eb.36a75"
            ]
        ]
    },
    {
        "id": "20f4d6ba.631d1a",
        "type": "subflow:e81a68fa.695e38",
        "z": "93cb4937.6fc068",
        "x": 1370,
        "y": 2240,
        "wires": [
            []
        ]
    },
    {
        "id": "60a6109e.2065a",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 1290,
        "y": 2340,
        "wires": []
    },
    {
        "id": "2f1fab9a.fbb754",
        "type": "telegram command",
        "z": "93cb4937.6fc068",
        "name": "/mylang",
        "command": "/mylang",
        "bot": "f93d1a38.c43218",
        "x": 100,
        "y": 2220,
        "wires": [
            [
                "c9679475.577988"
            ],
            []
        ]
    },
    {
        "id": "d7dd880.07c5d78",
        "type": "inject",
        "z": "93cb4937.6fc068",
        "name": "reset",
        "topic": "",
        "payload": "{\"counter\":true}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 430,
        "y": 2280,
        "wires": [
            [
                "c9679475.577988",
                "5983db7f.7b6614",
                "eee020eb.36a75"
            ]
        ]
    },
    {
        "id": "c9679475.577988",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "counter",
        "func": "var c = context.get('counter') || false;\n\nvar update = function (c) {\n    node.status({fill:\"green\",shape:\"dot\",text:c});\n}\n\nif (msg.payload.counter) {\n    c = 0;\n    context.set('counter', c);\n    update(c);\n} else {\n    c += 1;\n    context.set('counter', c);\n    update(c);\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 520,
        "y": 2220,
        "wires": [
            [
                "71ddbc3a.d5e9a4"
            ]
        ]
    },
    {
        "id": "eee020eb.36a75",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "counter",
        "func": "var c = context.get('counter') || false;\n\nvar update = function (c) {\n    node.status({fill:\"green\",shape:\"dot\",text:c});\n}\n\nif (msg.payload.counter) {\n    c = 0;\n    context.set('counter', c);\n    update(c);\n} else {\n    c += 1;\n    context.set('counter', c);\n    update(c);\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1240,
        "y": 2240,
        "wires": [
            [
                "20f4d6ba.631d1a"
            ]
        ]
    },
    {
        "id": "5983db7f.7b6614",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "counter",
        "func": "var c = context.get('counter2') || false;\n\nvar update = function (c) {\n    node.status({fill:\"green\",shape:\"dot\",text:c});\n}\n\nif (msg.payload.counter) {\n    c = 0;\n    context.set('counter2', c);\n    update(c);\n} else {\n    c += 1;\n    context.set('counter2', c);\n    update(c);\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 920,
        "y": 2240,
        "wires": [
            [
                "2d3ed690.563dfa"
            ]
        ]
    },
    {
        "id": "2c203b85.157434",
        "type": "subflow:c6a40c11.dfc6b",
        "z": "93cb4937.6fc068",
        "name": "",
        "x": 1090,
        "y": 580,
        "wires": []
    },
    {
        "id": "b052941e.4306e8",
        "type": "function",
        "z": "93cb4937.6fc068",
        "name": "counter",
        "func": "var c = context.get('counter') || false;\n\nvar update = function (c) {\n    node.status({fill:\"green\",shape:\"dot\",text:c});\n}\n\nif (msg.payload.counter) {\n    c = 0;\n    context.set('counter', c);\n    update(c);\n} else {\n    c += 1;\n    context.set('counter', c);\n    update(c);\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1180,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "ee894a30.ecb7c8",
        "type": "inject",
        "z": "93cb4937.6fc068",
        "name": "reset",
        "topic": "",
        "payload": "{\"counter\":true}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 1090,
        "y": 380,
        "wires": [
            [
                "b052941e.4306e8"
            ]
        ]
    },
    {
        "id": "f099bf63.3e489",
        "type": "debug",
        "z": "e81a68fa.695e38",
        "name": "send!",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 650,
        "y": 100,
        "wires": []
    },
    {
        "id": "bd4fe03a.9cbf5",
        "type": "debug",
        "z": "93cb4937.6fc068",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 270,
        "y": 2320,
        "wires": []
    },
    {
        "id": "90cc5a97.f73e08",
        "type": "delay",
        "z": "93cb4937.6fc068",
        "name": "d 300ms",
        "pauseType": "delay",
        "timeout": "300",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 920,
        "y": 560,
        "wires": [
            [
                "2c203b85.157434"
            ]
        ]
    },
    {
        "id": "48219ca2.511564",
        "type": "function",
        "z": "c1e7ebde.3e0b68",
        "name": "timeout getting fires",
        "func": "    var email = {};\n    email.topic = \"Bloqueo en el procesamiento de fuegos\";\n    email.payload = \"Pues eso...\";\n    return email;",
        "outputs": 1,
        "noerr": 0,
        "x": 480,
        "y": 520,
        "wires": [
            [
                "fe0b3515.374378",
                "f3054b89.b5eac8",
                "1b05feb.f6de801"
            ]
        ]
    },
    {
        "id": "fe0b3515.374378",
        "type": "semaphore-leave",
        "z": "c1e7ebde.3e0b68",
        "config": "ce56e26a.71d74",
        "name": "notif leave on error",
        "x": 770,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "f3054b89.b5eac8",
        "type": "debug",
        "z": "c1e7ebde.3e0b68",
        "name": "released semaphore",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 780,
        "y": 540,
        "wires": []
    },
    {
        "id": "1b05feb.f6de801",
        "type": "e-mail",
        "z": "c1e7ebde.3e0b68",
        "server": "selver.comunes.org",
        "port": "587",
        "secure": false,
        "name": "vjrj@ourproject.org",
        "dname": "no-reply to vjrj",
        "x": 760,
        "y": 580,
        "wires": []
    },
    {
        "id": "ff4373ed.81f01",
        "type": "catch",
        "z": "c1e7ebde.3e0b68",
        "name": "catch fire active processing",
        "scope": [
            "cba6a942.ef2ee8"
        ],
        "x": 180,
        "y": 520,
        "wires": [
            [
                "48219ca2.511564"
            ]
        ]
    },
    {
        "id": "560ecd7f.581254",
        "type": "tcp in",
        "z": "c1e7ebde.3e0b68",
        "name": "modis-listen",
        "server": "server",
        "host": "",
        "port": "40001",
        "datamode": "single",
        "datatype": "utf8",
        "newline": "",
        "topic": "",
        "base64": false,
        "x": 130,
        "y": 260,
        "wires": [
            [
                "2c0b967b.4cae8a"
            ]
        ]
    },
    {
        "id": "a23a968c.a040b8",
        "type": "tcp in",
        "z": "c1e7ebde.3e0b68",
        "name": "viirs-listen",
        "server": "server",
        "host": "",
        "port": "40002",
        "datamode": "single",
        "datatype": "utf8",
        "newline": "",
        "topic": "modis-viirs",
        "base64": false,
        "x": 120,
        "y": 300,
        "wires": [
            [
                "b8eec86.79ece38"
            ]
        ]
    },
    {
        "id": "b8eec86.79ece38",
        "type": "function",
        "z": "c1e7ebde.3e0b68",
        "name": "viirs file",
        "func": "var file = {};\nfile.filename = global.get('ftp-path') + \"viir.txt\";\nfile.type = \"viirs\";\nreturn file;",
        "outputs": 1,
        "noerr": 0,
        "x": 280,
        "y": 300,
        "wires": [
            [
                "46a349eb.45da68",
                "623c7b24.8d0e84"
            ]
        ]
    },
    {
        "id": "2c0b967b.4cae8a",
        "type": "function",
        "z": "c1e7ebde.3e0b68",
        "name": "modis file",
        "func": "var file = {};\nfile.filename = global.get('ftp-path') + \"modis.txt\";\nfile.type = \"modis\";\nreturn file;",
        "outputs": 1,
        "noerr": 0,
        "x": 280,
        "y": 260,
        "wires": [
            [
                "2005640b.f800bc",
                "46a349eb.45da68"
            ]
        ]
    },
    {
        "id": "2005640b.f800bc",
        "type": "file in",
        "z": "c1e7ebde.3e0b68",
        "name": "read",
        "filename": "",
        "format": "utf8",
        "chunk": false,
        "sendError": true,
        "x": 450,
        "y": 260,
        "wires": [
            [
                "cb6427c6.0c2058",
                "4c9d7d67.9de2f4"
            ]
        ]
    },
    {
        "id": "623c7b24.8d0e84",
        "type": "file in",
        "z": "c1e7ebde.3e0b68",
        "name": "read",
        "filename": "",
        "format": "utf8",
        "chunk": false,
        "sendError": true,
        "x": 450,
        "y": 300,
        "wires": [
            [
                "33d38060.1d916",
                "6602919e.f6455"
            ]
        ]
    },
    {
        "id": "46a349eb.45da68",
        "type": "debug",
        "z": "c1e7ebde.3e0b68",
        "name": "filename",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 460,
        "y": 340,
        "wires": []
    },
    {
        "id": "33d38060.1d916",
        "type": "csv",
        "z": "c1e7ebde.3e0b68",
        "name": "modis array",
        "sep": ",",
        "hdrin": true,
        "hdrout": "",
        "multi": "mult",
        "ret": "\\n",
        "temp": "",
        "x": 650,
        "y": 340,
        "wires": [
            [
                "ab66e9e6.ee9c48"
            ]
        ]
    },
    {
        "id": "cb6427c6.0c2058",
        "type": "csv",
        "z": "c1e7ebde.3e0b68",
        "name": "viirs array",
        "sep": ",",
        "hdrin": true,
        "hdrout": "",
        "multi": "mult",
        "ret": "\\n",
        "temp": "",
        "x": 650,
        "y": 300,
        "wires": [
            [
                "ab66e9e6.ee9c48"
            ]
        ]
    },
    {
        "id": "6602919e.f6455",
        "type": "csv",
        "z": "c1e7ebde.3e0b68",
        "name": "modis csv",
        "sep": ",",
        "hdrin": true,
        "hdrout": "",
        "multi": "one",
        "ret": "\\n",
        "temp": "",
        "x": 650,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "4c9d7d67.9de2f4",
        "type": "csv",
        "z": "c1e7ebde.3e0b68",
        "name": "viir csv",
        "sep": ",",
        "hdrin": true,
        "hdrout": "",
        "multi": "one",
        "ret": "\\n",
        "temp": "",
        "x": 640,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "b6b485e5.1a3ed8",
        "type": "subflow:4a3c7cc0.965dd4",
        "z": "c1e7ebde.3e0b68",
        "name": "",
        "x": 860,
        "y": 120,
        "wires": []
    },
    {
        "id": "a5303299.fefc",
        "type": "inject",
        "z": "c1e7ebde.3e0b68",
        "name": "onInit",
        "topic": "",
        "payload": "",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 390,
        "y": 80,
        "wires": [
            [
                "deb9b82d.5d8028"
            ]
        ]
    },
    {
        "id": "70007906.14a698",
        "type": "subflow:91777bb3.922328",
        "z": "c1e7ebde.3e0b68",
        "x": 380,
        "y": 120,
        "wires": [
            [
                "5c43e91c.3921a8"
            ]
        ]
    },
    {
        "id": "5c43e91c.3921a8",
        "type": "delay",
        "z": "c1e7ebde.3e0b68",
        "name": "d 3s",
        "pauseType": "delay",
        "timeout": "3",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 540,
        "y": 120,
        "wires": [
            [
                "deb9b82d.5d8028"
            ]
        ]
    },
    {
        "id": "deb9b82d.5d8028",
        "type": "function",
        "z": "c1e7ebde.3e0b68",
        "name": "conf map",
        "func": "/* Only for tests */\nvar cfg = {};\ncfg.payload = {};\ncfg.payload.command = {\n    cluster:0,\n    layer:\"OSM grey\",\n    lat:40.4,\n    lon:-3.6833333,\n    zoom:6,\n};   \nreturn [cfg];",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 120,
        "wires": [
            [
                "b6b485e5.1a3ed8"
            ]
        ]
    },
    {
        "id": "7bed2216.606b1c",
        "type": "semaphore-take",
        "z": "c1e7ebde.3e0b68",
        "config": "ce56e26a.71d74",
        "name": "nofit take",
        "x": 1000,
        "y": 300,
        "wires": [
            [
                "cba6a942.ef2ee8"
            ]
        ]
    },
    {
        "id": "ab66e9e6.ee9c48",
        "type": "function",
        "z": "c1e7ebde.3e0b68",
        "name": "isArray",
        "func": "if (Array.isArray(msg.payload)) {\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 840,
        "y": 300,
        "wires": [
            [
                "840c7f68.e29b2",
                "de8cfdcc.f432c",
                "7bed2216.606b1c"
            ]
        ]
    },
    {
        "id": "cba6a942.ef2ee8",
        "type": "subflow:11cb3f4d.6e0081",
        "z": "c1e7ebde.3e0b68",
        "name": "",
        "x": 1200,
        "y": 300,
        "wires": [
            [
                "fa0acd4d.e342e"
            ],
            [
                "94d3538b.7c29e",
                "c19f9fb2.881cd"
            ]
        ]
    },
    {
        "id": "840c7f68.e29b2",
        "type": "subflow:3f0768a7.1fac78",
        "z": "c1e7ebde.3e0b68",
        "name": "",
        "x": 1110,
        "y": 340,
        "wires": []
    },
    {
        "id": "de8cfdcc.f432c",
        "type": "debug",
        "z": "c1e7ebde.3e0b68",
        "name": "count active fires",
        "active": true,
        "console": "false",
        "complete": "payload.length",
        "x": 1110,
        "y": 380,
        "wires": []
    },
    {
        "id": "c19f9fb2.881cd",
        "type": "debug",
        "z": "c1e7ebde.3e0b68",
        "name": "count NEW active fires",
        "active": true,
        "console": "false",
        "complete": "payload.length",
        "x": 1470,
        "y": 380,
        "wires": []
    },
    {
        "id": "94d3538b.7c29e",
        "type": "subflow:c8522537.c6f908",
        "z": "c1e7ebde.3e0b68",
        "name": "",
        "x": 1460,
        "y": 340,
        "wires": []
    },
    {
        "id": "fa0acd4d.e342e",
        "type": "semaphore-leave",
        "z": "c1e7ebde.3e0b68",
        "config": "ce56e26a.71d74",
        "name": "notif leave",
        "x": 1420,
        "y": 300,
        "wires": [
            [
                "51e12e27.c4964",
                "5dc2de12.0ddf3"
            ]
        ]
    },
    {
        "id": "51e12e27.c4964",
        "type": "split",
        "z": "c1e7ebde.3e0b68",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 1590,
        "y": 300,
        "wires": [
            [
                "5c054d9b.8452f4"
            ]
        ]
    },
    {
        "id": "5c054d9b.8452f4",
        "type": "function",
        "z": "c1e7ebde.3e0b68",
        "name": "set lat/lon",
        "func": "msg.lon = msg.payload._id.coordinates[0];\nmsg.lat = msg.payload._id.coordinates[1];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1740,
        "y": 300,
        "wires": [
            [
                "8795dd0e.a135a"
            ]
        ]
    },
    {
        "id": "8795dd0e.a135a",
        "type": "delay",
        "z": "c1e7ebde.3e0b68",
        "name": "1000msg/5seg",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "minutes",
        "rate": "1000",
        "nbRateUnits": "5",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 1920,
        "y": 300,
        "wires": [
            [
                "7a5495a3.d75efc"
            ]
        ]
    },
    {
        "id": "7a5495a3.d75efc",
        "type": "subflow:2b8628df.fdcca8",
        "z": "c1e7ebde.3e0b68",
        "name": "",
        "x": 2130,
        "y": 300,
        "wires": []
    },
    {
        "id": "882e4fb1.24e3a",
        "type": "inject",
        "z": "128790f6.dee0df",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 120,
        "y": 120,
        "wires": [
            [
                "b6f75a8a.36fb18"
            ]
        ]
    },
    {
        "id": "b6f75a8a.36fb18",
        "type": "function",
        "z": "128790f6.dee0df",
        "name": "empty news - go /start",
        "func": "var news = {};\nnews.payload = {};\nnews.payload.content  = \"empty\";\n// this is me, for preview:\nnews.payload.chatId = 4885772;\nreturn news;",
        "outputs": 1,
        "noerr": 0,
        "x": 460,
        "y": 120,
        "wires": [
            [
                "4675b760.d24348"
            ]
        ]
    },
    {
        "id": "10ab7dc2.5c82a2",
        "type": "catch",
        "z": "c1e7ebde.3e0b68",
        "name": "catch all",
        "scope": null,
        "x": 120,
        "y": 680,
        "wires": [
            [
                "1a8f241d.48463c"
            ]
        ]
    },
    {
        "id": "1a8f241d.48463c",
        "type": "debug",
        "z": "c1e7ebde.3e0b68",
        "name": "catch error ----------------------",
        "active": true,
        "console": "true",
        "complete": "true",
        "x": 350,
        "y": 680,
        "wires": []
    },
    {
        "id": "20b15f93.74ebe",
        "type": "function",
        "z": "c1e7ebde.3e0b68",
        "name": "find active fires",
        "func": "var types = ['modis', 'viirs'];\nfor (var i = 0; i < types.length; i++) {\n    var type = types[i];\n    var collection = \"activefires\" + type; \n    var actfires = {};\n    actfires.type = type;\n    actfires.collection = collection;\n    // http://mongodb.github.io/node-mongodb-native/2.1/api/Collection.html#find\n    actfires.payload = [{ }];\n    node.send(actfires);\n}",
        "outputs": "1",
        "noerr": 0,
        "x": 1240,
        "y": 240,
        "wires": [
            [
                "9b75b54f.f01b58"
            ]
        ]
    },
    {
        "id": "9b75b54f.f01b58",
        "type": "mongodb2 in",
        "z": "c1e7ebde.3e0b68",
        "service": "_ext_",
        "configNode": "d5559ee5.960e2",
        "name": "find",
        "collection": "",
        "operation": "find.toArray",
        "x": 1410,
        "y": 240,
        "wires": [
            [
                "5dc2de12.0ddf3"
            ]
        ]
    },
    {
        "id": "5dc2de12.0ddf3",
        "type": "split",
        "z": "c1e7ebde.3e0b68",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 1590,
        "y": 240,
        "wires": [
            [
                "fad78f11.31968"
            ]
        ]
    },
    {
        "id": "fad78f11.31968",
        "type": "function",
        "z": "c1e7ebde.3e0b68",
        "name": "set lat/lon",
        "func": "msg.payload.longitude = msg.payload._id.coordinates[0];\nmsg.payload.latitude = msg.payload._id.coordinates[1];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1740,
        "y": 240,
        "wires": [
            [
                "24b2391f.e79716"
            ]
        ]
    },
    {
        "id": "24b2391f.e79716",
        "type": "function",
        "z": "c1e7ebde.3e0b68",
        "name": "nasa-map",
        "func": "// https://earthdata.nasa.gov/what-is-new-collection-6-modis-active-fire-data\nif (msg.payload && msg.payload.longitude && msg.payload.latitude) {\n    var lat = msg.payload.latitude;\n    var lon = msg.payload.longitude;\n    var pname = \"Fuego activo seg√∫n NASA: \" + lat + \", \" + lon;\n    pname += \", satelite: \" + msg.payload.satellite;\n    var maxkevin = 373;\n    var intensity =\n        (msg.payload.bright_ti4? msg.payload.bright_ti4: \n        (msg.payload.brightness? msg.payload.brightness: maxkevin)) / maxkevin;\n    var radius = msg.payload.scan * 1000;\n    \n    var newMsg = {\n        payload: {\n            name: pname,\n            lat: lat,\n            lon: lon,\n            layer: \"NASA\",\n            // icon: \"earthquake\",\n            color: \"red\",\n            fillColor: \"red\",\n            // intensity: intensity,\n            // weight: intensity,\n            radius: radius,\n            fillOpacity: 1,\n            iconColor:'red', // obligatorio\n            stroke: false,\n            addtoheatmap: false,\n            // fillOpacity: 0.8,\n            clickable: true,\n            weblink: {url: \"http://example.com\", name: \"M√°s info\"}\n            \n            // photoUrl: \"http://loremflickr.com/320/240/wildfire\"\n        }\n    };\n    \n    return newMsg;\n    \n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1920,
        "y": 240,
        "wires": [
            [
                "f5971d3b.95126"
            ]
        ]
    },
    {
        "id": "f5971d3b.95126",
        "type": "subflow:4a3c7cc0.965dd4",
        "z": "c1e7ebde.3e0b68",
        "name": "",
        "x": 2160,
        "y": 240,
        "wires": []
    },
    {
        "id": "89ff7ceb.6b95a",
        "type": "subflow:91777bb3.922328",
        "z": "c1e7ebde.3e0b68",
        "x": 1030,
        "y": 240,
        "wires": [
            [
                "20b15f93.74ebe"
            ]
        ]
    },
    {
        "id": "146e7741.7a26a9",
        "type": "inject",
        "z": "c1e7ebde.3e0b68",
        "name": "update map",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 830,
        "y": 240,
        "wires": [
            [
                "89ff7ceb.6b95a"
            ]
        ]
    }
]